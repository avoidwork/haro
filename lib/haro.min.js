/* 2015 Jason Mulligan <jason.mulligan@avoidwork.com> */

"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(a){function b(a){return JSON.parse(JSON.stringify(a))}function c(a,b){return a.replace(v.querystring,"").replace(v.endslash,"")+(b?"/"+b:"")}function d(){var a=void 0,b=void 0,c=void 0;return a=new p(function(a,d){b=a,c=d}),{resolve:b,reject:c,promise:a}}function e(a,b,c){var d=a.split(c).sort(),e=void 0;return e=d.length>1?d.map(function(a){return String(b[a]).replace(/\.|-|\s*|\t*/g,"").toLowerCase()}).join(c):b[a]}function f(a,b,c,d,f){a.forEach(function(a){var g=b.get(a),h=e(a,f,c),i=void 0;g.has(h)&&(i=g.get(h),i["delete"](d),0===i.size&&g["delete"](h))})}function g(a,b){a instanceof Object?Object.keys(a).forEach(function(c){b.call(a,a[c],c)}):a.forEach(b)}function h(a,c){var d=b(a),e=b(c);return d instanceof Object&&e instanceof Object?Object.keys(e).forEach(function(a){d[a]instanceof Object&&e[a]instanceof Object?d[a]=h(d[a],e[a]):d[a]instanceof Array&&e[a]instanceof Array?d[a]=d[a].concat(e[a]):d[a]=e[a]}):d=d instanceof Array&&e instanceof Array?d.concat(e):e,d}function i(){var a=void 0===arguments[0]?{}:arguments[0],b=void 0===arguments[1]?{}:arguments[1],c=void 0===arguments[2]?"":arguments[2],d=void 0===arguments[3]?!1:arguments[3],e=[];return d&&g(a,function(a,d){d!==c&&void 0===b[d]&&e.push({op:"remove",path:"/"+d})}),g(b,function(b,d){d!==c&&void 0===a[d]?e.push({op:"add",path:"/"+d,value:b}):JSON.stringify(a[d])!==JSON.stringify(b)&&e.push({op:"replace",path:"/"+d,value:b})}),e}function j(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function k(a,b,c){a.has(b)||a.set(b,new r),a.get(b).add(c)}function l(a,b,c,d,f,g){g?k(b.get(g),e(g,f,c),d):a.forEach(function(a){k(b.get(a),e(a,f,c),d)})}function m(a){var b={};return a.forEach(function(a,c){b[c]=a}),b}function n(){return j()+j()+"-"+j()+"-4"+j().substr(0,3)+"-"+u[Math.floor(4*Math.random())]+j().substr(0,3)+"-"+j()+j()+j()}function o(){var a=void 0===arguments[0]?null:arguments[0],b=void 0===arguments[1]?{}:arguments[1],c=void 0===arguments[2]?[]:arguments[2];return new Haro(a,b,c)}var p=a.Promise||require("es6-promise").Promise,q=a.Map||require("es6-map"),r=a.Set||require("es6-set"),s=a.fetch||require("node-fetch"),t=a.tuple||require("tiny-tuple"),u=[8,9,"a","b"],v={querystring:/\?.*/,endslash:/\/$/},w={},Haro=function(){function Haro(a){var b=this,c=void 0===arguments[1]?{}:arguments[1];_classCallCheck(this,Haro),this.adapters={},this.data=new q,this.delimiter="|",this.config={method:"get",credentials:!1,headers:{accept:"application/json","content-type":"application/json"}},this.id=n(),this.index=[],this.indexes=new q,this.key="",this.logging=!0,this.patch=!1,this.registry=[],this.source="",this.total=0,this.uri="",this.versions=new q,this.versioning=!0,Object.keys(c).forEach(function(a){b[a]=h(b[a],c[a])}),this.reindex(),a&&this.batch(a,"set")}return _createClass(Haro,[{key:"batch",value:function(a,b){function e(){p.all(a.map(k)).then(function(a){g.resolve(a)},function(a){g.reject(a)})}var f=this,g=d(),h="del"===b,j=void 0,k=void 0,l=void 0;return k=h?function(a){return f.del(a,!0)}:function(a){return f.set(null,a,!0,!0)},this.patch?(h?j=i(this.toArray().map(function(a){return a[f.key]}),a,this.key,!0):(j=[],l={},a.forEach(function(a){var b=a[f.key];b?l[b]=a:j.push({op:"add",path:"/",value:a})}),j=j.concat(i(this.toObject(),l,this.key,!0))),j.length>0?this.request(c(this.uri,null),{method:"patch",body:JSON.stringify(j)}).then(function(){e()},function(a){g.reject(a)}):g.resolve()):e(),g.promise}},{key:"clear",value:function(){return this.total=0,this.registry=[],this.data.clear(),this.indexes.clear(),this.versions.clear(),this.logging&&console.log("Cleared",this.id),this.reindex()}},{key:"cmd",value:function(a){var b=d();if(this.adapters[a]&&w[a]){for(var c=arguments.length,e=Array(c>1?c-1:0),f=1;c>f;f++)e[f-1]=arguments[f];w[a].apply(this,[this].concat(e)).then(function(a){b.resolve(a)},function(a){b.reject(a)})}else b.reject(new Error(a+" not configured for persistent storage"));return b.promise}},{key:"del",value:function(a){var b=this,e=void 0===arguments[1]?!1:arguments[1],g=d(),h=void 0;return h=function(){var c=b.registry.indexOf(a);c>-1&&(0===c?b.registry.shift():c===b.registry.length-1?b.registry.pop():b.registry.splice(c,1),f(b.index,b.indexes,b.delimiter,a,b.data.get(a)),b.data["delete"](a),--b.total,b.versioning&&b.versions["delete"](a),b.storage("remove",a).then(function(c){c&&b.logging&&console.log("Deleted",a,"from persistent storage")},function(c){b.logging&&console.error("Error deleting",a,"from persistent storage:",c.message||c.stack||c)})),g.resolve()},this.data.has(a)?!e&&this.uri?this.patch?this.request(c(this.uri,null),{method:"patch",body:JSON.stringify([{op:"remove",path:"/"+a}])}).then(h,function(d){405===d[1]?(b.patch=!1,b.request(c(b.uri,a),{method:"delete"}).then(h,function(a){g.reject(a)})):g.reject(d)}):this.request(c(this.uri,a),{method:"delete"}).then(h,function(a){g.reject(a)}):h():g.reject(new Error("Record not found")),g.promise}},{key:"entries",value:function(){return this.data.entries()}},{key:"find",value:function(a){var b=this,c=Object.keys(a).sort().join(this.delimiter),d=e(c,a,this.delimiter),f=[];return this.indexes.has(c)&&(this.indexes.get(c).get(d)||new r).forEach(function(a){f.push(b.get(a))}),t.apply(t,f)}},{key:"filter",value:function(a){var b=[];return this.forEach(function(c,d){a(c,d)===!0&&b.push(t(d,c))}),t.apply(t,b)}},{key:"forEach",value:function(a,c){return this.data.forEach(function(c,d){a(b(c),b(d))},c),this}},{key:"get",value:function(a){var b=void 0;return this.data.has(a)&&(b=t(a,this.data.get(a))),b}},{key:"has",value:function(a){return this.data.has(a)}},{key:"keys",value:function(){return this.data.keys()}},{key:"limit",value:function(a){var b=void 0===arguments[1]?0:arguments[1],c=a,d=b,e=[],f=void 0,g=void 0,h=void 0;if(void 0===c&&(c=-1),f=d,h=d+c,0>f||f>=h)throw new Error("Invalid range");do g=this.registry[f],g&&e.push(this.get(g));while(++f<h);return t.apply(t,e)}},{key:"load",value:function(a,b){var c=this;void 0===a&&(a="mongo");var d=void 0===b,e=d?this.id:b;return d&&this.clear(),this.cmd(a,"get",b).then(function(f){return c.logging&&console.log("Loaded",e,"from",a,"persistent storage"),d?c.batch(f,"set"):c.set(b,f)},function(b){throw c.logging&&console.error("Error loading",e,"from",a,"persistent storage:",b.message||b.stack||b),b})}},{key:"map",value:function(a){var b=[];return this.forEach(function(c,d){b.push(a(c,d))}),t.apply(t,b)}},{key:"register",value:function(a,b){w[a]=b}},{key:"reindex",value:function(a){var b=this;return a?(this.indexes.set(a,new q),this.forEach(function(c,d){l(b.index,b.indexes,b.delimiter,d,c,a)})):(this.indexes.clear(),this.index.forEach(function(a){b.indexes.set(a,new q)}),this.forEach(function(a,c){b.index.forEach(function(d){l(b.index,b.indexes,b.delimiter,c,a,d)})})),this}},{key:"request",value:function(a){var b=void 0===arguments[1]?{}:arguments[1],c=d(),e=h(this.config,b);return e.method=e.method.toUpperCase(),s(a,e).then(function(a){var b=a.status,d=void 0;a.headers._headers?(d={},Object.keys(a.headers._headers).forEach(function(b){d[b]=a.headers._headers[b].join(", ")})):d=m(a.headers),a[a.headers.get("content-type").indexOf("application/json")>-1?"json":"text"]().then(function(a){c[200>b||b>=400?"reject":"resolve"](t(a,b,d))},function(a){c.reject(t(a.message,b,d))})},function(a){c.reject(t(a.message,0,{}))}),c.promise}},{key:"save",value:function(){var a=this,b=void 0===arguments[0]?"mongo":arguments[0];return this.cmd(b,"set").then(function(c){return a.logging&&console.log("Saved",a.id,"to",b,"persistent storage"),c},function(c){throw a.logging&&console.error("Error saving ",a.id,"to",b,"persistent storage:",c.message||c.stack||c),c})}},{key:"search",value:function(a,b){var c=this,d=b?this.index.indexOf(b)>-1?[b]:[]:this.index,e=[],f="function"==typeof a,g="function"==typeof a.test,h=new r;return a&&d.forEach(function(b){var d=c.indexes.get(b);d&&d.forEach(function(b,d){switch(!0){case f&&a(d):case g&&a.test(d):case d===a:b.forEach(function(a){h.has(a)||(h.add(a),e.push(c.get(a)))})}})}),t.apply(t,e)}},{key:"set",value:function(a,e){var g=this,j=void 0===arguments[2]?!1:arguments[2],k=void 0===arguments[3]?!1:arguments[3],m=d(),o="post",p=b(e),q=a,s=void 0,u=void 0,v=function(a){var b=a?a[0]:{};null===q&&(g.key?(g.source&&g.source.split(".").forEach(function(a){b=b[a]||{}}),q=b[g.key]||p[g.key]||n()):q=n()),"post"===o?(g.registry[g.total]=q,++g.total,g.versioning&&g.versions.set(q,new r)):(g.versioning&&g.versions.get(q).add(t(u)),f(g.index,g.indexes,g.delimiter,q,u)),g.data.set(q,p),l(g.index,g.indexes,g.delimiter,q,p),m.resolve(g.get(q)),g.storage("set",q,p).then(function(a){a&&g.logging&&console.log("Saved",q,"to persistent storage")},function(a){g.logging&&console.error("Error saving",q,"to persistent storage:",a.message||a.stack||a)})};return void 0===q||null===q?q=null:this.data.has(q)&&(o="put",u=this.data.get(q),k||(p=h(u,p))),!j&&this.uri?this.patch?(s="post"===o?[{op:"add",path:"/",value:p}]:k?[{op:"replace",path:"/",value:p}]:i(u,p,this.key),this.request(c(this.uri,q),{method:"patch",body:JSON.stringify(s)}).then(v,function(a){405===a[1]?(g.patch=!1,g.request(c(g.uri,q),{method:o,body:JSON.stringify(p)}).then(v,function(a){m.reject(a)})):m.reject(a)})):this.request(c(this.uri,q),{method:o,body:JSON.stringify(p)}).then(v,function(a){m.reject(a)}):v(),m.promise}},{key:"setUri",value:function(a){var b=void 0===arguments[1]?!1:arguments[1],c=d();return this.uri=a,this.uri?this.sync(b).then(function(a){c.resolve(a)},function(a){c.reject(a)}):c.resolve([]),c.promise}},{key:"sort",value:function(a){return this.toArray().sort(a)}},{key:"sortBy",value:function(a){var b=this,c=[],d=[],e=void 0;return this.indexes.has(a)||(this.index.push(a),this.reindex(a)),e=this.indexes.get(a),e.forEach(function(a,b){d.push(b)}),d.sort().forEach(function(a){e.get(a).forEach(function(a){c.push(b.get(a))})}),t.apply(t,c)}},{key:"storage",value:function(){for(var a=this,b=arguments.length,c=Array(b),e=0;b>e;e++)c[e]=arguments[e];var f=d(),g=[];return Object.keys(this.adapters).forEach(function(b){g.push(a.cmd.apply(a,[b].concat(c)))}),g.length>0?p.all(g).then(function(){f.resolve(!0)},function(a){f.reject(a)}):f.resolve(!1),f.promise}},{key:"sync",value:function(){var a=this,b=void 0===arguments[0]?!1:arguments[0],c=d();return this.request(this.uri).then(function(d){var e=d[0];if(a.patch=(d[2].Allow||d[2].allow||"").indexOf("PATCH")>-1,a.source)try{a.source.split(".").forEach(function(a){e=e[a]})}catch(f){return c.reject(f)}b&&a.clear(),a.batch(e,"set").then(function(a){c.resolve(a)},function(a){c.reject(a)})},function(a){c.reject(a[0]||a)}),c.promise}},{key:"toArray",value:function(a){var c=void 0===arguments[1]?!0:arguments[1],d=void 0,e=void 0;return d=c?function(a){return a}:function(a){return b(a)},a?e=a.reduce(function(a,b){return a.push(d(b[1])),a},[]):(e=[],this.forEach(function(a){e.push(d(a))})),e}},{key:"toObject",value:function(a){var c=void 0===arguments[1]?!0:arguments[1],d=void 0;return(d=c?function(a){return a}:function(a){return b(a)})(a?a.reduce(function(a,b){return a[b[0]]=b[1],a},{}):m(this))}},{key:"unload",value:function(a,b){var c=this;void 0===a&&(a="mongo");var d=void 0!==b?b:this.id;return this.cmd(a,"remove",b).then(function(b){return c.logging&&console.log("Unloaded",d,"from",a,"persistent storage"),b},function(b){throw c.logging&&console.error("Error unloading",d,"from",a,"persistent storage:",b.message||b.stack||b),b})}},{key:"unregister",value:function(a){delete w[a]}},{key:"values",value:function(){return this.data.values()}}]),Haro}();o.version="1.4.10","undefined"!=typeof exports?module.exports=o:"function"==typeof define?define(function(){return o}):a.haro=o}("undefined"!=typeof global?global:window);
//# sourceMappingURL=haro.min.js.map