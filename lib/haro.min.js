/**
 * Har≈ç is a modern immutable DataStore
 *
 * @author Jason Mulligan <jason.mulligan@avoidwork.com>
 * @copyright 2019
 * @license BSD-3-Clause
 * @version 4.7.0
 */"use strict";(function(a){function b(c,a){return a in c}function d(a,b){for(const c of a.entries())b(c[1],c[0]);return a}function e(a){let b;switch(!0){case a instanceof w:b={},a.forEach((a,c)=>{b[c]=e(a)});break;case a instanceof y:b=Array.from(a);break;case Array.isArray(a):b=new y(a);break;case a instanceof Object:b=new w(Object.keys(a).map(b=>[b,e(a[b])]));break;default:b=a;}return b}function f(a){return new A([a],{type:"application/javascript"})}function g(a){return JSON.parse(JSON.stringify(a,null,0))}function h(a,b){return a.replace(r.querystring,"").replace(r.endslash,"")+(b?"/"+b:"")}function j(a,b,c,d){let e;return e=a.includes(c)?a.split(c).sort((c,a)=>c.localeCompare(a)).map(a=>(void 0===b[a]?"":b[a]).toString().replace(new RegExp(d,"g"),"").toLowerCase()).join(c):b[a],e}function k(a,b,c,d,e,f){a.forEach(a=>{const g=b.get(a),h=j(a,e,c,f);if(g.has(h)){const a=g.get(h);a.delete(d),0===a.size&&g.delete(h)}})}function l(a,c,e,f,g){const h={};return d(c,a=>{h[a]={}}),d(a,a=>{const d=a[e];void 0!==d&&c.forEach(c=>{const e=j(c,a,f,g);b(h[c],e)||(h[c][e]=[]),h[c][e].push(d)})}),h}function m(a,b){a instanceof Object?d(Object.keys(a),c=>b.call(a,a[c],c)):d(a,b)}function n(c,e){return c instanceof Object&&e instanceof Object?d(Object.keys(e),a=>{c[a]=c[a]instanceof Object&&e[a]instanceof Object?n(c[a],e[a]):Array.isArray(c[a])&&Array.isArray(e[a])?c[a].concat(e[a]):e[a]}):Array.isArray(c)&&Array.isArray(e)?c=c.concat(e):c=e,c}function o(c,e,a,b,f,h="inner"){function i(a,e,g,h=!1,i=!1){const n=Object.keys(e[0]),o=i?(a,c)=>a[b]===c[f]:(a,c)=>a[f]===c[b];d(a,a=>{const b={},i=e.filter(b=>o(b,a));let c=!0;return 1<i.length?(l=!0,k+=a[f],c=!1):1===i.length?d([a,i[0]],(a,c)=>m(a,(a,d)=>{b[g[c]+"_"+d]=a})):h&&(m(a,(a,c)=>{b[g[0]+"_"+c]=a}),d(n,a=>{b[g[1]+"_"+a]=null})),c&&0<Object.keys(b).length&&j.push(b),c},!0)}const j=[];let k="More than one record found on ",l=!1;return"inner"===h&&i(e,a,c),"left"===h&&i(e,a,c,!0),"right"===h&&i(a,e,g(c).reverse(),!0,!0),l?k:j}function p(a={},b={},c="",d=!1){const e=[];return d&&m(a,(a,d)=>{d!==c&&void 0===b[d]&&e.push({op:"remove",path:"/"+d})}),m(b,(b,d)=>{d!==c&&void 0===a[d]?e.push({op:"add",path:"/"+d,value:b}):JSON.stringify(a[d])!==JSON.stringify(b)&&e.push({op:"replace",path:"/"+d,value:b})}),e}function q(){return(0|65536*(Math.random()+1)).toString(16).substring(1)}function c(a,b,c,e,f,g,h){d(g?[g]:a,a=>{const g=b.get(a);if(Array.isArray(f[a])&&!a.includes(c))d(f[a],a=>{g.has(a)||g.set(a,new y),g.get(a).add(e)});else{const b=j(a,f,c,h);void 0!==b&&null!==b&&(!g.has(b)&&g.set(b,new y),g.get(b).add(e))}})}function i(a,b=!0){const c={};return a.forEach((a,d)=>{const e=a;b&&Object.freeze(e),c[g(d)]=e}),b&&Object.freeze(c),c}function s(){return q()+q()+"-"+q()+"-4"+q().substr(0,3)+"-"+C[Math.floor(4*Math.random())]+q().substr(0,3)+"-"+q()+q()+q()}function t(b=null,c={}){const d=new G(c);return x&&(d.worker=!1===u?a.URL.createObjectURL(f(F)):new Function(F)),Array.isArray(b)&&d.batch(b,"set"),d}const u="undefined"!=typeof process&&"function"==typeof process.nextTick,v=a.Promise,w=a.Map,y=a.Set,z=a.fetch||(u?require("node-fetch"):void 0),A=a.Blob,B=a.Worker||(u?require("tiny-worker"):void 0),C=[8,9,"a","b"],r={querystring:/\?.*/,endslash:/\/$/,json:/^application\/json/},x="undefined"!=typeof B,D="Web Worker not supported",E={},F=[e.toString(),g.toString(),l.toString(),d.toString(),b.toString(),m.toString(),o.toString(),j.toString(),c.toString(),(!1===u?"":"self.")+"onmessage = "+function(a){const b=JSON.parse(a.data),c=b.cmd;let d;"index"===c&&(d=l(b.records,b.index,b.key,b.delimiter,b.pattern)),"join"===c&&(d=o(b.ids,b.records[0],b.records[1],b.key,b.on,b.type)),postMessage(JSON.stringify(d))}.toString()+";"].join("\n");class G{constructor({adapters:a={},config:b={},debounce:c=0,delimiter:d="|",id:e=s(),index:f=[],key:g="",logging:h=!0,patch:i=!1,pattern:j="\\s*|\\t*",source:k="",versioning:l=!1}={}){return this.adapters=a,this.data=new w,this.debounce=c,this.debounced=new w,this.delimiter=d,this.config={method:"get",credentials:"include",headers:{accept:"application/json","content-type":"application/json"}},this.id=e,this.index=f,this.indexes=new w,this.key=g,this.logging=h,this.patch=i,this.pattern=j,this.source=k,this.size=this.total=0,this.uri="",this.worker=null,this.versions=new w,this.versioning=l,Object.defineProperty(this,"registry",{enumerable:!0,get:()=>Array.from(this.data.keys())}),1<Object.keys(b).length&&(this.config=n(this.config,b)),this.reindex()}async batch(a,b="set",c=!1){let d;this.beforeBatch(a,b);try{const e="del"===b?a=>this.del(a,!0,c):a=>this.set(null,a,!0,!0,c);d=await v.all(a.map(e)),this.onbatch(b,d),this.log(`Batch successful on ${this.id}`)}catch(a){throw this.onerror("batch",a),this.log(`Batch failure on ${this.id}`),a}return d}beforeBatch(){}beforeClear(){}beforeDelete(){}beforeRequest(){}beforeSet(){}beforeSync(){}clear(){return this.beforeClear(),this.size=this.total=0,this.data.clear(),this.indexes.clear(),this.versions.clear(),this.reindex().onclear(),this.log(`Cleared ${this.id}`),this}async cmd(a,...b){if(void 0===this.adapters[a]||void 0===E[a])throw new Error(`${a} not configured for persistent storage`);return await E[a].apply(this,[this,...b])}crawl(a){let b=g(a);return d((this.source||"").split("."),a=>{b=b[a]}),b||a}del(a,b=!1,c=!1,d=!1){if(!1===this.has(a))throw new Error("Record not found");const e=this.get(a,!0);return this.exec(async()=>{this.beforeDelete(a,b,c,d),k(this.index,this.indexes,this.delimiter,a,e,this.pattern),this.data.delete(a),--this.total,this.size=this.total},async()=>{this.ondelete(a,b,d,c),this.versioning&&this.versions.delete(a),c||(this.storage("remove",a).then(b=>{b&&this.log(`Deleted ${a} from persistent storage`)},b=>this.log(`Error deleting ${a} from persistent storage: ${b.message||b.stack||b}`,"error")),!b&&!d&&this.uri&&(this.debounced.has(a)&&clearTimeout(this.debounced.get(a)),this.debounced.set(a,setTimeout(async()=>{this.debounced.delete(a);try{await this.transmit(a,null,e,!1,"delete")}catch(b){this.log(b.stack||b.message||b,"error");try{await this.set(a,e,!0,!0),this.log(`Reverted ${a}`)}catch(b){this.log(`Failed to revert ${a}`)}}},this.debounce))))},a=>{throw this.onerror("delete",a),a})}dump(a="records"){return"records"===a?this.toArray(null,!1):this.transform(this.indexes)}entries(){return this.data.entries()}async exec(a,b,c){let d;try{const c=await a();d=await b(c)}catch(a){c(a)}return d}find(a,b=!1){const c=Object.keys(a).sort((c,a)=>c.localeCompare(a)).join(this.delimiter),d=j(c,a,this.delimiter,this.pattern),e=[];return this.indexes.has(c)&&(this.indexes.get(c).get(d)||new y).forEach(a=>e.push(this.get(a,b))),b?e:this.list(...e)}filter(b,c=!1){const d=this.reduce((d,a,e,f)=>(b.call(f,a)&&d.push(this.get(e,c)),d),[]);return c?d:this.list(...d)}forEach(a,b){return this.data.forEach((b,c)=>a(g(b),g(c)),b||this.data),this}get(a,b=!1){const c=g(this.data.get(a)||null);return c&&!b?this.list(a,c):c}has(a,b){return(b||this.data).has(a)}async join(a,b,c="inner",d=[]){let e;if(!(0<a.total))e=[];else if(e=0<d.length?await this.offload([[this.id,a.id],this.find(d[0],!0),d[1]?a.find(d[1],!0):a.toArray(null,!0),this.key,b||this.key,c],"join"):await this.offload([[this.id,a.id],this.toArray(null,!0),a.toArray(null,!0),this.key,b||this.key,c],"join"),"string"==typeof arg)throw new Error(e);return e}keys(){return this.data.keys()}limit(a=0,b=0,c=!1){const d=this.registry.slice(a,a+b).map(a=>this.get(a,c));return c?d:this.list(...d)}list(...a){return Object.freeze(a.map(a=>Object.freeze(a)))}async load(a="mongo",b=void 0){const c=void 0===b,d=c?this.id:b;let e;c&&this.clear();try{const f=await this.cmd(a,"get",b);e=c?this.batch(f,"set",!0):this.set(b,f,!0,!0,!0),this.log(`Loaded ${d} from ${a} persistent storage`)}catch(b){throw this.log(`Error loading ${d} from ${a} persistent storage: ${b.message||b.stack||b}`,"error"),b}return e}log(a="",b="log"){this.logging&&console[b](`haro: ${a}`)}map(a,b=!1){const c=[];return this.forEach((b,d)=>c.push(a(b,d))),b?c:this.list(...c)}async offload(a,b="index",c=this.index){return new v((d,e)=>{if(this.worker){const f=this.useWorker(d,e);let g;"index"===b?g={cmd:b,index:c,records:a,key:this.key,delimiter:this.delimiter,pattern:this.pattern}:"join"===b&&(g={cmd:b,ids:a[0],records:[a[1],a[2]],key:a[3],on:a[4],type:a[5]}),f.postMessage(JSON.stringify(g,null,0))}else e(new Error(D))})}onbatch(){}onclear(){}ondelete(){}onerror(){}onrequest(a){return a}onset(){}onsync(){}async override(a,b="records",c=void 0){if("indexes"===b)this.indexes=this.transform(a,c);else if("records"===b){const b=""===this.key?()=>s():a=>a[this.key]||s();this.indexes.clear(),this.data=new w(a.map(a=>[b(a),a])),this.size=this.total=this.data.size}else throw new Error("Invalid type");return!0}reduce(b,c,d=!1){let e=c||this.data.keys().next().value;return this.forEach((a,c)=>{e=b(e,a,c,this,d)},this),e}register(a,b){return E[a]=b,this}reindex(a){const b=a?[a]:this.index;return a&&!1===this.index.includes(a)&&this.index.push(a),d(b,a=>this.indexes.set(a,new w)),this.forEach((a,e)=>d(b,b=>c(this.index,this.indexes,this.delimiter,e,a,b,this.pattern))),this}async request(a,b={}){return new v(async(c,f)=>{const h=n(g(this.config),b),j={};h.method=h.method.toUpperCase(),"DELETE"===h.method&&delete h.body,this.beforeRequest(...[a,h]);try{const b=await z(a,h),e=b.ok,g=b.status;if(b.headers._headers)d(Object.keys(b.headers._headers),a=>{j[a]=b.headers._headers[a].join(", ")});else for(const a of b.headers.entries())j[a[0]]=a[1];const i=await b[r.json.test(j["content-type"]||"")?"json":"text"](),k=e?c:f;k(this.list(this.onrequest(i,g,j),g,j))}catch(a){f(this.list(a.message,0,{}))}})}async save(a="mongo"){let b;try{b=await this.cmd(a,"set"),this.log(`Saved ${this.id} to ${a} persistent storage`)}catch(b){throw this.log(`Error saving ${this.id} to ${a} persistent storage: ${b.message||b.stack||b}`,"error"),b}return b}search(a,b,c=!1){const e=new w,f=a&&"function"==typeof a.test;return a&&d(b?Array.isArray(b)?b:[b]:this.index,b=>{let d=this.indexes.get(b);d&&d.forEach((d,g)=>{switch(!0){case"function"==typeof a&&a(g,b):case f&&a.test(Array.isArray(g)?g.join(", "):g):case g===a:d.forEach(a=>{!e.has(a)&&this.has(a)&&e.set(a,this.get(a,c))});break;default:}})}),c?Array.from(e.values()):this.list(...Array.from(e.values()))}async set(a,b,d=!1,e=!1,f=!1,h=!1){let i,j,l=g(b);return this.exec(async()=>((void 0===a||null===a)&&(a=this.key&&void 0!==l[this.key]?l[this.key]:s()),this.beforeSet(a,b,d,e,f,h),this.data.has(a)?(j=this.get(a,!0),k(this.index,this.indexes,this.delimiter,a,j,this.pattern),i="put",this.versioning&&this.versions.get(a).add(Object.freeze(g(j))),!1===e&&(l=n(g(j),l))):(++this.total,this.size=this.total,i="post",this.versioning&&this.versions.set(a,new y)),this.data.set(a,l),c(this.index,this.indexes,this.delimiter,a,l,null,this.pattern),this.get(a)),async b=>(this.onset(b,d,h,f),f||(this.storage("set",a,l).then(b=>{b&&this.log(`Saved ${a} to persistent storage`)},b=>this.log(`Error saving ${a} to persistent storage: ${b.message||b.stack||b}`,"error")),!d&&!h&&this.uri&&(this.debounced.has(a)&&clearTimeout(this.debounced.get(a)),this.debounced.set(a,setTimeout(async()=>{this.debounced.delete(a);try{if(await this.transmit(a,l,j,e,i),j)try{await this.set(a,j,d,!0,f,!0),this.log(`Reverted ${a}`)}catch(b){this.log(`Failed to revert ${a}`)}else try{await this.del(a,!0),this.log(`Reverted ${a}`)}catch(b){this.log(`Failed to revert ${a}`)}}catch(a){this.log(a.stack||a.message||a,"error")}},this.debounce)))),b),a=>{throw this.onerror("set",a),a})}async setUri(a,b=!1){return this.uri=a,""===this.uri?[]:await this.sync(b)}sort(a,b=!0){return b?Object.freeze(this.limit(0,this.total,!0).sort(a).map(a=>Object.freeze(a))):this.limit(0,this.total,!0).sort(a)}sortBy(a,b=!1){const c=[],e=[];let f;return this.indexes.has(a)||this.reindex(a),f=this.indexes.get(a),f.forEach((a,b)=>e.push(b)),d(e.sort(),a=>f.get(a).forEach(a=>c.push(this.get(a,b)))),b?c:this.list(...c)}async storage(...a){let b;try{const c=Object.keys(this.adapters).map(async b=>await this.cmd.apply(this,[b,...a]));0<c.length?(await v.all(c),b=!0):b=!1}catch(a){throw this.log(a.stack||a.message||a,"error"),a}return b}async sync(a=!1){let b;this.beforeSync(this.uri,a);try{const c=await this.request(this.uri),d=this.source?this.crawl(c[0]):c[0];this.patch=(c[2].Allow||c[2].allow||"").includes("PATCH"),a&&this.clear(),b=await this.batch(d,"set"),this.onsync(b)}catch(a){throw this.onerror("sync",a[0]||a),a[0]||a}return b}toArray(a,b=!0){let c;return a?c=a.map(a=>b?a[1]:g(a[1])):(c=this.limit(0,this.total,!0),b&&d(c,a=>Object.freeze(a))),b?Object.freeze(c):c}toObject(a,c=!0){const d=a?a.reduce((d,a)=>{const b=g(a[1]);return c&&Object.freeze(b),d[a[0]]=b,d},{}):i(this,c);return c?Object.freeze(d):d}transform(a,b){return"function"==typeof b?b(a):e(a)}async transmit(a,b,c,d=!1,f="post"){const g=h(this.uri,b?a:null);let i,j;if(this.patch){i=void 0===b?[{op:"remove",path:"/",value:a}]:void 0===c?[{op:"add",path:"/",value:b}]:d?[{op:"replace",path:"/",value:b}]:p(c,b,this.key);try{j=await this.request(g,{method:"patch",headers:{"content-type":"application/json-patch+json"},body:JSON.stringify(i,null,0)})}catch(c){if(405===c[1])this.patch=!1,j=await this.request(b?g:h(this.uri,a),{method:f,headers:{"content-type":"application/json"},body:JSON.stringify(b,null,0)});else throw c}}else j=await this.request(g,{method:f,headers:{"content-type":"application/json"},body:JSON.stringify(b,null,0)});return j}async unload(a="mongo",b=void 0){const c=void 0===b?this.id:b;let d;try{d=await this.cmd(a,"remove",b),this.log(`Unloaded ${c} from ${a} persistent storage`)}catch(b){throw this.log(`Error unloading ${c} from ${a} persistent storage: ${b.message||b.stack||b}`,"error"),b}return d}unregister(a){delete E[a]}values(){return this.data.values()}useWorker(a,b){let c;return this.worker?(c=new B(this.worker),c.onerror=a=>{b(a),c.terminate()},c.onmessage=b=>{a(JSON.parse(b.data)),c.terminate()}):b(new Error(D)),c}where(a,b=!1,c="||"){const d=this.index.filter(b=>b in a);return 0<d.length?this.filter(new Function("a",`return (${d.map(b=>{let d;if(Array.isArray(a[b]))d=`Array.isArray(a['${b}']) ? ${a[b].map(a=>`a['${b}'].includes(${"string"==typeof a?`'${a}'`:a})`).join(` ${c} `)} : a['${b}'] === '${a[b].join(",")}'`;else if(a[b]instanceof RegExp)d=`Array.isArray(a['${b}']) ? a['${b}'].filter(i => ${a[b]}.test(a['${b}'])).length > 0 : ${a[b]}.test(a['${b}'])`;else{const c="string"==typeof a[b]?`'${a[b]}'`:a[b];d=`Array.isArray(a['${b}']) ? a['${b}'].includes(${c}) : a['${b}'] === ${c}`}return d}).join(") && (")});`),b):[]}}t.transform=e,t.version="4.7.0","undefined"==typeof exports?"function"==typeof define&&void 0!==define.amd?define(()=>t):a.haro=t:module.exports=t})("undefined"==typeof window?global:window);
//# sourceMappingURL=haro.min.js.map