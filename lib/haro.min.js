/* 2015 Jason Mulligan <jason.mulligan@avoidwork.com> */

<<<<<<< HEAD
"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(a){function cast(a){var b=void 0;switch(!0){case a instanceof Map:b={},a.forEach(function(a,c){b[c]=cast(a)});break;case a instanceof Set:b=[],a.forEach(function(a){b.push(cast(a))});break;case a instanceof Array:b=new Set,a.forEach(function(a){b.add(cast(a))});break;case a instanceof Object:b=new Map,Object.keys(a).forEach(function(c){b.set(c,cast(a[c]))});break;default:b=a}return b}function b(b){var c=void 0;try{c=new q([b],{type:"application/javascript"})}catch(d){a.BlobBuilder||(a.BlobBuilder=a.MSBlobBuilder||a.WebKitBlobBuilder||a.MozBlobBuilder),c=(new a.BlobBuilder).append(b).getBlob()}return c}function clone(a){return JSON.parse(JSON.stringify(a))}function c(a,b){return a.replace(t.querystring,"").replace(t.endslash,"")+(b?"/"+b:"")}function keyIndex(a,b,c,d){var e=a.split(c).sort(),f=void 0;return f=e.length>1?e.map(function(a){return String(b[a]).replace(new RegExp(d,"g"),"").toLowerCase()}).join(c):b[a]}function d(a,b,c,d,e,f){a.forEach(function(a){var g=b.get(a),h=keyIndex(a,e,c,f),i=void 0;g.has(h)&&(i=g.get(h),i["delete"](d),0===i.size&&g["delete"](h))})}function createIndexes(a,b,c,d,e){var f={};return b.forEach(function(a){f[a]={}}),a.forEach(function(a){var g=a[c];void 0!==g&&b.forEach(function(b){var c=keyIndex(b,a,d,e);void 0===f[b][c]&&(f[b][c]=[]),f[b][c].push(g)})}),f}function each(a,b){for(var c=-1,d=a.length;++c<d&&b(a[c])!==!1;);}function e(a,b){a instanceof Object?Object.keys(a).forEach(function(c){b.call(a,a[c],c)}):a.forEach(b)}function merge(a,b){var c=void 0!==a?clone(a):a,d=void 0!==b?clone(b):b;return c instanceof Object&&d instanceof Object?Object.keys(d).forEach(function(a){c[a]instanceof Object&&d[a]instanceof Object?c[a]=merge(c[a],d[a]):c[a]instanceof Array&&d[a]instanceof Array?c[a]=c[a].concat(d[a]):c[a]=d[a]}):c=c instanceof Array&&d instanceof Array?c.concat(d):d,c}function f(a){var b=JSON.parse(a.data),c=b.cmd,d=void 0;"index"===c&&(d=createIndexes(b.records,b.index,b.key,b.delimiter,b.pattern)),"join"===c&&(d=joinData(b.records[0],b.records[1],b.key,b.on,b.type)),postMessage(JSON.stringify(d))}function joinData(a,b,c,d){var e=arguments.length<=4||void 0===arguments[4]?"inner":arguments[4],f=!1,g=void 0,h=void 0;return"inner"===e&&(h=[],each(a,function(a){var e=b.filter(function(b){return b[d]===a[c]});return e.length>1?(f=!0,g="More than one record found on "+a[d],!1):void(1===e.length&&h.push(merge(a,e[0])))})),"outer"===e&&(h=[]),"left"===e&&(h=[]),"right"===e&&(h=[]),f?g:h}function g(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],b=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],c=arguments.length<=2||void 0===arguments[2]?"":arguments[2],d=arguments.length<=3||void 0===arguments[3]?!1:arguments[3],f=[];return d&&e(a,function(a,d){d!==c&&void 0===b[d]&&f.push({op:"remove",path:"/"+d})}),e(b,function(b,d){d!==c&&void 0===a[d]?f.push({op:"add",path:"/"+d,value:b}):JSON.stringify(a[d])!==JSON.stringify(b)&&f.push({op:"replace",path:"/"+d,value:b})}),f}function h(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function setIndexValue(a,b,c){a.has(b)||a.set(b,new Set),a.get(b).add(c)}function setIndex(a,b,c,d,e,f,g){f?setIndexValue(b.get(f),keyIndex(f,e,c,g),d):a.forEach(function(a){setIndexValue(b.get(a),keyIndex(a,e,c,g),d)})}function i(a){var b={};return a.forEach(function(a,c){b[c]=a}),b}function j(){return h()+h()+"-"+h()+"-4"+h().substr(0,3)+"-"+s[Math.floor(4*Math.random())]+h().substr(0,3)+"-"+h()+h()+h()}function k(){var c=arguments.length<=0||void 0===arguments[0]?null:arguments[0],d=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],e=arguments.length<=2||void 0===arguments[2]?[]:arguments[2],g=new Haro(c,d,e),h=void 0;if(u){h=[cast.toString(),clone.toString(),createIndexes.toString(),each.toString(),joinData.toString(),keyIndex.toString(),merge.toString(),setIndexValue.toString(),setIndex.toString(),(l?"self.":"")+"onmessage = "+f.toString()+";"];try{g.worker=l?new Function(h.join("\n")):a.URL.createObjectURL(b(h.join("\n")))}catch(i){g.worker=null}}return g}var l="undefined"!=typeof process&&"function"==typeof process.nextTick,m=l?require("es6-promise").Promise:a.Promise,Map=l?require("es6-map"):a.Map,Set=l?require("es6-set"):a.Set,n=l?require("node-fetch"):a.fetch,o=l?require("tiny-defer"):a.deferred,p=l?require("tiny-tuple"):a.tuple,q=l?require("Blob"):a.Blob,r=l?require("tiny-worker"):a.Worker,s=[8,9,"a","b"],t={querystring:/\?.*/,endslash:/\/$/},u="undefined"!=typeof q&&"undefined"!=typeof r,v="Web Worker not supported",w={},Haro=function(){function Haro(a){var b=this,c=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];_classCallCheck(this,Haro),this.adapters={},this.data=new Map,this.delimiter="|",this.config={method:"get",credentials:!1,headers:{accept:"application/json","content-type":"application/json"}},this.id=j(),this.index=[],this.indexes=new Map,this.key="",this.logging=!0,this.patch=!1,this.pattern="\\s*|\\t*",this.registry=[],this.source="",this.total=0,this.uri="",this.worker=null,this.versions=new Map,this.versioning=!0,Object.keys(c).forEach(function(a){b[a]=merge(b[a],c[a])}),this.reindex(),a&&this.batch(a,"set")}return _createClass(Haro,[{key:"batch",value:function(a,b){function d(){m.all(a.map(k)).then(h.resolve,h.reject)}var e=this,f=arguments.length<=2||void 0===arguments[2]?!1:arguments[2],h=o(),i="del"===b,j=void 0,k=void 0,l=void 0;return k=i?function(a){return e.del(a,!0)}:function(a){return e.set(null,a,!0,!0,f)},this.patch?(i?j=g(this.toArray().map(function(a){return a[e.key]}),a,this.key,!0):(j=[],l={},a.forEach(function(a){var b=a[e.key];b?l[b]=a:j.push({op:"add",path:"/",value:a})}),j=j.concat(g(this.toObject(),l,this.key,!0))),j.length>0?this.request(c(this.uri,null),{method:"patch",body:JSON.stringify(j)}).then(function(){d()},h.reject):h.resolve()):d(),h.promise}},{key:"clear",value:function(){return this.total=0,this.registry=[],this.data.clear(),this.indexes.clear(),this.versions.clear(),this.logging&&console.log("Cleared",this.id),this.reindex()}},{key:"cmd",value:function(a){var b=o();if(this.adapters[a]&&w[a]){for(var c=arguments.length,d=Array(c>1?c-1:0),e=1;c>e;e++)d[e-1]=arguments[e];w[a].apply(this,[this].concat(d)).then(b.resolve,b.reject)}else b.reject(new Error(a+" not configured for persistent storage"));return b.promise}},{key:"del",value:function(a){var b=this,e=arguments.length<=1||void 0===arguments[1]?!1:arguments[1],f=o(),g=void 0;return g=function(){var c=b.registry.indexOf(a);c>-1&&(0===c?b.registry.shift():c===b.registry.length-1?b.registry.pop():b.registry.splice(c,1),d(b.index,b.indexes,b.delimiter,a,b.data.get(a),b.pattern),b.data["delete"](a),--b.total,b.versioning&&b.versions["delete"](a),b.storage("remove",a).then(function(c){c&&b.logging&&console.log("Deleted",a,"from persistent storage")},function(c){b.logging&&console.error("Error deleting",a,"from persistent storage:",c.message||c.stack||c)})),f.resolve()},this.data.has(a)?!e&&this.uri?this.patch?this.request(c(this.uri,null),{method:"patch",body:JSON.stringify([{op:"remove",path:"/"+a}])}).then(g,function(d){405===d[1]?(b.patch=!1,b.request(c(b.uri,a),{method:"delete"}).then(g,f.reject)):f.reject(d)}):this.request(c(this.uri,a),{method:"delete"}).then(g,f.reject):g():f.reject(new Error("Record not found")),f.promise}},{key:"dump",value:function(){var a=arguments.length<=0||void 0===arguments[0]?"records":arguments[0],b=void 0;return b="records"===a?this.toArray(null,!1):this.transform(this.indexes)}},{key:"entries",value:function(){return this.data.entries()}},{key:"find",value:function(a){var b=this,c=arguments.length<=1||void 0===arguments[1]?!1:arguments[1],d=Object.keys(a).sort().join(this.delimiter),e=keyIndex(d,a,this.delimiter),f=[];return this.indexes.has(d)&&(this.indexes.get(d).get(e)||new Set).forEach(function(a){f.push(b.get(a,c))}),c?clone(f):p.apply(p,f)}},{key:"filter",value:function(a){var b=[];return this.forEach(function(c,d){a(c,d)===!0&&b.push(p(d,c))}),p.apply(p,b)}},{key:"forEach",value:function(a,b){return this.data.forEach(function(b,c){a(clone(b),clone(c))},b),this}},{key:"get",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?!1:arguments[1],c=void 0;return this.data.has(a)&&(c=b?this.data.get(a):p(a,this.data.get(a))),c}},{key:"has",value:function(a){return this.data.has(a)}},{key:"join",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?this.key:arguments[1],c=this,d=arguments.length<=2||void 0===arguments[2]?"inner":arguments[2],e=arguments.length<=3||void 0===arguments[3]?{}:arguments[3],f=o();return a.total>0?Object.keys(e).length>0?m.all([this.find(e,!0),a.find(e,!0)]).then(function(a){return a[0].length>0&&a[1].length>1?c.offload([a[0],a[1],c.key,b,d],"join"):[]},function(a){throw a}).then(function(a){"string"==typeof a?f.reject(new Error(a)):f.resolve(a)},f.reject):this.offload([this.toArray(null,!0),a.toArray(null,!0),this.key,b,d],"join").then(function(a){"string"==typeof a?f.reject(new Error(a)):f.resolve(a)},f.reject):f.resolve([]),f.promise}},{key:"keys",value:function(){return this.data.keys()}},{key:"limit",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?0:arguments[1],c=a,d=b,e=[],f=void 0,g=void 0,h=void 0;if(void 0===c&&(c=-1),f=d,h=d+c,0>f||f>=h)throw new Error("Invalid range");do g=this.registry[f],g&&e.push(this.get(g));while(++f<h);return p.apply(p,e)}},{key:"load",value:function(){var a=this,b=arguments.length<=0||void 0===arguments[0]?"mongo":arguments[0],c=arguments.length<=1||void 0===arguments[1]?void 0:arguments[1],d=void 0===c,e=d?this.id:c;return d&&this.clear(),this.cmd(b,"get",c).then(function(f){return a.logging&&console.log("Loaded",e,"from",b,"persistent storage"),d?a.batch(f,"set",!0):a.set(c,f,!0,!0,!0)},function(c){throw a.logging&&console.error("Error loading",e,"from",b,"persistent storage:",c.message||c.stack||c),c})}},{key:"map",value:function(a){var b=[];return this.forEach(function(c,d){b.push(a(c,d))}),p.apply(p,b)}},{key:"offload",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?"index":arguments[1],c=arguments.length<=2||void 0===arguments[2]?this.index:arguments[2],d=o(),e=void 0,f=void 0;return this.worker?(f=this.useWorker(d),f&&("index"===b&&(e={cmd:b,index:c,records:a,key:this.key,delimiter:this.delimiter,pattern:this.pattern}),"join"===b&&(e={cmd:b,records:[a[0],a[1]],key:a[2],on:a[3],type:a[4]}),f.postMessage(JSON.stringify(e)))):d.reject(new Error(v)),d.promise}},{key:"override",value:function(a){var b=this,c=arguments.length<=1||void 0===arguments[1]?"records":arguments[1],d=arguments.length<=2||void 0===arguments[2]?void 0:arguments[2],e=o();return"indexes"===c?(this.indexes=this.transform(a,d),e.resolve(!0)):"records"===c?(this.data=new Map,this.registry=[],a.forEach(function(a){var c=a[b.key]||j();b.data.set(c,a),b.registry.push(c)}),this.total=this.data.size,e.resolve(!0)):e.reject(new Error("Invalid type")),e.promise}},{key:"register",value:function(a,b){w[a]=b}},{key:"reindex",value:function(a){var b=this;return a?(this.indexes.set(a,new Map),this.forEach(function(c,d){setIndex(b.index,b.indexes,b.delimiter,d,c,a,b.pattern)})):(this.indexes.clear(),this.index.forEach(function(a){b.indexes.set(a,new Map)}),this.forEach(function(a,c){b.index.forEach(function(d){setIndex(b.index,b.indexes,b.delimiter,c,a,d,b.pattern)})})),this}},{key:"request",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],c=o(),d=merge(this.config,b);return d.method=d.method.toUpperCase(),n(a,d).then(function(a){var b=a.status,d=void 0;a.headers._headers?(d={},Object.keys(a.headers._headers).forEach(function(b){d[b]=a.headers._headers[b].join(", ")})):d=i(a.headers),a[a.headers.get("content-type").indexOf("application/json")>-1?"json":"text"]().then(function(a){c[200>b||b>=400?"reject":"resolve"](p(a,b,d))},function(a){c.reject(p(a.message,b,d))})},function(a){c.reject(p(a.message,0,{}))}),c.promise}},{key:"save",value:function(){var a=this,b=arguments.length<=0||void 0===arguments[0]?"mongo":arguments[0];return this.cmd(b,"set").then(function(c){return a.logging&&console.log("Saved",a.id,"to",b,"persistent storage"),c},function(c){throw a.logging&&console.error("Error saving ",a.id,"to",b,"persistent storage:",c.message||c.stack||c),c})}},{key:"search",value:function(a,b){var c=this,d=[],e="function"==typeof a,f=a&&"function"==typeof a.test,g=new Set,h=void 0,i=void 0;return a&&(h=clone(b||this.index),h instanceof Array?i=h:"string"==typeof h&&(i=[h]),i.forEach(function(b){var h=c.indexes.get(b);h&&h.forEach(function(h,i){switch(!0){case e&&a(i,b):case f&&a.test(i):case i===a:h.forEach(function(a){g.has(a)||(g.add(a),d.push(c.get(a)))})}})})),p.apply(p,d)}},{key:"set",value:function(a,b){var e=arguments.length<=2||void 0===arguments[2]?!1:arguments[2],f=this,h=arguments.length<=3||void 0===arguments[3]?!1:arguments[3],i=arguments.length<=4||void 0===arguments[4]?!1:arguments[4],k=o(),l="post",m=clone(b),n=a,q=void 0,r=void 0,s=void 0,t=function(a){var b=a?a[0]:{};null===n&&(f.key?(f.source&&f.source.split(".").forEach(function(a){b=b[a]||{}}),n=b[f.key]||m[f.key]||j()):n=j()),"post"===l?(f.registry[f.total]=n,++f.total,f.versioning&&f.versions.set(n,new Set)):(f.versioning&&f.versions.get(n).add(p(r)),d(f.index,f.indexes,f.delimiter,n,r,f.pattern)),f.data.set(n,m),setIndex(f.index,f.indexes,f.delimiter,n,m,null,f.pattern),k.resolve(f.get(n)),i||f.storage("set",n,m).then(function(a){a&&f.logging&&console.log("Saved",n,"to persistent storage")},function(a){f.logging&&console.error("Error saving",n,"to persistent storage:",a.message||a.stack||a)})};return void 0===n||null===n?n=null:this.data.has(n)&&(l="put",r=this.data.get(n),h||(m=merge(r,m))),!e&&this.uri?(s=c(this.uri,n),this.patch?(q="post"===l?[{op:"add",path:"/",value:m}]:h?[{op:"replace",path:"/",value:m}]:g(r,m,this.key),this.request(s,{method:"patch",body:JSON.stringify(q)}).then(t,function(a){405===a[1]?(f.patch=!1,f.request(s,{method:l,body:JSON.stringify(m)}).then(t,function(a){k.reject(a)})):k.reject(a)})):this.request(s,{method:l,body:JSON.stringify(m)}).then(t,function(a){k.reject(a)})):t(),k.promise}},{key:"setUri",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?!1:arguments[1],c=o();return this.uri=a,this.uri?this.sync(b).then(c.resolve,c.reject):c.resolve([]),c.promise}},{key:"sort",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?!0:arguments[1],c=void 0;return c=b?Object.freeze(this.toArray(null,!1).sort(a).map(function(a){return Object.freeze(a)})):this.toArray(null,!1).sort(a)}},{key:"sortBy",value:function(a){var b=this,c=[],d=[],e=void 0;return this.indexes.has(a)||(this.index.push(a),this.reindex(a)),e=this.indexes.get(a),e.forEach(function(a,b){d.push(b)}),d.sort().forEach(function(a){e.get(a).forEach(function(a){c.push(b.get(a))})}),p.apply(p,c)}},{key:"storage",value:function(){for(var a=this,b=arguments.length,c=Array(b),d=0;b>d;d++)c[d]=arguments[d];var e=o(),f=[];return Object.keys(this.adapters).forEach(function(b){f.push(a.cmd.apply(a,[b].concat(c)))}),f.length>0?m.all(f).then(function(){e.resolve(!0)},e.reject):e.resolve(!1),e.promise}},{key:"sync",value:function(){var a=this,b=arguments.length<=0||void 0===arguments[0]?!1:arguments[0],c=o();return this.request(this.uri).then(function(d){var e=d[0];if(a.patch=(d[2].Allow||d[2].allow||"").indexOf("PATCH")>-1,a.source)try{a.source.split(".").forEach(function(a){e=e[a]})}catch(f){return c.reject(f)}b&&a.clear(),a.batch(e,"set").then(c.resolve,c.reject)},function(a){c.reject(a[0]||a)}),c.promise}},{key:"toArray",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?!0:arguments[1],c=this.key,d=void 0,e=void 0;return a?(d=function(){return c?function(a,b){var d=clone(b[1]);return void 0===d[c]&&(d[c]=clone(b[0])),a.push(d),a}:function(a,b){return a.push(clone(b[1])),a}}(),e=a.reduce(d,[])):(d=function(){return c?function(a,b){var d=clone(a);void 0===d[c]&&(d[c]=clone(b)),e.push(d)}:function(a){e.push(clone(a))}}(),e=[],this.forEach(d)),b?Object.freeze(e):e}},{key:"toObject",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?!0:arguments[1],c=void 0;return(c=b?function(a){return a}:function(a){return clone(a)})(a?a.reduce(function(a,b){return a[b[0]]=b[1],a},{}):i(this))}},{key:"transform",value:function(a,b){return"function"==typeof b?b(a):cast(a)}},{key:"unload",value:function(){var a=this,b=arguments.length<=0||void 0===arguments[0]?"mongo":arguments[0],c=arguments.length<=1||void 0===arguments[1]?void 0:arguments[1],d=void 0!==c?c:this.id;return this.cmd(b,"remove",c).then(function(c){return a.logging&&console.log("Unloaded",d,"from",b,"persistent storage"),c},function(c){throw a.logging&&console.error("Error unloading",d,"from",b,"persistent storage:",c.message||c.stack||c),c})}},{key:"unregister",value:function(a){delete w[a]}},{key:"values",value:function(){return this.data.values()}},{key:"useWorker",value:function(a){var b=void 0;return this.worker?(b=new r(this.worker),b.onerror=function(c){a.reject(c),b.terminate()},b.onmessage=function(c){a.resolve(JSON.parse(c.data)),b.terminate()}):a.reject(new Error(v)),b}}]),Haro}();k.transform=cast,k.version="1.8.0","undefined"!=typeof exports?module.exports=k:"function"==typeof define?define(function(){return k}):a.haro=k}("undefined"!=typeof global?global:window);
=======
"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(a){function cast(a){var b=void 0;switch(!0){case a instanceof Map:b={},a.forEach(function(a,c){b[c]=cast(a)});break;case a instanceof Set:b=[],a.forEach(function(a){b.push(cast(a))});break;case a instanceof Array:b=new Set,a.forEach(function(a){b.add(cast(a))});break;case a instanceof Object:b=new Map,Object.keys(a).forEach(function(c){b.set(c,cast(a[c]))});break;default:b=a}return b}function b(b){var c=void 0;try{c=new s([b],{type:"application/javascript"})}catch(d){a.BlobBuilder||(a.BlobBuilder=a.MSBlobBuilder||a.WebKitBlobBuilder||a.MozBlobBuilder),c=(new a.BlobBuilder).append(b).getBlob()}return c}function c(a){return JSON.parse(JSON.stringify(a))}function d(a,b){return a.replace(v.querystring,"").replace(v.endslash,"")+(b?"/"+b:"")}function keyIndex(a,b,c,d){var e=a.split(c).sort(),f=void 0;return f=e.length>1?e.map(function(a){return String(b[a]).replace(new RegExp(d,"g"),"").toLowerCase()}).join(c):b[a]}function e(a,b,c,d,e,f){a.forEach(function(a){var g=b.get(a),h=keyIndex(a,e,c,f),i=void 0;g.has(h)&&(i=g.get(h),i["delete"](d),0===i.size&&(i=null,g["delete"](h)))})}function createIndexes(a,b,c,d,e){var f={};return b.forEach(function(a){f[a]={}}),a.forEach(function(a){var g=a[c];void 0!==g&&b.forEach(function(b){var c=keyIndex(b,a,d,e);void 0===f[b][c]&&(f[b][c]=[]),f[b][c].push(g)})}),f}function f(a,b){a instanceof Object?Object.keys(a).forEach(function(c){b.call(a,a[c],c)}):a.forEach(b)}function g(a,b){var d=void 0!==a?c(a):a,e=void 0!==b?c(b):b;return d instanceof Object&&e instanceof Object?Object.keys(e).forEach(function(a){d[a]instanceof Object&&e[a]instanceof Object?d[a]=g(d[a],e[a]):d[a]instanceof Array&&e[a]instanceof Array?d[a]=d[a].concat(e[a]):d[a]=e[a]}):d=d instanceof Array&&e instanceof Array?d.concat(e):e,d}function h(a){var b=JSON.parse(a.data),c=b.records,d=b.index,e=b.cmd,f=b.key,g=b.delimiter,h=b.pattern,i=void 0;"index"===e&&(i=createIndexes(c,d,f,g,h)),postMessage(JSON.stringify(i))}function i(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],b=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],c=arguments.length<=2||void 0===arguments[2]?"":arguments[2],d=arguments.length<=3||void 0===arguments[3]?!1:arguments[3],e=[];return d&&f(a,function(a,d){d!==c&&void 0===b[d]&&e.push({op:"remove",path:"/"+d})}),f(b,function(b,d){d!==c&&void 0===a[d]?e.push({op:"add",path:"/"+d,value:b}):JSON.stringify(a[d])!==JSON.stringify(b)&&e.push({op:"replace",path:"/"+d,value:b})}),e}function j(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function setIndexValue(a,b,c){a.has(b)||a.set(b,new Set),a.get(b).add(c)}function setIndex(a,b,c,d,e,f,g){var h=void 0;f?(h=keyIndex(f,e,c,g),void 0!==h&&null!==h&&setIndexValue(b.get(f),h,d)):a.forEach(function(a){var f=keyIndex(a,e,c,g);void 0!==f&&null!==f&&setIndexValue(b.get(a),f,d)})}function k(a){var b={};return a.forEach(function(a,c){b[c]=a}),b}function l(){return j()+j()+"-"+j()+"-4"+j().substr(0,3)+"-"+u[Math.floor(4*Math.random())]+j().substr(0,3)+"-"+j()+j()+j()}function m(){var c=arguments.length<=0||void 0===arguments[0]?null:arguments[0],d=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],e=arguments.length<=2||void 0===arguments[2]?[]:arguments[2],f=new Haro(c,d,e),g=void 0;if(w){g=[createIndexes.toString(),keyIndex.toString(),setIndexValue.toString(),setIndex.toString(),cast.toString(),(n?"self.":"")+"onmessage = "+h.toString()+";"];try{f.worker=n?new Function(g.join("\n")):a.URL.createObjectURL(b(g.join("\n")))}catch(i){f.worker=null}}return f}var n="undefined"!=typeof process&&"function"==typeof process.nextTick,o=a.Promise||require("es6-promise").Promise,Map=a.Map||require("es6-map"),Set=a.Set||require("es6-set"),p=a.fetch||require("node-fetch"),q=a.deferred||require("tiny-defer"),r=a.tuple||require("tiny-tuple"),s=a.Blob||require("Blob"),t=a.Worker||require("tiny-worker"),u=[8,9,"a","b"],v={querystring:/\?.*/,endslash:/\/$/},w="undefined"!=typeof s&&"undefined"!=typeof t,x="Web Worker not supported",y={},Haro=function(){function Haro(a){var b=this,c=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];_classCallCheck(this,Haro),this.adapters={},this.data=new Map,this.delimiter="|",this.config={method:"get",credentials:!1,headers:{accept:"application/json","content-type":"application/json"}},this.id=l(),this.index=[],this.indexes=new Map,this.key="",this.logging=!0,this.patch=!1,this.pattern="\\s*|\\t*",this.registry=[],this.source="",this.total=0,this.uri="",this.worker=null,this.versions=new Map,this.versioning=!0,Object.keys(c).forEach(function(a){b[a]=g(b[a],c[a])}),this.reindex(),a&&this.batch(a,"set")}return _createClass(Haro,[{key:"batch",value:function(a,b){function c(){o.all(a.map(k)).then(g.resolve,g.reject)}var e=this,f=arguments.length<=2||void 0===arguments[2]?!1:arguments[2],g=q(),h="del"===b,j=void 0,k=void 0,l=void 0;return k=h?function(a){return e.del(a,!0)}:function(a){return e.set(null,a,!0,!0,f)},this.patch?(h?j=i(this.toArray().map(function(a){return a[e.key]}),a,this.key,!0):(j=[],l={},a.forEach(function(a){var b=a[e.key];b?l[b]=a:j.push({op:"add",path:"/",value:a})}),j=j.concat(i(this.toObject(),l,this.key,!0))),j.length>0?this.request(d(this.uri,null),{method:"patch",body:JSON.stringify(j)}).then(function(){c()},g.reject):g.resolve()):c(),g.promise}},{key:"clear",value:function(){return this.total=0,this.registry=[],this.data.clear(),this.indexes.clear(),this.versions.clear(),this.logging&&console.log("Cleared",this.id),this.reindex()}},{key:"cmd",value:function(a){var b=q();if(this.adapters[a]&&y[a]){for(var c=arguments.length,d=Array(c>1?c-1:0),e=1;c>e;e++)d[e-1]=arguments[e];y[a].apply(this,[this].concat(d)).then(b.resolve,b.reject)}else b.reject(new Error(a+" not configured for persistent storage"));return b.promise}},{key:"del",value:function(a){var b=this,c=arguments.length<=1||void 0===arguments[1]?!1:arguments[1],f=q(),g=void 0;return g=function(){var c=b.registry.indexOf(a);c>-1&&(0===c?b.registry.shift():c===b.registry.length-1?b.registry.pop():b.registry.splice(c,1),e(b.index,b.indexes,b.delimiter,a,b.data.get(a),b.pattern),b.data["delete"](a),--b.total,b.versioning&&b.versions["delete"](a),b.storage("remove",a).then(function(c){c&&b.logging&&console.log("Deleted",a,"from persistent storage")},function(c){b.logging&&console.error("Error deleting",a,"from persistent storage:",c.message||c.stack||c)})),f.resolve()},this.data.has(a)?!c&&this.uri?this.patch?this.request(d(this.uri,null),{method:"patch",body:JSON.stringify([{op:"remove",path:"/"+a}])}).then(g,function(c){405===c[1]?(b.patch=!1,b.request(d(b.uri,a),{method:"delete"}).then(g,f.reject)):f.reject(c)}):this.request(d(this.uri,a),{method:"delete"}).then(g,f.reject):g():f.reject(new Error("Record not found")),f.promise}},{key:"dump",value:function(){var a=arguments.length<=0||void 0===arguments[0]?"records":arguments[0],b=void 0;return b="records"===a?this.toArray(null,!1):this.transform(this.indexes)}},{key:"entries",value:function(){return this.data.entries()}},{key:"find",value:function(a){var b=this,c=Object.keys(a).sort().join(this.delimiter),d=keyIndex(c,a,this.delimiter),e=[];return this.indexes.has(c)&&(this.indexes.get(c).get(d)||new Set).forEach(function(a){e.push(b.get(a))}),r.apply(r,e)}},{key:"filter",value:function(a){var b=[];return this.forEach(function(c,d){a(c,d)===!0&&b.push(r(d,c))}),r.apply(r,b)}},{key:"forEach",value:function(a,b){return this.data.forEach(function(b,d){a(c(b),c(d))},b),this}},{key:"get",value:function(a){var b=void 0;return this.data.has(a)&&(b=r(a,this.data.get(a))),b}},{key:"has",value:function(a){return this.data.has(a)}},{key:"keys",value:function(){return this.data.keys()}},{key:"limit",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?0:arguments[1],c=a,d=b,e=[],f=void 0,g=void 0,h=void 0;if(void 0===c&&(c=-1),f=d,h=d+c,0>f||f>=h)throw new Error("Invalid range");do g=this.registry[f],g&&e.push(this.get(g));while(++f<h);return r.apply(r,e)}},{key:"load",value:function(){var a=this,b=arguments.length<=0||void 0===arguments[0]?"mongo":arguments[0],c=arguments.length<=1||void 0===arguments[1]?void 0:arguments[1],d=void 0===c,e=d?this.id:c;return d&&this.clear(),this.cmd(b,"get",c).then(function(f){return a.logging&&console.log("Loaded",e,"from",b,"persistent storage"),d?a.batch(f,"set",!0):a.set(c,f,!0,!0,!0)},function(c){throw a.logging&&console.error("Error loading",e,"from",b,"persistent storage:",c.message||c.stack||c),c})}},{key:"map",value:function(a){var b=[];return this.forEach(function(c,d){b.push(a(c,d))}),r.apply(r,b)}},{key:"offload",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?"index":arguments[1],c=arguments.length<=2||void 0===arguments[2]?this.index:arguments[2],d=q(),e=void 0;return this.worker?(e=this.useWorker(d),e&&e.postMessage(JSON.stringify({cmd:b,index:c,records:a,key:this.key,delimiter:this.delimiter,pattern:this.pattern}))):d.reject(new Error(x)),d.promise}},{key:"override",value:function(a){var b=this,c=arguments.length<=1||void 0===arguments[1]?"records":arguments[1],d=arguments.length<=2||void 0===arguments[2]?void 0:arguments[2],e=q();return"indexes"===c?(this.indexes=this.transform(a,d),e.resolve(!0)):"records"===c?(this.data=new Map,this.registry=[],a.forEach(function(a){var c=a[b.key]||l();b.data.set(c,a),b.registry.push(c)}),this.total=this.data.size,e.resolve(!0)):e.reject(new Error("Invalid type")),e.promise}},{key:"register",value:function(a,b){y[a]=b}},{key:"reindex",value:function(a){var b=this;return a?(this.indexes.set(a,new Map),this.forEach(function(c,d){setIndex(b.index,b.indexes,b.delimiter,d,c,a,b.pattern)})):(this.indexes.clear(),this.index.forEach(function(a){b.indexes.set(a,new Map)}),this.forEach(function(a,c){b.index.forEach(function(d){setIndex(b.index,b.indexes,b.delimiter,c,a,d,b.pattern)})})),this}},{key:"request",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],c=q(),d=g(this.config,b);return d.method=d.method.toUpperCase(),p(a,d).then(function(a){var b=a.status,d=void 0;a.headers._headers?(d={},Object.keys(a.headers._headers).forEach(function(b){d[b]=a.headers._headers[b].join(", ")})):d=k(a.headers),a[a.headers.get("content-type").indexOf("application/json")>-1?"json":"text"]().then(function(a){c[200>b||b>=400?"reject":"resolve"](r(a,b,d))},function(a){c.reject(r(a.message,b,d))})},function(a){c.reject(r(a.message,0,{}))}),c.promise}},{key:"save",value:function(){var a=this,b=arguments.length<=0||void 0===arguments[0]?"mongo":arguments[0];return this.cmd(b,"set").then(function(c){return a.logging&&console.log("Saved",a.id,"to",b,"persistent storage"),c},function(c){throw a.logging&&console.error("Error saving ",a.id,"to",b,"persistent storage:",c.message||c.stack||c),c})}},{key:"search",value:function(a,b){var d=this,e=[],f="function"==typeof a,g=a&&"function"==typeof a.test,h=new Set,i=void 0,j=void 0;return a&&(i=c(b||this.index),i instanceof Array?j=i:"string"==typeof i&&(j=[i]),j.forEach(function(b){var c=d.indexes.get(b);c&&c.forEach(function(c,i){switch(!0){case f&&a(i,b):case g&&a.test(i):case i===a:c.forEach(function(a){h.has(a)||(h.add(a),e.push(d.get(a)))})}})})),r.apply(r,e)}},{key:"set",value:function(a,b){var f=arguments.length<=2||void 0===arguments[2]?!1:arguments[2],h=this,j=arguments.length<=3||void 0===arguments[3]?!1:arguments[3],k=arguments.length<=4||void 0===arguments[4]?!1:arguments[4],m=q(),n="post",o=c(b),p=a,s=void 0,t=void 0,u=void 0,v=function(a){var b=a?a[0]:{};null===p&&(h.key?(h.source&&h.source.split(".").forEach(function(a){b=b[a]||{}}),p=b[h.key]||o[h.key]||l()):p=l()),"post"===n?(h.registry[h.total]=p,++h.total,h.versioning&&h.versions.set(p,new Set)):(h.versioning&&h.versions.get(p).add(r(t)),e(h.index,h.indexes,h.delimiter,p,t,h.pattern)),h.data.set(p,o),setIndex(h.index,h.indexes,h.delimiter,p,o,null,h.pattern),m.resolve(h.get(p)),k||h.storage("set",p,o).then(function(a){a&&h.logging&&console.log("Saved",p,"to persistent storage")},function(a){h.logging&&console.error("Error saving",p,"to persistent storage:",a.message||a.stack||a)})};return(void 0===p||null===p)&&(p=o[this.key]||null),p&&this.data.has(p)&&(n="put",t=this.data.get(p),j||(o=g(t,o))),!f&&this.uri?(u=d(this.uri,p),this.patch?(s="post"===n?[{op:"add",path:"/",value:o}]:j?[{op:"replace",path:"/",value:o}]:i(t,o,this.key),this.request(u,{method:"patch",body:JSON.stringify(s)}).then(v,function(a){405===a[1]?(h.patch=!1,h.request(u,{method:n,body:JSON.stringify(o)}).then(v,function(a){m.reject(a)})):m.reject(a)})):this.request(u,{method:n,body:JSON.stringify(o)}).then(v,function(a){m.reject(a)})):v(),m.promise}},{key:"setUri",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?!1:arguments[1],c=q();return this.uri=a,this.uri?this.sync(b).then(c.resolve,c.reject):c.resolve([]),c.promise}},{key:"sort",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?!0:arguments[1],c=void 0;return c=b?Object.freeze(this.toArray(null,!1).sort(a).map(function(a){return Object.freeze(a)})):this.toArray(null,!1).sort(a)}},{key:"sortBy",value:function(a){var b=this,c=[],d=[],e=void 0;return this.indexes.has(a)||(this.index.push(a),this.reindex(a)),e=this.indexes.get(a),e.forEach(function(a,b){d.push(b)}),d.sort().forEach(function(a){e.get(a).forEach(function(a){c.push(b.get(a))})}),r.apply(r,c)}},{key:"storage",value:function(){for(var a=this,b=arguments.length,c=Array(b),d=0;b>d;d++)c[d]=arguments[d];var e=q(),f=[];return Object.keys(this.adapters).forEach(function(b){f.push(a.cmd.apply(a,[b].concat(c)))}),f.length>0?o.all(f).then(function(){e.resolve(!0)},e.reject):e.resolve(!1),e.promise}},{key:"sync",value:function(){var a=this,b=arguments.length<=0||void 0===arguments[0]?!1:arguments[0],c=q();return this.request(this.uri).then(function(d){var e=d[0];if(a.patch=(d[2].Allow||d[2].allow||"").indexOf("PATCH")>-1,a.source)try{a.source.split(".").forEach(function(a){e=e[a]})}catch(f){return c.reject(f)}b&&a.clear(),a.batch(e,"set").then(c.resolve,c.reject)},function(a){c.reject(a[0]||a)}),c.promise}},{key:"toArray",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?!0:arguments[1],d=this.key,e=void 0,f=void 0;return a?(e=function(){return d?function(a,b){var e=c(b[1]);return void 0===e[d]&&(e[d]=c(b[0])),a.push(e),a}:function(a,b){return a.push(c(b[1])),a}}(),f=a.reduce(e,[])):(e=function(){return d?function(a,b){var e=c(a);void 0===e[d]&&(e[d]=c(b)),f.push(e)}:function(a){f.push(c(a))}}(),f=[],this.forEach(e)),b?Object.freeze(f):f}},{key:"toObject",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?!0:arguments[1],d=void 0;return(d=b?function(a){return a}:function(a){return c(a)})(a?a.reduce(function(a,b){return a[b[0]]=b[1],a},{}):k(this))}},{key:"transform",value:function(a,b){return"function"==typeof b?b(a):cast(a)}},{key:"unload",value:function(){var a=this,b=arguments.length<=0||void 0===arguments[0]?"mongo":arguments[0],c=arguments.length<=1||void 0===arguments[1]?void 0:arguments[1],d=void 0!==c?c:this.id;return this.cmd(b,"remove",c).then(function(c){return a.logging&&console.log("Unloaded",d,"from",b,"persistent storage"),c},function(c){throw a.logging&&console.error("Error unloading",d,"from",b,"persistent storage:",c.message||c.stack||c),c})}},{key:"unregister",value:function(a){delete y[a]}},{key:"values",value:function(){return this.data.values()}},{key:"useWorker",value:function(a){var b=void 0;return this.worker?(b=new t(this.worker),b.onerror=function(c){a.reject(c),b.terminate()},b.onmessage=function(c){a.resolve(JSON.parse(c.data)),b.terminate()}):a.reject(new Error(x)),b}}]),Haro}();m.transform=cast,m.version="1.7.8","undefined"!=typeof exports?module.exports=m:"function"==typeof define?define(function(){return m}):a.haro=m}("undefined"!=typeof global?global:window);
>>>>>>> master
//# sourceMappingURL=haro.min.js.map