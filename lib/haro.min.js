/* 2017 Jason Mulligan <jason.mulligan@avoidwork.com> */

"use strict";function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(a){function b(){var a=void 0,b=void 0,c=void 0;return a=new o(function(a,d){b=a,c=d}),{resolve:b,reject:c,promise:a}}function c(a,b){return b in a}function each(a,b){var c=arguments.length>2&&void 0!==arguments[2]&&arguments[2],d=a.length,e=-1;if(c)for(;++e<d&&b(a[e],e)!==!1;);else for(;++e<d;)b(a[e],e)}function cast(a){var b=void 0;switch(!0){case a instanceof Map:b={},a.forEach(function(a,c){b[c]=cast(a)});break;case a instanceof Set:b=[],a.forEach(function(a){b.push(cast(a))});break;case Array.isArray(a):b=new Set,each(a,function(a){b.add(cast(a))});break;case a instanceof Object:b=new Map,each(Object.keys(a),function(c){b.set(c,cast(a[c]))});break;default:b=a}return b}function d(b){var c=void 0;try{c=new q([b],{type:"application/javascript"})}catch(d){a.BlobBuilder||(a.BlobBuilder=a.MSBlobBuilder||a.WebKitBlobBuilder||a.MozBlobBuilder),c=(new a.BlobBuilder).append(b).getBlob()}return c}function clone(a){return JSON.parse(JSON.stringify(a,null,0))}function e(a,b){return a.replace(t.querystring,"").replace(t.endslash,"")+(b?"/"+b:"")}function keyIndex(a,b,c,d){var e=void 0;return e=a.indexOf(c)>-1?a.split(c).sort(function(a,b){return a.localeCompare(b)}).map(function(a){return b[a].toString().replace(new RegExp(d,"g"),"").toLowerCase()}).join(c):b[a]}function f(a,b,c,d,e,f){a.forEach(function(a){var g=b.get(a),h=keyIndex(a,e,c,f),i=void 0;g.has(h)&&(i=g.get(h),i.delete(d),0===i.size&&(i=null,g.delete(h)))})}function createIndexes(a,b,d,e,f){var g={};return each(b,function(a){g[a]={}}),each(a,function(a){var h=a[d];void 0!==h&&b.forEach(function(b){var d=keyIndex(b,a,e,f);c(g[b],d)||(g[b][d]=[]),g[b][d].push(h)})}),g}function iterate(a,b){a instanceof Object?each(Object.keys(a),function(c){b.call(a,a[c],c)}):each(a,b)}function g(a,b){return a instanceof Object&&b instanceof Object?each(Object.keys(b),function(c){a[c]instanceof Object&&b[c]instanceof Object?a[c]=g(a[c],b[c]):Array.isArray(a[c])&&Array.isArray(b[c])?a[c]=a[c].concat(b[c]):a[c]=b[c]}):a=Array.isArray(a)&&Array.isArray(b)?a.concat(b):b,a}function joinData(a,b,c,d,e){function f(a,b,c){var f=arguments.length>3&&void 0!==arguments[3]&&arguments[3],g=arguments.length>4&&void 0!==arguments[4]&&arguments[4],k=Object.keys(b[0]),l=g?function(a,b){return a[d]===b[e]}:function(a,b){return a[e]===b[d]};each(a,function(a){var d={},g=b.filter(function(b){return l(b,a)}),m=!0;return g.length>1?(i=!0,j+=a[e],m=!1):1===g.length?each([a,g[0]],function(a,b){return iterate(a,function(a,e){d[c[b]+"_"+e]=a})}):f&&(iterate(a,function(a,b){d[c[0]+"_"+b]=a}),each(k,function(a){d[c[1]+"_"+a]=null})),m&&Object.keys(d).length>0&&h.push(d),m},!0)}var g=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"inner",h=[],i=!1,j="More than one record found on ";return"inner"===g&&f(b,c,a),"left"===g&&f(b,c,a,!0),"right"===g&&f(c,b,clone(a).reverse(),!0,!0),i?j:h}function h(a){var b=JSON.parse(a.data),c=b.cmd,d=void 0;"index"===c&&(d=createIndexes(b.records,b.index,b.key,b.delimiter,b.pattern)),"join"===c&&(d=joinData(b.ids,b.records[0],b.records[1],b.key,b.on,b.type)),postMessage(JSON.stringify(d))}function i(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",d=arguments.length>3&&void 0!==arguments[3]&&arguments[3],e=[];return d&&iterate(a,function(a,d){d!==c&&void 0===b[d]&&e.push({op:"remove",path:"/"+d})}),iterate(b,function(b,d){d!==c&&void 0===a[d]?e.push({op:"add",path:"/"+d,value:b}):JSON.stringify(a[d])!==JSON.stringify(b)&&e.push({op:"replace",path:"/"+d,value:b})}),e}function j(){return(65536*(Math.random()+1)|0).toString(16).substring(1)}function setIndexValue(a,b,c){a.has(b)||a.set(b,new Set),a.get(b).add(c)}function setIndex(a,b,c,d,e,f,g){each(f?[f]:a,function(a){var f=keyIndex(a,e,c,g);void 0!==f&&null!==f&&setIndexValue(b.get(a),f,d)})}function k(a){var b=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],c={};return a.forEach(function(a,d){var e=clone(a);b&&Object.freeze(e),c[clone(d)]=e}),b&&Object.freeze(c),c}function l(){return j()+j()+"-"+j()+"-4"+j().substr(0,3)+"-"+s[Math.floor(4*Math.random())]+j().substr(0,3)+"-"+j()+j()+j()}function m(){var b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},f=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],g=new Haro(b,e,f),i=void 0;if(u){i=[cast.toString(),clone.toString(),createIndexes.toString(),each.toString(),c.toString(),iterate.toString(),joinData.toString(),keyIndex.toString(),setIndexValue.toString(),setIndex.toString(),(n?"self.":"")+"onmessage = "+h.toString()+";"];try{g.worker=n?new Function(i.join("\n")):a.URL.createObjectURL(d(i.join("\n")))}catch(a){g.worker=null}}return g}var n="undefined"!=typeof process&&"function"==typeof process.nextTick,o=a.Promise,Map=a.Map,Set=a.Set,p=a.fetch||require("node-fetch"),q=a.Blob||require("Blob"),r=a.Worker||require("tiny-worker"),s=[8,9,"a","b"],t={querystring:/\?.*/,endslash:/\/$/},u="undefined"!=typeof q&&"undefined"!=typeof r,v="Web Worker not supported",w={},Haro=function(){function Haro(a){var b=this,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,Haro),this.adapters={},this.data=new Map,this.delimiter="|",this.config={method:"get",credentials:!1,headers:{accept:"application/json","content-type":"application/json"}},this.id=l(),this.index=[],this.indexes=new Map,this.key="",this.loading=!1,this.logging=!0,this.patch=!1,this.pattern="\\s*|\\t*",this.registry=[],this.source="",this.total=0,this.uri="",this.worker=null,this.versions=new Map,this.versioning=!0,each(Object.keys(c),function(a){b[a]=g(b[a],c[a])}),this.reindex(),a&&this.batch(a,"set")}return _createClass(Haro,[{key:"batch",value:function(a,c){function d(){o.all(a.map(l)).then(h.resolve,h.reject)}var f=this,g=arguments.length>2&&void 0!==arguments[2]&&arguments[2],h=b(),j="del"===c,k=void 0,l=void 0,m=void 0;return this.loading=!0,l=j?function(a){return f.del(a,!0)}:function(a){return f.set(null,a,!0,!0,g)},this.patch?(j?k=i(this.limit(0,this.total,!0).map(function(a){return a[f.key]}),a,this.key,!0):(k=[],m={},each(a,function(a){var b=a[f.key];b?m[b]=a:k.push({op:"add",path:"/",value:a})}),k=k.concat(i(this.toObject(void 0,!1),m,this.key,!0))),k.length>0?this.request(e(this.uri,null),{method:"patch",body:JSON.stringify(k)}).then(d,h.reject):h.resolve()):d(),h.promise.then(function(a){return f.loading=!1,f.onbatch(c,a),f.logging&&console.log("Batch inserted data into",f.id),a},function(a){throw f.loading=!1,f.onerror("batch",a),a})}},{key:"clear",value:function(){return this.total=0,this.registry.length=0,this.data.clear(),this.indexes.clear(),this.versions.clear(),this.reindex().onclear(),this.logging&&console.log("Cleared",this.id),this}},{key:"cmd",value:function(a){var c=b();if(this.adapters[a]&&w[a]){for(var d=arguments.length,e=Array(d>1?d-1:0),f=1;f<d;f++)e[f-1]=arguments[f];w[a].apply(this,[this].concat(e)).then(c.resolve,c.reject)}else c.reject(new Error(a+" not configured for persistent storage"));return c.promise}},{key:"crawl",value:function(a){var b=clone(a),c=clone(b);return each((this.source||"").split("."),function(a){c=c[a]}),c||b}},{key:"del",value:function(a){var c=this,d=arguments.length>1&&void 0!==arguments[1]&&arguments[1],g=b(),h=function(){var b=c.registry.indexOf(a);b>-1&&(0===b?c.registry.shift():b===c.registry.length-1?c.registry.pop():c.registry.splice(b,1),f(c.index,c.indexes,c.delimiter,a,c.data.get(a),c.pattern),c.data.delete(a),--c.total,c.versioning&&c.versions.delete(a),c.storage("remove",a).then(function(b){b&&c.logging&&console.log("Deleted",a,"from persistent storage")},function(b){c.logging&&console.error("Error deleting",a,"from persistent storage:",b.message||b.stack||b)})),g.resolve(a)};return this.data.has(a)?(d||(this.loading=!0),!d&&this.uri?this.patch?this.request(e(this.uri,null),{method:"patch",body:JSON.stringify([{op:"remove",path:"/"+a}])}).then(h,function(b){405===b[1]?(c.patch=!1,c.request(e(c.uri,a),{method:"delete"}).then(h,g.reject)):g.reject(b)}):this.request(e(this.uri,a),{method:"delete"}).then(h,g.reject):h()):g.reject(new Error("Record not found")),g.promise.then(function(a){return d||(c.loading=!1),c.ondelete(a),a},function(a){throw d||(c.loading=!1),c.onerror("delete",a),a})}},{key:"dump",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"records",b=void 0;return b="records"===a?this.toArray(null,!1):this.transform(this.indexes)}},{key:"entries",value:function(){return this.data.entries()}},{key:"find",value:function(a){var b=this,c=arguments.length>1&&void 0!==arguments[1]&&arguments[1],d=Object.keys(a).sort().join(this.delimiter),e=keyIndex(d,a,this.delimiter),f=[];return this.indexes.has(d)&&(this.indexes.get(d).get(e)||new Set).forEach(function(a){f.push(b.get(a,c))}),c?f:this.list.apply(this,f)}},{key:"filter",value:function(a){var b=this,c=arguments.length>1&&void 0!==arguments[1]&&arguments[1],d=[],e=void 0;return e=c?function(b,c){a(b,c)===!0&&d.push(b)}:function(c,e){a(c,e)===!0&&d.push(b.list(e,c))},this.forEach(e),c?d:this.list.apply(this,d)}},{key:"forEach",value:function(a,b){return this.data.forEach(function(b,c){a(clone(b),clone(c))},b),this}},{key:"get",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]&&arguments[1],c=clone(this.data.get(a)||null);return c&&!b?this.list(a,c):c}},{key:"has",value:function(a){return this.data.has(a)}},{key:"join",value:function(a){var c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.key,d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"inner",e=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],f=b(),g=void 0;return a.total>0?(g=e.length>0?this.offload([[this.id,a.id],this.find(e[0],!0),e[1]?a.find(e[1],!0):a.toArray(null,!0),this.key,c,d],"join"):this.offload([[this.id,a.id],this.toArray(null,!0),a.toArray(null,!0),this.key,c,d],"join"),g.then(function(a){"string"==typeof a?f.reject(new Error(a)):f.resolve(a)},f.reject)):f.resolve([]),f.promise}},{key:"keys",value:function(){return this.data.keys()}},{key:"limit",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,b=this,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,d=arguments.length>2&&void 0!==arguments[2]&&arguments[2],e=this.registry.slice(a,a+c).map(function(a){return b.get(a,d)});return d?e:this.list.apply(this,_toConsumableArray(e))}},{key:"list",value:function(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++)b[c]=arguments[c];return Object.freeze(b.map(function(a){return Object.freeze(clone(a))}))}},{key:"load",value:function(){var a=this,b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"mongo",c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,d=void 0===c,e=d?this.id:c;return d&&this.clear(),this.cmd(b,"get",c).then(function(f){return a.logging&&console.log("Loaded",e,"from",b,"persistent storage"),d?a.batch(f,"set",!0):a.set(c,f,!0,!0,!0)},function(c){throw a.logging&&console.error("Error loading",e,"from",b,"persistent storage:",c.message||c.stack||c),c})}},{key:"map",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]&&arguments[1],c=[];return this.forEach(function(b,d){c.push(a(b,d))}),b?c:this.list.apply(this,c)}},{key:"offload",value:function(a){var c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"index",d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.index,e=b(),f=void 0,g=void 0;return this.worker?(g=this.useWorker(e),g&&("index"===c&&(f={cmd:c,index:d,records:a,key:this.key,delimiter:this.delimiter,pattern:this.pattern}),"join"===c&&(f={cmd:c,ids:a[0],records:[a[1],a[2]],key:a[3],on:a[4],type:a[5]}),g.postMessage(JSON.stringify(f)))):e.reject(new Error(v)),e.promise}},{key:"onbatch",value:function(){}},{key:"onclear",value:function(){}},{key:"ondelete",value:function(){}},{key:"onerror",value:function(){}},{key:"onrequest",value:function(a){return a}},{key:"onset",value:function(){}},{key:"onsync",value:function(){}},{key:"override",value:function(a){var c=this,d=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"records",e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0,f=b();return"indexes"===d?(this.indexes=this.transform(a,e),f.resolve(!0)):"records"===d?(this.data.clear(),this.indexes.clear(),this.registry.length=0,a.forEach(function(a){var b=a[c.key]||l();c.data.set(b,a),c.registry.push(b)}),this.total=this.data.size,f.resolve(!0)):f.reject(new Error("Invalid type")),f.promise}},{key:"register",value:function(a,b){return w[a]=b,this}},{key:"reindex",value:function(a){var b=this;return a?(this.index.indexOf(a)===-1&&this.index.push(a),this.indexes.set(a,new Map),this.forEach(function(c,d){setIndex(b.index,b.indexes,b.delimiter,d,c,a,b.pattern)})):(this.indexes.clear(),this.index.forEach(function(a){b.indexes.set(a,new Map)}),this.forEach(function(a,c){b.index.forEach(function(d){setIndex(b.index,b.indexes,b.delimiter,c,a,d,b.pattern)})})),this}},{key:"request",value:function(a){var c=this,d=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},e=b(),f=g(clone(this.config),d);return f.method=f.method.toUpperCase(),p(a,f).then(function(a){var b=a.status,d=void 0;a.headers._headers?(d={},each(Object.keys(a.headers._headers),function(b){d[b]=a.headers._headers[b].join(", ")})):d=k(a.headers),a[a.headers.get("content-type").indexOf("application/json")>-1?"json":"text"]().then(function(a){e[b<200||b>=400?"reject":"resolve"](c.list(c.onrequest(a,b,d),b,d))},function(a){e.reject(c.list(a.message,b,d))})},function(a){e.reject(c.list(a.message,0,{}))}),e.promise}},{key:"save",value:function(){var a=this,b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"mongo";return this.cmd(b,"set").then(function(c){return a.logging&&console.log("Saved",a.id,"to",b,"persistent storage"),c},function(c){throw a.logging&&console.error("Error saving ",a.id,"to",b,"persistent storage:",c.message||c.stack||c),c})}},{key:"search",value:function(a,b){var c=this,d=arguments.length>2&&void 0!==arguments[2]&&arguments[2],e=[],f="function"==typeof a,g=a&&"function"==typeof a.test,h=new Set,i=void 0;return a&&(i=b?Array.isArray(b)?b:[b]:this.index,i.forEach(function(b){var i=c.indexes.get(b);i&&i.forEach(function(i,j){switch(!0){case f&&a(j,b):case g&&a.test(Array.isArray(j)?j.join(", "):j):case j===a:i.forEach(function(a){h.has(a)||(h.add(a),e.push(c.get(a,d)))})}})})),d?e:this.list.apply(this,e)}},{key:"set",value:function(a,c){var d=arguments.length>2&&void 0!==arguments[2]&&arguments[2],h=this,j=arguments.length>3&&void 0!==arguments[3]&&arguments[3],k=arguments.length>4&&void 0!==arguments[4]&&arguments[4],m=b(),n="post",o=clone(c),p=a,q=void 0,r=void 0,s=void 0,t=function(a){var b=a?a[0]:{};null===p&&(h.key?(b=h.crawl(b),p=b[h.key]||o[h.key]||l()):p=l()),"post"===n?(h.registry[h.total]=p,++h.total,h.versioning&&h.versions.set(p,new Set)):(h.versioning&&h.versions.get(p).add(h.list(r)),f(h.index,h.indexes,h.delimiter,p,r,h.pattern)),h.data.set(p,o),setIndex(h.index,h.indexes,h.delimiter,p,o,null,h.pattern),m.resolve(h.get(p)),k||h.storage("set",p,o).then(function(a){a&&h.logging&&console.log("Saved",p,"to persistent storage")},function(a){h.logging&&console.error("Error saving",p,"to persistent storage:",a.message||a.stack||a)})};return void 0!==p&&null!==p||(p=o[this.key]||null),p&&this.data.has(p)&&(n="put",r=clone(this.data.get(p)||{}),j||(o=g(r,o))),d||(this.loading=!0),!d&&this.uri?(s=e(this.uri,p),this.patch?(q="post"===n?[{op:"add",path:"/",value:o}]:j?[{op:"replace",path:"/",value:o}]:i(r,o,this.key),this.request(s,{method:"patch",body:JSON.stringify(q,null,0)}).then(t,function(a){405===a[1]?(h.patch=!1,h.request(s,{method:n,body:JSON.stringify(o,null,0)}).then(t,m.reject)):m.reject(a)})):this.request(s,{method:n,body:JSON.stringify(o)}).then(t,m.reject)):t(),m.promise.then(function(a){return d||(h.loading=!1),h.onset(a),a},function(a){throw d||(h.loading=!1),h.onerror("set",a),a})}},{key:"setUri",value:function(a){var c=arguments.length>1&&void 0!==arguments[1]&&arguments[1],d=b();return this.uri=a,this.uri?this.sync(c).then(d.resolve,d.reject):d.resolve([]),d.promise}},{key:"sort",value:function(a){var b=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],c=void 0;return c=b?Object.freeze(this.limit(0,this.total,!0).sort(a).map(function(a){return Object.freeze(a)})):this.limit(0,this.total,!0).sort(a)}},{key:"sortBy",value:function(a){var b=this,c=arguments.length>1&&void 0!==arguments[1]&&arguments[1],d=[],e=[],f=void 0;return this.indexes.has(a)||this.reindex(a),f=this.indexes.get(a),f.forEach(function(a,b){e.push(b)}),each(e.sort(),function(a){f.get(a).forEach(function(a){d.push(b.get(a,c))})}),c?d:this.list.apply(this,d)}},{key:"storage",value:function(){for(var a=this,c=arguments.length,d=Array(c),e=0;e<c;e++)d[e]=arguments[e];var f=b(),g=Object.keys(this.adapters).map(function(b){return a.cmd.apply(a,[b].concat(d))});return g.length>0?o.all(g).then(function(){f.resolve(!0)},f.reject):f.resolve(!1),f.promise}},{key:"sync",value:function(){var a=this,c=arguments.length>0&&void 0!==arguments[0]&&arguments[0],d=b(),e=!0;return this.request(this.uri).then(function(b){var f=void 0;a.patch=(b[2].Allow||b[2].allow||"").indexOf("PATCH")>-1;try{f=a.crawl(b[0])}catch(a){e=!1,d.reject(a)}e&&(c&&a.clear(),a.batch(f,"set").then(d.resolve,d.reject))},function(a){d.reject(a[0]||a)}),d.promise.then(function(b){return a.onsync(b),b},function(b){throw a.onerror("sync",b),b})}},{key:"toArray",value:function(a){var b=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],c=void 0;return a?c=a.map(function(a){return b?a[1]:clone(a[1])}):(c=this.limit(0,this.total,!0),b&&each(c,function(a){Object.freeze(a)})),b?Object.freeze(c):c}},{key:"toObject",value:function(a){var b=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],c=void 0;return c=a?a.reduce(function(a,c){var d=clone(c[1]);return b&&Object.freeze(d),a[c[0]]=d,a},{}):k(this,b),b&&Object.freeze(c),c}},{key:"transform",value:function(a,b){return"function"==typeof b?b(a):cast(a)}},{key:"unload",value:function(){var a=this,b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"mongo",c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,d=void 0!==c?c:this.id;return this.cmd(b,"remove",c).then(function(c){return a.logging&&console.log("Unloaded",d,"from",b,"persistent storage"),c},function(c){throw a.logging&&console.error("Error unloading",d,"from",b,"persistent storage:",c.message||c.stack||c),c})}},{key:"unregister",value:function(a){delete w[a]}},{key:"values",value:function(){return this.data.values()}},{key:"useWorker",value:function(a){var b=void 0;return this.worker?(b=new r(this.worker),b.onerror=function(c){a.reject(c),b.terminate()},b.onmessage=function(c){a.resolve(JSON.parse(c.data)),b.terminate()}):a.reject(new Error(v)),b}}]),Haro}();m.transform=cast,m.version="3.1.0","undefined"!=typeof exports?module.exports=m:"function"==typeof define&&define.amd?define(function(){return m}):a.haro=m}("undefined"!=typeof window?window:global);
//# sourceMappingURL=haro.min.js.map