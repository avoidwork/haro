/*
 2018 Jason Mulligan <jason.mulligan@avoidwork.com>
 @version 4.0.1
*/
"use strict";(function(a){function b(c,a){return a in c}function d(a,b,c=!1){const d=a.length;let e=-1;if(c)for(;++e<d&&!1!==b(a[e],e););else for(;++e<d;)b(a[e],e)}function c(a){let b;switch(!0){case a instanceof x:b={},a.forEach((a,d)=>{b[d]=c(a)});break;case a instanceof y:b=Array.from(a);break;case Array.isArray(a):b=new y,d(a,(a)=>b.add(c(a)));break;case a instanceof Object:b=new x,d(Object.keys(a),(d)=>b.set(d,c(a[d])));break;default:b=a;}return b}function e(a){return new A([a],{type:"application/javascript"})}function f(a){return JSON.parse(JSON.stringify(a,null,0))}function g(a,b){return a.replace(r.querystring,"").replace(r.endslash,"")+(b?"/"+b:"")}function h(a,b,c,d){let e;return e=-1<a.indexOf(c)?a.split(c).sort((c,a)=>c.localeCompare(a)).map((a)=>b[a].toString().replace(new RegExp(d,"g"),"").toLowerCase()).join(c):b[a],e}function i(a,b,c,d,e,f){a.forEach((a)=>{const g=b.get(a),i=h(a,e,c,f);let j;g.has(i)&&(j=g.get(i),j.delete(d),0===j.size&&g.delete(i))})}function j(a,c,e,f,g){const j={};return d(c,(a)=>{j[a]={}}),d(a,(a)=>{const d=a[e];void 0!==d&&c.forEach((c)=>{const e=h(c,a,f,g);b(j[c],e)||(j[c][e]=[]),j[c][e].push(d)})}),j}function k(a,b){a instanceof Object?d(Object.keys(a),(c)=>b.call(a,a[c],c)):d(a,b)}function l(c,a){return c instanceof Object&&a instanceof Object?d(Object.keys(a),(b)=>{c[b]=c[b]instanceof Object&&a[b]instanceof Object?l(c[b],a[b]):Array.isArray(c[b])&&Array.isArray(a[b])?c[b].concat(a[b]):a[b]}):Array.isArray(c)&&Array.isArray(a)?c=c.concat(a):c=a,c}function m(c,e,a,b,g,h="inner"){function i(a,e,c,f=!1,h=!1){const n=Object.keys(e[0]),o=h?(a,c)=>a[b]===c[g]:(a,c)=>a[g]===c[b];d(a,(a)=>{const b={},h=e.filter((b)=>o(b,a));let i=!0;return 1<h.length?(l=!0,m+=a[g],i=!1):1===h.length?d([a,h[0]],(a,d)=>k(a,(a,e)=>{b[c[d]+"_"+e]=a})):f&&(k(a,(a,d)=>{b[c[0]+"_"+d]=a}),d(n,(a)=>{b[c[1]+"_"+a]=null})),i&&0<Object.keys(b).length&&j.push(b),i},!0)}const j=[];let l=!1,m="More than one record found on ";return"inner"===h&&i(e,a,c),"left"===h&&i(e,a,c,!0),"right"===h&&i(a,e,f(c).reverse(),!0,!0),l?m:j}function n(a){const b=JSON.parse(a.data),c=b.cmd;let d;"index"===c&&(d=j(b.records,b.index,b.key,b.delimiter,b.pattern)),"join"===c&&(d=m(b.ids,b.records[0],b.records[1],b.key,b.on,b.type)),postMessage(JSON.stringify(d))}function o(a={},b={},c="",d=!1){const e=[];return d&&k(a,(a,d)=>{d!==c&&void 0===b[d]&&e.push({op:"remove",path:"/"+d})}),k(b,(b,d)=>{d!==c&&void 0===a[d]?e.push({op:"add",path:"/"+d,value:b}):JSON.stringify(a[d])!==JSON.stringify(b)&&e.push({op:"replace",path:"/"+d,value:b})}),e}function p(){return(0|65536*(Math.random()+1)).toString(16).substring(1)}function q(a,b,c,e,f,g,j){d(g?[g]:a,(a)=>{let d,g=h(a,f,c,j);g!==void 0&&null!==g&&(d=b.get(a),!d.has(g)&&d.set(g,new y),d.get(g).add(e))})}function s(a,b=!0){const c={};return a.forEach((a,d)=>{const e=a;b&&Object.freeze(e),c[f(d)]=e}),b&&Object.freeze(c),c}function t(){return p()+p()+"-"+p()+"-4"+p().substr(0,3)+"-"+C[Math.floor(4*Math.random())]+p().substr(0,3)+"-"+p()+p()+p()}function u(g=null,i={}){const l=new G(i).reindex();if(D){const g=[c.toString(),f.toString(),j.toString(),d.toString(),b.toString(),k.toString(),m.toString(),h.toString(),q.toString(),(!1===v?"":"self.")+"onmessage = "+n.toString()+";"];l.worker=!1===v?a.URL.createObjectURL(e(g.join("\n"))):new Function(g.join("\n"))}return g&&l.batch(g,"set"),l}const v="undefined"!=typeof process&&"function"==typeof process.nextTick,w=a.Promise,x=a.Map,y=a.Set,z=a.fetch||(v?require("node-fetch"):void 0),A=a.Blob,B=a.Worker||(v?require("tiny-worker"):void 0),C=[8,9,"a","b"],r={querystring:/\?.*/,endslash:/\/$/},D="undefined"!=typeof B,E="Web Worker not supported",F={};class G{constructor({config:a={},debounce:b=0,delimiter:c="|",id:d=t(),index:e=[],key:f="",logging:g=!0,patch:h=!1,pattern:i="\\s*|\\t*",source:j="",versioning:k=!1}={}){this.adapters={},this.data=new x,this.debounce=b,this.debounced=new x,this.delimiter=c,this.config={method:"get",credentials:"include",headers:{accept:"application/json","content-type":"application/json"}},this.id=d,this.index=e,this.indexes=new x,this.key=f,this.logging=g,this.patch=h,this.pattern=i,this.source=j,this.total=0,this.uri="",this.worker=null,this.versions=new x,this.versioning=k,Object.defineProperty(this,"registry",{enumerable:!0,get:()=>Array.from(this.data.keys())}),1<Object.keys(a).length&&(this.config=l(this.config,a))}async batch(a,b="set",c=!1){let d;this.beforeBatch(a,b);try{const e="del"===b?(a)=>this.del(a,!0,c):(a)=>this.set(null,a,!0,!0,c);d=await w.all(a.map(e)),this.onbatch(b,d),this.log(`Batch successful on ${this.id}`)}catch(a){throw this.onerror("batch",a),this.log(`Batch failure on ${this.id}`),a}return d}beforeBatch(){}beforeClear(){}beforeDelete(){}beforeRequest(){}beforeSet(){}beforeSync(){}clear(){return this.beforeClear(),this.total=0,this.data.clear(),this.indexes.clear(),this.versions.clear(),this.reindex().onclear(),this.log(`Cleared ${this.id}`),this}async cmd(a,...b){if(void 0===this.adapters[a]||void 0===F[a])throw new Error(`${a} not configured for persistent storage`);return await F[a].apply(this,[this,...b])}crawl(a){let b=f(a);return d((this.source||"").split("."),(a)=>{b=b[a]}),b||a}del(a,b=!1,c=!1,d=!1){const e=this.get(a,!0);return new w((f,g)=>{e?(this.beforeDelete(a,b,c,d),i(this.index,this.indexes,this.delimiter,a,e,this.pattern),this.data.delete(a),--this.total,f(a)):g(new Error("Record not found"))}).then((f)=>(this.ondelete(f,b,d,c),this.versioning&&this.versions.delete(a),c||(this.storage("remove",a).then((b)=>{b&&this.log(`Deleted ${a} from persistent storage`)},(b)=>this.log(`Error deleting ${a} from persistent storage: ${b.message||b.stack||b}`,"error")),!b&&!d&&this.uri&&(this.debounced.has(a)&&clearTimeout(this.debounced.get(a)),this.debounced.set(a,setTimeout(async()=>{this.debounced.delete(a);try{await this.transmit(a,null,e,!1,"delete")}catch(b){this.log(b.stack||b.message||b,"error");try{await this.set(a,e,!0,!0),this.log(`Reverted ${a}`)}catch(b){this.log(`Failed to revert ${a}`)}}},this.debounce)))),f),(a)=>{throw this.onerror("delete",a),a})}dump(a="records"){return"records"===a?this.toArray(null,!1):this.transform(this.indexes)}entries(){return this.data.entries()}find(a,b=!1){const c=Object.keys(a).sort((c,a)=>c.localeCompare(a)).join(this.delimiter),d=h(c,a,this.delimiter,this.pattern),e=[];return this.indexes.has(c)&&(this.indexes.get(c).get(d)||new y).forEach((a)=>e.push(this.get(a,b))),b?e:this.list(...e)}filter(a,b=!1){const c=[];return this.forEach((d,e)=>{!0===a(d,e)&&c.push(this.get(e,b))},this),b?c:this.list(...c)}forEach(a,b){return this.data.forEach((b,c)=>a(f(b),f(c)),b||this.data),this}get(a,b=!1){const c=f(this.data.get(a)||null);return c&&!b?this.list(a,c):c}has(a,b){return(b||this.data).has(a)}async join(a,b,c="inner",d=[]){let e;if(!(0<a.total))e=[];else if(e=0<d.length?await this.offload([[this.id,a.id],this.find(d[0],!0),d[1]?a.find(d[1],!0):a.toArray(null,!0),this.key,b||this.key,c],"join"):await this.offload([[this.id,a.id],this.toArray(null,!0),a.toArray(null,!0),this.key,b||this.key,c],"join"),"string"==typeof arg)throw new Error(e);return e}keys(){return this.data.keys()}limit(a=0,b=0,c=!1){const d=this.registry.slice(a,a+b).map((a)=>this.get(a,c));return c?d:this.list(...d)}list(...a){return Object.freeze(a.map((a)=>Object.freeze(a)))}async load(a="mongo",b=void 0){const c=b===void 0,d=c?this.id:b;let e;c&&this.clear();try{const f=await this.cmd(a,"get",b);e=c?this.batch(f,"set",!0):this.set(b,f,!0,!0,!0),this.log(`Loaded ${d} from ${a} persistent storage`)}catch(b){throw this.log(`Error loading ${d} from ${a} persistent storage: ${b.message||b.stack||b}`,"error"),b}return e}log(a="",b="log"){this.logging&&console[b](`haro: ${a}`)}map(a,b=!1){const c=[];return this.forEach((b,d)=>c.push(a(b,d))),b?c:this.list(...c)}async offload(a,b="index",c=this.index){return new w((d,e)=>{if(this.worker){const f=this.useWorker(d,e);let g;"index"===b?g={cmd:b,index:c,records:a,key:this.key,delimiter:this.delimiter,pattern:this.pattern}:"join"===b&&(g={cmd:b,ids:a[0],records:[a[1],a[2]],key:a[3],on:a[4],type:a[5]}),f.postMessage(JSON.stringify(g,null,0))}else e(new Error(E))})}onbatch(){}onclear(){}ondelete(){}onerror(){}onrequest(a){return a}onset(){}onsync(){}async override(a,b="records",c=void 0){if("indexes"===b)this.indexes=this.transform(a,c);else if("records"===b)this.data.clear(),this.indexes.clear(),d(a,(a)=>this.data.set(this.key?a[this.key]:t()||t(),a)),this.total=this.data.size;else throw new Error("Invalid type");return!0}register(a,b){return F[a]=b,this}reindex(a){const b=a?[a]:this.index;return a&&-1===this.index.indexOf(a)&&this.index.push(a),d(b,(a)=>this.indexes.set(a,new x)),this.forEach((a,c)=>d(b,(b)=>q(this.index,this.indexes,this.delimiter,c,a,b,this.pattern))),this}async request(a,b={}){return new w(async(c,g)=>{const e=l(f(this.config),b),h={};e.method=e.method.toUpperCase(),"DELETE"===e.method&&delete e.body,this.beforeRequest(...[a,e]);try{const b=await z(a,e),f=b.ok,i=b.status;if(b.headers._headers)d(Object.keys(b.headers._headers),(a)=>{h[a]=b.headers._headers[a].join(", ")});else for(const a of b.headers.entries())h[a[0]]=a[1];const j=await b[-1<(h["content-type"]||"").indexOf("application/json")?"json":"text"](),k=f?c:g;k(this.list(this.onrequest(j,i,h),i,h))}catch(a){g(this.list(a.message,0,{}))}})}async save(a="mongo"){let b;try{b=await this.cmd(a,"set"),this.log(`Saved ${this.id} to ${a} persistent storage`)}catch(b){throw this.log(`Error saving ${this.id} to ${a} persistent storage: ${b.message||b.stack||b}`,"error"),b}return b}search(a,b,c=!1){const e=new x,f=a&&"function"==typeof a.test;return a&&d(b?Array.isArray(b)?b:[b]:this.index,(b)=>{let d=this.indexes.get(b);d&&d.forEach((d,g)=>{switch(!0){case"function"==typeof a&&a(g,b):case f&&a.test(Array.isArray(g)?g.join(", "):g):case g===a:d.forEach((a)=>{!e.has(a)&&this.has(a)&&e.set(a,this.get(a,c))});break;default:}})}),c?Array.from(e.values()):this.list(...Array.from(e.values()))}async set(a,b,c=!1,d=!1,e=!1,g=!1){let h,j,k=f(b);return new w((m)=>{(a===void 0||null===a)&&(a=this.key&&k[this.key]!==void 0?k[this.key]:t()),this.beforeSet(a,b,c,d,e,g),this.data.has(a)?(j=this.get(a,!0),i(this.index,this.indexes,this.delimiter,a,j,this.pattern),h="put",this.versioning&&this.versions.get(a).add(Object.freeze(f(j))),!1===d&&(k=l(f(j),k))):(++this.total,h="post",this.versioning&&this.versions.set(a,new y)),this.data.set(a,k),q(this.index,this.indexes,this.delimiter,a,k,null,this.pattern),m(this.get(a))}).then((b)=>(this.onset(b,c,g,e),e||(this.storage("set",a,k).then((b)=>{b&&this.log(`Saved ${a} to persistent storage`)},(b)=>this.log(`Error saving ${a} to persistent storage: ${b.message||b.stack||b}`,"error")),!c&&!g&&this.uri&&(this.debounced.has(a)&&clearTimeout(this.debounced.get(a)),this.debounced.set(a,setTimeout(async()=>{this.debounced.delete(a);try{if(await this.transmit(a,k,j,d,h),j)try{await this.set(a,j,c,!0,e,!0),this.log(`Reverted ${a}`)}catch(b){this.log(`Failed to revert ${a}`)}else try{await this.del(a,!0),this.log(`Reverted ${a}`)}catch(b){this.log(`Failed to revert ${a}`)}}catch(a){this.log(a.stack||a.message||a,"error")}},this.debounce)))),b),(a)=>{throw this.onerror("set",a),a})}async setUri(a,b=!1){return this.uri=a,""===this.uri?[]:await this.sync(b)}sort(a,b=!0){return b?Object.freeze(this.limit(0,this.total,!0).sort(a).map((a)=>Object.freeze(a))):this.limit(0,this.total,!0).sort(a)}sortBy(a,b=!1){const c=[],e=[];let f;return this.indexes.has(a)||this.reindex(a),f=this.indexes.get(a),f.forEach((a,b)=>e.push(b)),d(e.sort(),(a)=>f.get(a).forEach((a)=>c.push(this.get(a,b)))),b?c:this.list(...c)}async storage(...a){let b;try{const c=Object.keys(this.adapters).map(async(b)=>await this.cmd.apply(this,[b,...a]));0<c.length?(await w.all(c),b=!0):b=!1}catch(a){throw this.log(a.stack||a.message||a,"error"),a}return b}async sync(a=!1){let b;this.beforeSync(this.uri,a);try{const c=await this.request(this.uri),d=this.source?this.crawl(c[0]):c[0];this.patch=(c[2].Allow||c[2].allow||"").includes("PATCH"),a&&this.clear(),b=await this.batch(d,"set"),this.onsync(b)}catch(a){throw this.onerror("sync",a[0]||a),a[0]||a}return b}toArray(a,b=!0){let c;return a?c=a.map((a)=>b?a[1]:f(a[1])):(c=this.limit(0,this.total,!0),b&&d(c,(a)=>Object.freeze(a))),b?Object.freeze(c):c}toObject(a,c=!0){const b=a?a.reduce((d,a)=>{const b=f(a[1]);return c&&Object.freeze(b),d[a[0]]=b,d},{}):s(this,c);return c?Object.freeze(b):b}transform(a,b){return"function"==typeof b?b(a):c(a)}async transmit(a,b,c,d=!1,f="post"){const h=g(this.uri,b?a:null);let e,i;if(this.patch){e=void 0===b?[{op:"remove",path:"/",value:a}]:void 0===c?[{op:"add",path:"/",value:b}]:d?[{op:"replace",path:"/",value:b}]:o(c,b,this.key);try{i=await this.request(h,{method:"patch",body:JSON.stringify(e,null,0)})}catch(c){if(405===c[1])this.patch=!1,i=await this.request(b?h:g(this.uri,a),{method:f,body:JSON.stringify(b,null,0)});else throw c}}else i=await this.request(h,{method:f,body:JSON.stringify(b,null,0)});return i}async unload(a="mongo",b=void 0){const c=b===void 0?this.id:b;let d;try{d=await this.cmd(a,"remove",b),this.log(`Unloaded ${c} from ${a} persistent storage`)}catch(b){throw this.log(`Error unloading ${c} from ${a} persistent storage: ${b.message||b.stack||b}`,"error"),b}return d}unregister(a){delete F[a]}values(){return this.data.values()}useWorker(a,b){let c;return this.worker?(c=new B(this.worker),c.onerror=(a)=>{b(a),c.terminate()},c.onmessage=(b)=>{a(JSON.parse(b.data)),c.terminate()}):b(new Error(E)),c}}u.transform=c,u.version="4.0.1","undefined"==typeof exports?"function"==typeof define&&void 0!==define.amd?define(()=>u):a.haro=u:module.exports=u})("undefined"==typeof window?global:window);
//# sourceMappingURL=haro.min.js.map