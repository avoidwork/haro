/* 2018 Jason Mulligan <jason.mulligan@avoidwork.com> */

"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(e){var t="undefined"!=typeof process&&"function"==typeof process.nextTick,n=e.Promise,r=e.Map,o=e.Set,i=e.fetch||(t?require("node-fetch"):void 0),s=e.Blob,a=e.Worker||(t?require("tiny-worker"):void 0),u=[8,9,"a","b"],c={querystring:/\?.*/,endslash:/\/$/},l=void 0!==a,f="Web Worker not supported",d={};function h(e,t){return t in e}function g(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=e.length,o=-1;if(n)for(;++o<r&&!1!==t(e[o],o););else for(;++o<r;)t(e[o],o)}function v(e){var t=void 0;switch(!0){case e instanceof r:t={},e.forEach(function(e,n){t[n]=v(e)});break;case e instanceof o:t=Array.from(e);break;case Array.isArray(e):t=new o,g(e,function(e){return t.add(v(e))});break;case e instanceof Object:t=new r,g(Object.keys(e),function(n){return t.set(n,v(e[n]))});break;default:t=e}return t}function y(e){return JSON.parse(JSON.stringify(e,null,0))}function p(e,t){return e.replace(c.querystring,"").replace(c.endslash,"")+(t?"/"+t:"")}function k(e,t,n,r){return e.indexOf(n)>-1?e.split(n).sort(function(e,t){return e.localeCompare(t)}).map(function(e){return t[e].toString().replace(new RegExp(r,"g"),"").toLowerCase()}).join(n):t[e]}function m(e,t,n,r,o,i){e.forEach(function(e){var s=t.get(e),a=k(e,o,n,i),u=void 0;s.has(a)&&((u=s.get(a)).delete(r),0===u.size&&s.delete(a))})}function b(e,t,n,r,o){var i={};return g(t,function(e){i[e]={}}),g(e,function(e){var s=e[n];void 0!==s&&t.forEach(function(t){var n=k(t,e,r,o);h(i[t],n)||(i[t][n]=[]),i[t][n].push(s)})}),i}function w(e,t){e instanceof Object?g(Object.keys(e),function(n){return t.call(e,e[n],n)}):g(e,t)}function j(e,t){return e instanceof Object&&t instanceof Object?g(Object.keys(t),function(n){e[n]instanceof Object&&t[n]instanceof Object?e[n]=j(e[n],t[n]):Array.isArray(e[n])&&Array.isArray(t[n])?e[n]=e[n].concat(t[n]):e[n]=t[n]}):e=Array.isArray(e)&&Array.isArray(t)?e.concat(t):t,e}function x(e,t,n,r,o){var i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"inner",s=[],a=!1,u="More than one record found on ";function c(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],c=arguments.length>4&&void 0!==arguments[4]&&arguments[4],l=Object.keys(t[0]),f=c?function(e,t){return e[r]===t[o]}:function(e,t){return e[o]===t[r]};g(e,function(e){var r={},c=t.filter(function(t){return f(t,e)}),d=!0;return c.length>1?(a=!0,u+=e[o],d=!1):1===c.length?g([e,c[0]],function(e,t){return w(e,function(e,o){r[n[t]+"_"+o]=e})}):i&&(w(e,function(e,t){r[n[0]+"_"+t]=e}),g(l,function(e){r[n[1]+"_"+e]=null})),d&&Object.keys(r).length>0&&s.push(r),d},!0)}return"inner"===i&&c(t,n,e),"left"===i&&c(t,n,e,!0),"right"===i&&c(n,t,y(e).reverse(),!0,!0),a?u:s}function O(){return(65536*(Math.random()+1)|0).toString(16).substring(1)}function A(e,t,n,r,i,s,a){g(s?[s]:e,function(e){var s=k(e,i,n,a),u=void 0;void 0!==s&&null!==s&&((u=t.get(e)).has(s)||u.set(s,new o),u.get(s).add(r))})}function E(){return O()+O()+"-"+O()+"-4"+O().substr(0,3)+"-"+u[Math.floor(4*Math.random())]+O().substr(0,3)+"-"+O()+O()+O()}var S=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.config,o=void 0===n?{}:n,i=t.debounce,s=void 0===i?0:i,a=t.delimiter,u=void 0===a?"|":a,c=t.id,l=void 0===c?E():c,f=t.index,d=void 0===f?[]:f,h=t.key,g=void 0===h?"":h,v=t.logging,y=void 0===v||v,p=t.patch,k=void 0!==p&&p,m=t.pattern,b=void 0===m?"\\s*|\\t*":m,w=t.source,x=void 0===w?"":w,O=t.versioning,A=void 0!==O&&O;_classCallCheck(this,e),this.adapters={},this.data=new r,this.debounce=s,this.debounced=new r,this.delimiter=u,this.config={method:"get",credentials:"include",headers:{accept:"application/json","content-type":"application/json"}},this.id=l,this.index=d,this.indexes=new r,this.key=g,this.logging=y,this.patch=k,this.pattern=b,this.source=x,this.total=0,this.uri="",this.worker=null,this.versions=new r,this.versioning=A,Object.defineProperty(this,"registry",{get:function(){return Array.from(this.data.keys())}}),Object.keys(o).length>1&&(this.config=j(this.config,o))}return _createClass(e,[{key:"batch",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"set",o=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return new n(function(i,s){var a="del"===r?function(e){return t.del(e,!0,o)}:function(e){return t.set(null,e,!0,!0,o)};t.beforeBatch(e,r),n.all(e.map(a)).then(i,s)}).then(function(e){return t.onbatch(r,e),t.logging&&console.log("Batch successful on "+t.id),e},function(e){throw t.onerror("batch",e),t.logging&&console.log("Batch failure on "+t.id),e})}},{key:"beforeBatch",value:function(){}},{key:"beforeClear",value:function(){}},{key:"beforeDelete",value:function(){}},{key:"beforeRequest",value:function(){}},{key:"beforeSet",value:function(){}},{key:"beforeSync",value:function(){}},{key:"clear",value:function(){return this.beforeClear(),this.total=0,this.data.clear(),this.indexes.clear(),this.versions.clear(),this.reindex().onclear(),this.logging&&console.log("Cleared "+this.id),this}},{key:"cmd",value:function(e){for(var t=this,r=arguments.length,o=Array(r>1?r-1:0),i=1;i<r;i++)o[i-1]=arguments[i];return new n(function(n,r){t.adapters[e]&&d[e]?d[e].apply(t,[t].concat(o)).then(n,r):r(new Error(e+" not configured for persistent storage"))})}},{key:"crawl",value:function(e){var t=y(e);return g((this.source||"").split("."),function(e){t=t[e]}),t||e}},{key:"del",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this,o=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=this.get(e,!0);return new n(function(n,a){s?(r.beforeDelete(e,t,o,i),m(r.index,r.indexes,r.delimiter,e,s,r.pattern),r.data.delete(e),--r.total,n(e)):a(new Error("Record not found"))}).then(function(n){return r.ondelete(n,t,i,o),r.versioning&&r.versions.delete(e),o||(r.storage("remove",e).then(function(t){t&&r.logging&&console.log("Deleted "+e+" from persistent storage")},function(t){r.logging&&console.error("Error deleting "+e+" from persistent storage: "+(t.message||t.stack||t))}),t||i||!r.uri||(r.debounced.has(e)&&clearTimeout(r.debounced.get(e)),r.debounced.set(e,setTimeout(function(){r.debounced.delete(e),r.transmit(e,null,s,!1,"delete").catch(function(t){r.logging&&console.error(t.stack||t.message||t),r.set(e,s,!0,!0).then(function(){r.logging&&console.log("Reverted "+e)}).catch(function(){r.logging&&console.log("Failed to revert "+e)})})},r.debounce)))),n},function(e){throw r.onerror("delete",e),e})}},{key:"dump",value:function(){return"records"===(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"records")?this.toArray(null,!1):this.transform(this.indexes)}},{key:"entries",value:function(){return this.data.entries()}},{key:"find",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=Object.keys(e).sort(function(e,t){return e.localeCompare(t)}).join(this.delimiter),i=k(r,e,this.delimiter,this.pattern),s=[];return this.indexes.has(r)&&(this.indexes.get(r).get(i)||new o).forEach(function(e){return s.push(t.get(e,n))}),n?s:this.list.apply(this,s)}},{key:"filter",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=[];return this.forEach(function(o,i){!0===e(o,i)&&r.push(t.get(i,n))},this),n?r:this.list.apply(this,r)}},{key:"forEach",value:function(e,t){return this.data.forEach(function(t,n){return e(y(t),y(n))},t||this.data),this}},{key:"get",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=y(this.data.get(e)||null);return n&&!t?this.list(e,n):n}},{key:"has",value:function(e,t){return(t||this.data).has(e)}},{key:"join",value:function(e,t){var r=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"inner",i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];return new n(function(n,s){e.total>0?(i.length>0?r.offload([[r.id,e.id],r.find(i[0],!0),i[1]?e.find(i[1],!0):e.toArray(null,!0),r.key,t||r.key,o],"join"):r.offload([[r.id,e.id],r.toArray(null,!0),e.toArray(null,!0),r.key,t||r.key,o],"join")).then(function(e){"string"==typeof e?s(new Error(e)):n(e)},s):n([])})}},{key:"keys",value:function(){return this.data.keys()}},{key:"limit",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=this.registry.slice(e,e+n).map(function(e){return t.get(e,r)});return r?o:this.list.apply(this,_toConsumableArray(o))}},{key:"list",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return Object.freeze(t.map(function(e){return Object.freeze(e)}))}},{key:"load",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"mongo",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,r=void 0===n,o=r?this.id:n;return r&&this.clear(),this.cmd(t,"get",n).then(function(i){return e.logging&&console.log("Loaded "+o+" from "+t+" persistent storage"),r?e.batch(i,"set",!0):e.set(n,i,!0,!0,!0)},function(n){throw e.logging&&console.error("Error loading "+o+" from "+t+" persistent storage: "+(n.message||n.stack||n)),n})}},{key:"map",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=[];return this.forEach(function(t,r){return n.push(e(t,r))}),t?n:this.list.apply(this,n)}},{key:"offload",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"index",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.index;return new n(function(n,i){if(t.worker){var s=t.useWorker(n,i);if(s){var a=void 0;"index"===r&&(a={cmd:r,index:o,records:e,key:t.key,delimiter:t.delimiter,pattern:t.pattern}),"join"===r&&(a={cmd:r,ids:e[0],records:[e[1],e[2]],key:e[3],on:e[4],type:e[5]}),s.postMessage(JSON.stringify(a,null,0))}else i(new Error(f))}else i(new Error(f))})}},{key:"onbatch",value:function(){}},{key:"onclear",value:function(){}},{key:"ondelete",value:function(){}},{key:"onerror",value:function(){}},{key:"onrequest",value:function(e){return e}},{key:"onset",value:function(){}},{key:"onsync",value:function(){}},{key:"override",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"records",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;return new n(function(n,i){"indexes"===r?(t.indexes=t.transform(e,o),n(!0)):"records"===r?(t.data.clear(),t.indexes.clear(),g(e,function(e){var n=t.key?e[t.key]:E()||E();t.data.set(n,e)}),t.total=t.data.size,n(!0)):i(new Error("Invalid type"))})}},{key:"register",value:function(e,t){return d[e]=t,this}},{key:"reindex",value:function(e){var t=this,n=e?[e]:this.index;return e&&-1===this.index.indexOf(e)&&this.index.push(e),g(n,function(e){return t.indexes.set(e,new r)}),this.forEach(function(e,r){return g(n,function(n){return A(t.index,t.indexes,t.delimiter,r,e,n,t.pattern)})}),this}},{key:"request",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new n(function(n,o){var s=j(y(t.config),r),a=[e,s];s.method=s.method.toUpperCase(),"DELETE"===s.method&&delete s.body,t.beforeRequest.apply(t,a),i(e,s).then(function(e){var r=e.status,i=e.ok,s={};if(e.headers._headers)g(Object.keys(e.headers._headers),function(t){s[t]=e.headers._headers[t].join(", ")});else{var a=!0,u=!1,c=void 0;try{for(var l,f=e.headers.entries()[Symbol.iterator]();!(a=(l=f.next()).done);a=!0){var d=l.value;s[d[0]]=d[1]}}catch(e){u=!0,c=e}finally{try{!a&&f.return&&f.return()}finally{if(u)throw c}}}e[(s["content-type"]||"").indexOf("application/json")>-1?"json":"text"]().then(function(e){(i?n:o)(t.list(t.onrequest(e,r,s),r,s))},function(e){return o(t.list(e.message,r,s))})},function(e){return o(t.list(e.message,0,{}))})})}},{key:"save",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"mongo";return this.cmd(t,"set").then(function(n){return e.logging&&console.log("Saved "+e.id+" to "+t+" persistent storage"),n},function(n){throw e.logging&&console.error("Error saving "+e.id+" to "+t+" persistent storage: "+(n.message||n.stack||n)),n})}},{key:"search",value:function(e,t){var n=this,o=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=new r,s="function"==typeof e,a=e&&"function"==typeof e.test;return e&&g(t?Array.isArray(t)?t:[t]:this.index,function(t){var r=n.indexes.get(t);r&&r.forEach(function(r,u){switch(!0){case s&&e(u,t):case a&&e.test(Array.isArray(u)?u.join(", "):u):case u===e:r.forEach(function(e){!i.has(e)&&n.has(e)&&i.set(e,n.get(e,o))})}})}),o?Array.from(i.values()):this.list.apply(this,_toConsumableArray(Array.from(i.values())))}},{key:"set",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=this,a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],u=arguments.length>5&&void 0!==arguments[5]&&arguments[5],c=y(t),l=void 0,f=void 0;return new n(function(n){void 0!==e&&null!==e||(e=s.key&&void 0!==c[s.key]?c[s.key]:E()),s.beforeSet(e,t,r,i,a,u),s.data.has(e)?(f=s.get(e,!0),m(s.index,s.indexes,s.delimiter,e,f,s.pattern),l="put",s.versioning&&s.versions.get(e).add(Object.freeze(y(f))),i||(c=j(y(f),c))):(++s.total,l="post",s.versioning&&s.versions.set(e,new o)),s.data.set(e,c),A(s.index,s.indexes,s.delimiter,e,c,null,s.pattern),n(s.get(e))}).then(function(t){return s.onset(t,r,u,a),a||(s.storage("set",e,c).then(function(t){t&&s.logging&&console.log("Saved "+e+" to persistent storage")},function(t){s.logging&&console.error("Error saving "+e+" to persistent storage: "+(t.message||t.stack||t))}),r||u||!s.uri||(s.debounced.has(e)&&clearTimeout(s.debounced.get(e)),s.debounced.set(e,setTimeout(function(){s.debounced.delete(e),s.transmit(e,c,f,i,l).catch(function(t){s.logging&&console.error(t.stack||t.message||t),f?s.set(e,f,r,!0,a,!0).then(function(){s.logging&&console.log("Reverted "+e)}).catch(function(){s.logging&&console.log("Failed to revert "+e)}):s.del(e,!0).then(function(){s.logging&&console.log("Reverted "+e)}).catch(function(){s.logging&&console.log("Failed to revert "+e)})})},s.debounce)))),t},function(e){throw s.onerror("set",e),e})}},{key:"setUri",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new n(function(n,o){t.uri=e,""!==t.uri?t.sync(r).then(n,o):n([])})}},{key:"sort",value:function(e){return!(arguments.length>1&&void 0!==arguments[1])||arguments[1]?Object.freeze(this.limit(0,this.total,!0).sort(e).map(function(e){return Object.freeze(e)})):this.limit(0,this.total,!0).sort(e)}},{key:"sortBy",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=[],o=[],i=void 0;return this.indexes.has(e)||this.reindex(e),(i=this.indexes.get(e)).forEach(function(e,t){return o.push(t)}),g(o.sort(),function(e){return i.get(e).forEach(function(e){return r.push(t.get(e,n))})}),n?r:this.list.apply(this,r)}},{key:"storage",value:function(){for(var e=this,t=arguments.length,r=Array(t),o=0;o<t;o++)r[o]=arguments[o];return new n(function(t,o){var i=Object.keys(e.adapters).map(function(t){return e.cmd.apply(e,[t].concat(r))});i.length>0?n.all(i).then(function(){return t(!0)},o):t(!1)})}},{key:"sync",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return new n(function(n,r){e.beforeSync(e.uri,t),e.request(e.uri).then(function(o){var i=e.source?e.crawl(o[0]):o[0];e.patch=(o[2].Allow||o[2].allow||"").indexOf("PATCH")>-1,t&&e.clear(),e.batch(i,"set").then(n,r)},function(e){r(e[0]||e)}).catch(function(e){r(e[0]||e)})}).then(function(t){return e.onsync(t),t},function(t){throw e.onerror("sync",t),t})}},{key:"toArray",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=void 0;return e?n=e.map(function(e){return t?e[1]:y(e[1])}):(n=this.limit(0,this.total,!0),t&&g(n,function(e){return Object.freeze(e)})),t?Object.freeze(n):n}},{key:"toObject",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=e?e.reduce(function(e,n){var r=y(n[1]);return t&&Object.freeze(r),e[n[0]]=r,e},{}):function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n={};return e.forEach(function(e,r){var o=e;t&&Object.freeze(o),n[y(r)]=o}),t&&Object.freeze(n),n}(this,t);return t?Object.freeze(n):n}},{key:"transform",value:function(e,t){return"function"==typeof t?t(e):v(e)}},{key:"transmit",value:function(e,t,r){var o=this,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"post";return new n(function(n,a){var u=p(o.uri,t?e:null),c=void 0;o.patch?(c=t?r?i?[{op:"replace",path:"/",value:t}]:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=[];return arguments.length>3&&void 0!==arguments[3]&&arguments[3]&&w(e,function(e,o){o!==n&&void 0===t[o]&&r.push({op:"remove",path:"/"+o})}),w(t,function(t,o){o!==n&&void 0===e[o]?r.push({op:"add",path:"/"+o,value:t}):JSON.stringify(e[o])!==JSON.stringify(t)&&r.push({op:"replace",path:"/"+o,value:t})}),r}(r,t,o.key):[{op:"add",path:"/",value:t}]:[{op:"remove",path:"/",value:e}],o.request(u,{method:"patch",body:JSON.stringify(c,null,0)}).then(n,function(r){405===r[1]?(o.patch=!1,o.request(t?u:p(o.uri,e),{method:s,body:JSON.stringify(t,null,0)}).then(n,a)):a(r)})):o.request(u,{method:s,body:JSON.stringify(t,null,0)}).then(n,a)})}},{key:"unload",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"mongo",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,r=void 0!==n?n:this.id;return this.cmd(t,"remove",n).then(function(n){return e.logging&&console.log("Unloaded "+r+" from "+t+" persistent storage"),n},function(n){throw e.logging&&console.error("Error unloading "+r+" from "+t+" persistent storage: "+(n.message||n.stack||n)),n})}},{key:"unregister",value:function(e){delete d[e]}},{key:"values",value:function(){return this.data.values()}},{key:"useWorker",value:function(e,t){var n=void 0;return this.worker?((n=new a(this.worker)).onerror=function(e){t(e),n.terminate()},n.onmessage=function(t){e(JSON.parse(t.data)),n.terminate()}):t(new Error(f)),n}}]),e}();function C(){var n,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=new S(o).reindex(),a=void 0;return l&&(a=[v.toString(),y.toString(),b.toString(),g.toString(),h.toString(),w.toString(),x.toString(),k.toString(),A.toString(),(t?"self.":"")+"onmessage = "+function(e){var t=JSON.parse(e.data),n=t.cmd,r=void 0;"index"===n&&(r=b(t.records,t.index,t.key,t.delimiter,t.pattern)),"join"===n&&(r=x(t.ids,t.records[0],t.records[1],t.key,t.on,t.type)),postMessage(JSON.stringify(r))}.toString()+";"],i.worker=t?new Function(a.join("\n")):e.URL.createObjectURL((n=a.join("\n"),new s([n],{type:"application/javascript"})))),r&&i.batch(r,"set"),i}C.transform=v,C.version="3.5.0","undefined"!=typeof exports?module.exports=C:"function"==typeof define&&void 0!==define.amd?define(function(){return C}):e.haro=C}("undefined"!=typeof window?window:global);
//# sourceMappingURL=haro.min.js.map