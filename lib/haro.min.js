/* 2017 Jason Mulligan <jason.mulligan@avoidwork.com> */

"use strict";function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(a){function b(){var a=void 0,b=void 0,c=void 0;return a=new o(function(a,d){b=a,c=d}),{resolve:b,reject:c,promise:a}}function c(a,b){return b in a}function each(a,b){var c=arguments.length>2&&void 0!==arguments[2]&&arguments[2],d=a.length,e=-1;if(c)for(;++e<d&&b(a[e],e)!==!1;);else for(;++e<d;)b(a[e],e)}function cast(a){var b=void 0;switch(!0){case a instanceof Map:b={},a.forEach(function(a,c){b[c]=cast(a)});break;case a instanceof Set:b=[],a.forEach(function(a){b.push(cast(a))});break;case Array.isArray(a):b=new Set,each(a,function(a){b.add(cast(a))});break;case a instanceof Object:b=new Map,each(Object.keys(a),function(c){b.set(c,cast(a[c]))});break;default:b=a}return b}function d(b){var c=void 0;try{c=new q([b],{type:"application/javascript"})}catch(d){a.BlobBuilder||(a.BlobBuilder=a.MSBlobBuilder||a.WebKitBlobBuilder||a.MozBlobBuilder),c=(new a.BlobBuilder).append(b).getBlob()}return c}function clone(a){return JSON.parse(JSON.stringify(a,null,0))}function e(a,b){return a.replace(t.querystring,"").replace(t.endslash,"")+(b?"/"+b:"")}function keyIndex(a,b,c,d){var e=void 0;return e=a.indexOf(c)>-1?a.split(c).sort(function(a,b){return a.localeCompare(b)}).map(function(a){return b[a].toString().replace(new RegExp(d,"g"),"").toLowerCase()}).join(c):b[a]}function f(a,b,c,d,e,f){a.forEach(function(a){var g=b.get(a),h=keyIndex(a,e,c,f),i=void 0;g.has(h)&&(i=g.get(h),i.delete(d),0===i.size&&(i=null,g.delete(h)))})}function createIndexes(a,b,d,e,f){var g={};return each(b,function(a){g[a]={}}),each(a,function(a){var h=a[d];void 0!==h&&b.forEach(function(b){var d=keyIndex(b,a,e,f);c(g[b],d)||(g[b][d]=[]),g[b][d].push(h)})}),g}function iterate(a,b){a instanceof Object?each(Object.keys(a),function(c){b.call(a,a[c],c)}):each(a,b)}function g(a,b){return a instanceof Object&&b instanceof Object?each(Object.keys(b),function(c){a[c]instanceof Object&&b[c]instanceof Object?a[c]=g(a[c],b[c]):Array.isArray(a[c])&&Array.isArray(b[c])?a[c]=a[c].concat(b[c]):a[c]=b[c]}):a=Array.isArray(a)&&Array.isArray(b)?a.concat(b):b,a}function joinData(a,b,c,d,e){function f(a,b,c){var f=arguments.length>3&&void 0!==arguments[3]&&arguments[3],g=arguments.length>4&&void 0!==arguments[4]&&arguments[4],k=Object.keys(b[0]),l=g?function(a,b){return a[d]===b[e]}:function(a,b){return a[e]===b[d]};each(a,function(a){var d={},g=b.filter(function(b){return l(b,a)}),m=!0;return g.length>1?(i=!0,j+=a[e],m=!1):1===g.length?each([a,g[0]],function(a,b){return iterate(a,function(a,e){d[c[b]+"_"+e]=a})}):f&&(iterate(a,function(a,b){d[c[0]+"_"+b]=a}),each(k,function(a){d[c[1]+"_"+a]=null})),m&&Object.keys(d).length>0&&h.push(d),m},!0)}var g=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"inner",h=[],i=!1,j="More than one record found on ";return"inner"===g&&f(b,c,a),"left"===g&&f(b,c,a,!0),"right"===g&&f(c,b,clone(a).reverse(),!0,!0),i?j:h}function h(a){var b=JSON.parse(a.data),c=b.cmd,d=void 0;"index"===c&&(d=createIndexes(b.records,b.index,b.key,b.delimiter,b.pattern)),"join"===c&&(d=joinData(b.ids,b.records[0],b.records[1],b.key,b.on,b.type)),postMessage(JSON.stringify(d))}function i(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",d=arguments.length>3&&void 0!==arguments[3]&&arguments[3],e=[];return d&&iterate(a,function(a,d){d!==c&&void 0===b[d]&&e.push({op:"remove",path:"/"+d})}),iterate(b,function(b,d){d!==c&&void 0===a[d]?e.push({op:"add",path:"/"+d,value:b}):JSON.stringify(a[d])!==JSON.stringify(b)&&e.push({op:"replace",path:"/"+d,value:b})}),e}function j(){return(65536*(Math.random()+1)|0).toString(16).substring(1)}function setIndexValue(a,b,c){a.has(b)||a.set(b,new Set),a.get(b).add(c)}function setIndex(a,b,c,d,e,f,g){each(f?[f]:a,function(a){var f=keyIndex(a,e,c,g);void 0!==f&&null!==f&&setIndexValue(b.get(a),f,d)})}function k(a){var b=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],c={};return a.forEach(function(a,d){var e=a;b&&Object.freeze(e),c[clone(d)]=e}),b&&Object.freeze(c),c}function l(){return j()+j()+"-"+j()+"-4"+j().substr(0,3)+"-"+s[Math.floor(4*Math.random())]+j().substr(0,3)+"-"+j()+j()+j()}function m(){var b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},f=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],g=new Haro(b,e,f),i=void 0;if(u){i=[cast.toString(),clone.toString(),createIndexes.toString(),each.toString(),c.toString(),iterate.toString(),joinData.toString(),keyIndex.toString(),setIndexValue.toString(),setIndex.toString(),(n?"self.":"")+"onmessage = "+h.toString()+";"];try{g.worker=n?new Function(i.join("\n")):a.URL.createObjectURL(d(i.join("\n")))}catch(a){g.worker=null}}return g}var n="undefined"!=typeof process&&"function"==typeof process.nextTick,o=a.Promise,Map=a.Map,Set=a.Set,p=a.fetch||require("node-fetch"),q=a.Blob||require("Blob"),r=a.Worker||require("tiny-worker"),s=[8,9,"a","b"],t={querystring:/\?.*/,endslash:/\/$/},u="undefined"!=typeof q&&"undefined"!=typeof r,v="Web Worker not supported",w={},Haro=function(){function Haro(a){var b=this,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,Haro),this.adapters={},this.data=new Map,this.delimiter="|",this.config={method:"get",credentials:!1,headers:{accept:"application/json","content-type":"application/json"}},this.id=l(),this.index=[],this.indexes=new Map,this.key="",this.logging=!0,this.patch=!1,this.pattern="\\s*|\\t*",this.registry=[],this.source="",this.total=0,this.uri="",this.worker=null,this.versions=new Map,this.versioning=!0,each(Object.keys(c),function(a){b[a]=g(b[a],c[a])}),this.reindex(),a&&this.batch(a,"set")}return _createClass(Haro,[{key:"batch",value:function(a){var c=this,d=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"set",e=arguments.length>2&&void 0!==arguments[2]&&arguments[2],f=b(),g="del"===d?function(a){return c.del(a,!0)}:function(a){return c.set(null,a,!0,!0,e)};return o.all(a.map(g)).then(f.resolve,f.reject),f.promise.then(function(a){return c.onbatch(d,a),c.logging&&console.log("Batch inserted data into",c.id),a},function(a){throw c.onerror("batch",a),a})}},{key:"clear",value:function(){return this.total=0,this.registry.length=0,this.data.clear(),this.indexes.clear(),this.versions.clear(),this.reindex().onclear(),this.logging&&console.log("Cleared",this.id),this}},{key:"cmd",value:function(a){var c=b();if(this.adapters[a]&&w[a]){for(var d=arguments.length,e=Array(d>1?d-1:0),f=1;f<d;f++)e[f-1]=arguments[f];w[a].apply(this,[this].concat(e)).then(c.resolve,c.reject)}else c.reject(new Error(a+" not configured for persistent storage"));return c.promise}},{key:"crawl",value:function(a){var b=clone(a);return each((this.source||"").split("."),function(a){b=b[a]}),b||a}},{key:"del",value:function(a){var c=this,d=arguments.length>1&&void 0!==arguments[1]&&arguments[1],e=b(),g=this.get(a,!0),h=void 0;return g?(h=this.registry.indexOf(a),0===h?this.registry.shift():h===this.registry.length-1?this.registry.pop():this.registry.splice(h,1),f(this.index,this.indexes,this.delimiter,a,g,this.pattern),this.data.delete(a),--this.total,e.resolve(a)):e.reject(new Error("Record not found")),e.promise.then(function(b){return c.ondelete(b,d),c.versioning&&c.versions.delete(a),c.storage("remove",a).then(function(b){b&&c.logging&&console.log("Deleted",a,"from persistent storage")},function(b){c.logging&&console.error("Error deleting",a,"from persistent storage:",b.message||b.stack||b)}),c.uri&&!d&&c.transmit(a,null,g,!1,"delete").catch(function(b){c.logging&&console.error(b.stack||b.message||b),c.set(a,g,!0,!0).then(function(){c.logging&&console.log("Reverted",a)}).catch(function(){c.logging&&console.log("Failed to revert",a)})}),b},function(a){throw c.onerror("delete",a),a})}},{key:"dump",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"records";return"records"===a?this.toArray(null,!1):this.transform(this.indexes)}},{key:"entries",value:function(){return this.data.entries()}},{key:"find",value:function(a){var b=this,c=arguments.length>1&&void 0!==arguments[1]&&arguments[1],d=Object.keys(a).sort().join(this.delimiter),e=keyIndex(d,a,this.delimiter,this.pattern),f=[];return this.indexes.has(d)&&(this.indexes.get(d).get(e)||new Set).forEach(function(a){return f.push(b.get(a,c))}),c?f:this.list.apply(this,f)}},{key:"filter",value:function(a){var b=this,c=arguments.length>1&&void 0!==arguments[1]&&arguments[1],d=[],e=void 0;return e=c?function(b,c){a(b,c)===!0&&d.push(b)}:function(c,e){a(c,e)===!0&&d.push(b.list(e,c))},this.forEach(e),c?d:this.list.apply(this,d)}},{key:"forEach",value:function(a,b){return this.data.forEach(function(b,c){return a(clone(b),clone(c))},b),this}},{key:"get",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]&&arguments[1],c=clone(this.data.get(a)||null);return c&&!b?this.list(a,c):c}},{key:"has",value:function(a){return this.data.has(a)}},{key:"join",value:function(a){var c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.key,d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"inner",e=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],f=b(),g=void 0;return a.total>0?(g=e.length>0?this.offload([[this.id,a.id],this.find(e[0],!0),e[1]?a.find(e[1],!0):a.toArray(null,!0),this.key,c,d],"join"):this.offload([[this.id,a.id],this.toArray(null,!0),a.toArray(null,!0),this.key,c,d],"join"),g.then(function(a){"string"==typeof a?f.reject(new Error(a)):f.resolve(a)},f.reject)):f.resolve([]),f.promise}},{key:"keys",value:function(){return this.data.keys()}},{key:"limit",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,b=this,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,d=arguments.length>2&&void 0!==arguments[2]&&arguments[2],e=this.registry.slice(a,a+c).map(function(a){return b.get(a,d)});return d?e:this.list.apply(this,_toConsumableArray(e))}},{key:"list",value:function(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++)b[c]=arguments[c];return Object.freeze(b.map(function(a){return Object.freeze(a)}))}},{key:"load",value:function(){var a=this,b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"mongo",c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,d=void 0===c,e=d?this.id:c;return d&&this.clear(),this.cmd(b,"get",c).then(function(f){return a.logging&&console.log("Loaded",e,"from",b,"persistent storage"),d?a.batch(f,"set",!0):a.set(c,f,!0,!0,!0)},function(c){throw a.logging&&console.error("Error loading",e,"from",b,"persistent storage:",c.message||c.stack||c),c})}},{key:"map",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]&&arguments[1],c=[];return this.forEach(function(b,d){return c.push(a(b,d))}),b?c:this.list.apply(this,c)}},{key:"offload",value:function(a){var c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"index",d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.index,e=b(),f=void 0,g=void 0;return this.worker?(g=this.useWorker(e),g&&("index"===c&&(f={cmd:c,index:d,records:a,key:this.key,delimiter:this.delimiter,pattern:this.pattern}),"join"===c&&(f={cmd:c,ids:a[0],records:[a[1],a[2]],key:a[3],on:a[4],type:a[5]}),g.postMessage(JSON.stringify(f,null,0)))):e.reject(new Error(v)),e.promise}},{key:"onbatch",value:function(){}},{key:"onclear",value:function(){}},{key:"ondelete",value:function(){}},{key:"onerror",value:function(){}},{key:"onrequest",value:function(a){return a}},{key:"onset",value:function(){}},{key:"onsync",value:function(){}},{key:"override",value:function(a){var c=this,d=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"records",e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0,f=b();return"indexes"===d?(this.indexes=this.transform(a,e),f.resolve(!0)):"records"===d?(this.data.clear(),this.indexes.clear(),this.registry.length=0,each(a,function(a){var b=c.key?a[c.key]:l()||l();c.data.set(b,a),c.registry.push(b)}),this.total=this.data.size,f.resolve(!0)):f.reject(new Error("Invalid type")),f.promise}},{key:"register",value:function(a,b){return w[a]=b,this}},{key:"reindex",value:function(a){var b=this;return a?(this.index.indexOf(a)===-1&&this.index.push(a),this.indexes.set(a,new Map),this.forEach(function(c,d){return setIndex(b.index,b.indexes,b.delimiter,d,c,a,b.pattern)})):(this.indexes.clear(),this.index.forEach(function(a){return b.indexes.set(a,new Map)}),this.forEach(function(a,c){return b.index.forEach(function(d){return setIndex(b.index,b.indexes,b.delimiter,c,a,d,b.pattern)})})),this}},{key:"request",value:function(a){var c=this,d=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},e=b(),f=g(clone(this.config),d);return f.method=f.method.toUpperCase(),"DELETE"===f.method&&delete f.body,p(a,f).then(function(a){var b=a.status,d={};if(a.headers._headers)each(Object.keys(a.headers._headers),function(b){d[b]=a.headers._headers[b].join(", ")});else{var f=!0,g=!1,h=void 0;try{for(var i,j=a.headers.entries()[Symbol.iterator]();!(f=(i=j.next()).done);f=!0){var k=i.value;d[k[0]]=k[1]}}catch(a){g=!0,h=a}finally{try{!f&&j.return&&j.return()}finally{if(g)throw h}}}a[(d["content-type"]||"").indexOf("application/json")>-1?"json":"text"]().then(function(a){e[b<200||b>=400?"reject":"resolve"](c.list(c.onrequest(a,b,d),b,d))},function(a){return e.reject(c.list(a.message,b,d))})},function(a){return e.reject(c.list(a.message,0,{}))}),e.promise}},{key:"save",value:function(){var a=this,b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"mongo";return this.cmd(b,"set").then(function(c){return a.logging&&console.log("Saved",a.id,"to",b,"persistent storage"),c},function(c){throw a.logging&&console.error("Error saving ",a.id,"to",b,"persistent storage:",c.message||c.stack||c),c})}},{key:"search",value:function(a,b){var c=this,d=arguments.length>2&&void 0!==arguments[2]&&arguments[2],e=[],f="function"==typeof a,g=a&&"function"==typeof a.test,h=new Set;return a&&each(b?Array.isArray(b)?b:[b]:this.index,function(b){var i=c.indexes.get(b);i&&i.forEach(function(i,j){switch(!0){case f&&a(j,b):case g&&a.test(Array.isArray(j)?j.join(", "):j):case j===a:i.forEach(function(a){h.has(a)||(h.add(a),e.push(c.get(a,d)))})}})}),d?e:this.list.apply(this,e)}},{key:"set",value:function(a,c){var d=arguments.length>2&&void 0!==arguments[2]&&arguments[2],e=this,h=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],j=b(),k=clone(c),m=void 0,n=void 0;return void 0!==a&&null!==a||(a=this.key&&void 0!==k[this.key]?k[this.key]:l()),this.data.has(a)?(n=this.get(a,!0),f(this.index,this.indexes,this.delimiter,a,n,this.pattern),m="put",this.versioning&&this.versions.get(a).add(Object.freeze(clone(n))),h||(k=g(clone(n),k))):(this.registry[this.total]=a,++this.total,m="post",this.versioning&&this.versions.set(a,new Set)),this.data.set(a,k),setIndex(this.index,this.indexes,this.delimiter,a,k,null,this.pattern),j.resolve(this.get(a)),j.promise.then(function(b){return e.onset(b,d),!d&&e.uri&&e.transmit(a,k,n,h,m).catch(function(b){e.logging&&console.error(b.stack||b.message||b),n?e.set(a,n,d,!0).then(function(){e.logging&&console.log("Reverted",a)}).catch(function(){e.logging&&console.log("Failed to revert",a)}):e.del(a,!0).then(function(){e.logging&&console.log("Reverted",a)}).catch(function(){e.logging&&console.log("Failed to revert",a)})}),i||e.storage("set",a,k).then(function(b){b&&e.logging&&console.log("Saved",a,"to persistent storage")},function(b){e.logging&&console.error("Error saving",a,"to persistent storage:",b.message||b.stack||b)}),b},function(a){throw e.onerror("set",a),a})}},{key:"setUri",value:function(a){var c=arguments.length>1&&void 0!==arguments[1]&&arguments[1],d=b();return this.uri=a,this.uri?this.sync(c).then(d.resolve,d.reject):d.resolve([]),d.promise}},{key:"sort",value:function(a){var b=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return b?Object.freeze(this.limit(0,this.total,!0).sort(a).map(function(a){return Object.freeze(a)})):this.limit(0,this.total,!0).sort(a)}},{key:"sortBy",value:function(a){var b=this,c=arguments.length>1&&void 0!==arguments[1]&&arguments[1],d=[],e=[],f=void 0;return this.indexes.has(a)||this.reindex(a),f=this.indexes.get(a),f.forEach(function(a,b){return e.push(b)}),each(e.sort(),function(a){return f.get(a).forEach(function(a){return d.push(b.get(a,c))})}),c?d:this.list.apply(this,d)}},{key:"storage",value:function(){for(var a=this,c=arguments.length,d=Array(c),e=0;e<c;e++)d[e]=arguments[e];var f=b(),g=Object.keys(this.adapters).map(function(b){return a.cmd.apply(a,[b].concat(d))});return g.length>0?o.all(g).then(function(){return f.resolve(!0)},f.reject):f.resolve(!1),f.promise}},{key:"sync",value:function(){var a=this,c=arguments.length>0&&void 0!==arguments[0]&&arguments[0],d=b(),e=!0;return this.request(this.uri).then(function(b){var f=void 0;a.patch=(b[2].Allow||b[2].allow||"").indexOf("PATCH")>-1;try{f=a.source?a.crawl(b[0]):b[0]}catch(a){e=!1,d.reject(a)}e&&(c&&a.clear(),a.batch(f,"set").then(d.resolve,d.reject))},function(a){d.reject(a[0]||a)}),d.promise.then(function(b){return a.onsync(b),b},function(b){throw a.onerror("sync",b),b})}},{key:"toArray",value:function(a){var b=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],c=void 0;return a?c=a.map(function(a){return b?a[1]:clone(a[1])}):(c=this.limit(0,this.total,!0),b&&each(c,function(a){return Object.freeze(a)})),b?Object.freeze(c):c}},{key:"toObject",value:function(a){var b=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],c=a?a.reduce(function(a,c){var d=clone(c[1]);return b&&Object.freeze(d),a[c[0]]=d,a},{}):k(this,b);return b?Object.freeze(c):c}},{key:"transform",value:function(a,b){return"function"==typeof b?b(a):cast(a)}},{key:"transmit",value:function(a,c,d){var f=this,g=arguments.length>3&&void 0!==arguments[3]&&arguments[3],h=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"post",j=b(),k=e(this.uri,c?a:null),l=void 0;return this.patch?(l=c?d?g?[{op:"replace",path:"/",value:c}]:i(d,c,this.key):[{op:"add",path:"/",value:c}]:[{op:"remove",path:"/",value:a}],this.request(k,{method:"patch",body:JSON.stringify(l,null,0)}).then(j.resolve,function(b){405===b[1]?(f.patch=!1,f.request(c?k:e(f.uri,a),{method:h,body:JSON.stringify(c,null,0)}).then(j.resolve,j.reject)):j.reject(b)})):this.request(k,{method:h,body:JSON.stringify(c,null,0)}).then(j.resolve,j.reject),j.promise}},{key:"unload",value:function(){var a=this,b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"mongo",c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,d=void 0!==c?c:this.id;return this.cmd(b,"remove",c).then(function(c){return a.logging&&console.log("Unloaded",d,"from",b,"persistent storage"),c},function(c){throw a.logging&&console.error("Error unloading",d,"from",b,"persistent storage:",c.message||c.stack||c),c})}},{key:"unregister",value:function(a){delete w[a]}},{key:"values",value:function(){return this.data.values()}},{key:"useWorker",value:function(a){var b=void 0;return this.worker?(b=new r(this.worker),b.onerror=function(c){a.reject(c),b.terminate()},b.onmessage=function(c){a.resolve(JSON.parse(c.data)),b.terminate()}):a.reject(new Error(v)),b}}]),Haro}();m.transform=cast,m.version="3.1.13","undefined"!=typeof exports?module.exports=m:"function"==typeof define&&define.amd?define(function(){return m}):a.haro=m}("undefined"!=typeof window?window:global);
//# sourceMappingURL=haro.min.js.map