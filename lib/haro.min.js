/* 2015 Jason Mulligan <jason.mulligan@avoidwork.com> */

"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(a){function b(a){return JSON.parse(JSON.stringify(a))}function c(a,b){return a.replace(q.querystring,"").replace(q.endslash,"")+(b?"/"+b:"")}function d(){var a=void 0,b=void 0,c=void 0;return a=new l(function(a,d){b=a,c=d}),{resolve:b,reject:c,promise:a}}function e(a,b){a instanceof Object?Object.keys(a).forEach(function(c){b.call(a,a[c],c)}):a.forEach(b)}function f(a,b,c){var d=a.split(c).sort(),e=void 0;return e=d.length>1?d.map(function(a){return String(b[a])}).join(c):b[a]}function g(a,c){var d=b(a),e=b(c);return d instanceof Object&&e instanceof Object?Object.keys(e).forEach(function(a){d[a]instanceof Object&&e[a]instanceof Object?d[a]=g(d[a],e[a]):d[a]instanceof Array&&e[a]instanceof Array?d[a]=d[a].concat(e[a]):d[a]=e[a]}):d=d instanceof Array&&e instanceof Array?d.concat(e):e,d}function h(){var a=void 0===arguments[0]?{}:arguments[0],b=this,c=void 0===arguments[1]?{}:arguments[1],d=void 0===arguments[2]?!1:arguments[2],f=[];return d&&e(a,function(a,d){d!==b.key&&void 0===c[d]&&f.push({op:"remove",path:"/"+d})}),e(c,function(c,d){d!==b.key&&void 0===a[d]?f.push({op:"add",path:"/"+d,value:c}):JSON.stringify(a[d])!==JSON.stringify(c)&&f.push({op:"replace",path:"/"+d,value:c})}),f}function i(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function j(){return i()+i()+"-"+i()+"-4"+i().substr(0,3)+"-"+r[Math.floor(4*Math.random())]+i().substr(0,3)+"-"+i()+i()+i()}function k(){var a=void 0===arguments[0]?null:arguments[0],b=void 0===arguments[1]?{}:arguments[1],c=void 0===arguments[2]?[]:arguments[2];return new Haro(a,b,c)}var l=a.Promise||require("es6-promise").Promise,m=a.Map||require("es6-map"),n=a.Set||require("es6-set"),o=a.fetch||require("node-fetch"),p=a.tuple||require("tiny-tuple"),q={querystring:/\?.*/,endslash:/\/$/},r=[8,9,"a","b"],Haro=function(){function Haro(a){var b=this,c=void 0===arguments[1]?{}:arguments[1];_classCallCheck(this,Haro),this.data=new m,this.delimiter="|",this.config={method:"get",credentials:!1,headers:{accept:"application/json","content-type":"application/json"}},this.index=[],this.indexes=new m,this.patch=!1,this.registry=[],this.key="",this.source="",this.total=0,this.uri="",this.versions=new m,this.versioning=!0,Object.keys(c).forEach(function(a){b[a]=g(b[a],c[a])}),this.reindex(),a&&this.batch(a,"set")}return _createClass(Haro,[{key:"batch",value:function(a,b){function c(){l.all(a.map(j)).then(function(a){f.resolve(a)},function(a){f.reject(a)})}var e=this,f=d(),g="del"===b,i=void 0,j=void 0,k=void 0;return j=g?function(a){return e.del(a,!0)}:function(a){return e.set(null,a,!0,!0)},this.patch?(g?i=h(this.toArray().map(function(a){return a[e.key]}),a,!0):(i=[],k={},a.forEach(function(a){var b=a[e.key];b?k[b]=a:i.push({op:"add",path:"/",value:a})}),i=i.concat(h(this.toObject(),k,!0))),i.length>0?this.request(this.uri,{method:"patch",body:JSON.stringify(i)}).then(function(){c()},function(a){f.reject(a)}):f.resolve()):c(),f.promise}},{key:"clear",value:function(){return this.total=0,this.registry=[],this.data.clear(),this.indexes.clear(),this.versions.clear(),this.reindex()}},{key:"del",value:function(a){var b=this,e=void 0===arguments[1]?!1:arguments[1],f=d(),g=function(){var c=b.registry.indexOf(a);c>-1&&(0===c?b.registry.shift():c===b.registry.length-1?b.registry.pop():b.registry.splice(c,1),b.delIndex(a,b.data.get(a)),b.data["delete"](a),--b.total,b.versioning&&b.versions["delete"](a)),f.resolve()};return this.data.has(a)?!e&&this.uri?this.patch?this.request(c(this.uri,null),{method:"patch",body:null}).then(g,function(a){f.reject(a[0]||a)}):this.request(c(this.uri,a),{method:"delete"}).then(g,function(a){f.reject(a[0]||a)}):g():f.reject(new Error("Record not found")),f.promise}},{key:"delIndex",value:function(a,b){var c=this;this.index.forEach(function(d){var e=c.indexes.get(d),g=f(d,b,c.delimiter);e.has(g)&&e.get(g)["delete"](a)})}},{key:"entries",value:function(){return this.data.entries()}},{key:"find",value:function(a){var b=this,c=Object.keys(a).sort().join(this.delimiter),d=f(c,a,this.delimiter),e=[];return this.indexes.has(c)&&(this.indexes.get(c).get(d)||new n).forEach(function(a){e.push(b.get(a))}),p.apply(p,e)}},{key:"filter",value:function(a){var b=[];return this.forEach(function(c,d){a(c,d)===!0&&b.push(p(d,c))}),p.apply(p,b)}},{key:"forEach",value:function(a,c){return this.data.forEach(function(c,d){a(b(c),b(d))},c),this}},{key:"get",value:function(a){var b=void 0;return this.data.has(a)&&(b=p(a,this.data.get(a))),b}},{key:"keys",value:function(){return this.data.keys()}},{key:"limit",value:function(a,b){void 0===a&&(a=0);var c=a,d=b,e=[],f=void 0,g=void 0,h=void 0;if(void 0===d&&(d=c,c=0),f=c,h=c+d,0>f||f>=h)throw new Error("Invalid range");do g=this.registry[f],g&&e.push(this.get(g));while(++f<h);return p.apply(p,e)}},{key:"map",value:function(a){var b=[];return this.forEach(function(c,d){b.push(a(c,d))}),p.apply(p,b)}},{key:"reindex",value:function(a){var b=this;return a?(this.indexes.set(a,new m),this.forEach(function(c,d){b.setIndex(d,c,a)})):(this.indexes.clear(),this.index.forEach(function(a){b.indexes.set(a,new m),b.forEach(function(c,d){b.setIndex(d,c,a)})})),this}},{key:"request",value:function(a){var b=void 0===arguments[1]?{}:arguments[1],c=d(),e=g(this.config,b);return o(a,e).then(function(a){var b=a.status;a[a.headers.get("content-type").indexOf("application/json")>-1?"json":"text"]().then(function(d){c[200>b||b>=400?"reject":"resolve"](p(d,b,a.headers))},function(d){c.reject(p(d.message,b,a.headers))})},function(a){c.reject(p(a.message,0,null))}),c.promise}},{key:"search",value:function(a,b){var c=this,d=b?this.index.indexOf(b)>-1?[b]:[]:this.index,e=[],f="function"==typeof a,g=a instanceof RegExp,h=new n;return a&&d.forEach(function(b){var d=c.indexes.get(b);d&&d.forEach(function(b,d){(f&&a(d)||g&&a.test(d)||d===a)&&b.forEach(function(a){h.has(a)||(h.add(a),e.push(c.get(a)))})})}),p.apply(p,e)}},{key:"set",value:function(a,e){var f=this,h=void 0===arguments[2]?!1:arguments[2],i=void 0===arguments[3]?!1:arguments[3],k=d(),l="post",m=b(e),o=a,q=function(){var a=void 0;"post"===l?(f.registry[f.total]=o,++f.total,f.versioning&&f.versions.set(o,new n)):(a=f.data.get(o),f.versioning&&f.versions.get(o).add(p(a)),f.delIndex(o,a)),f.data.set(o,m),f.setIndex(o,m),k.resolve(f.get(o))};return void 0===o||null===o?o=this.key?m[this.key]||j():j()||j():this.data.has(o)&&(l="put",i||(m=g(this.get(o)[1],m))),!h&&this.uri?this.patch?this.request(c(this.uri,null),{method:"patch",body:JSON.stringify(m)}).then(q,function(a){k.reject(a[0]||a)}):this.request(c(this.uri,o),{method:l,body:JSON.stringify(m)}).then(q,function(a){k.reject(a[0]||a)}):q(),k.promise}},{key:"setIndex",value:function(a,b,c){var d=this;return c?this.setIndexValue(this.indexes.get(c),f(c,b,this.delimiter),a):this.index.forEach(function(c){d.setIndexValue(d.indexes.get(c),f(c,b,d.delimiter),a)}),this}},{key:"setIndexValue",value:function(a,b,c){a.has(b)||a.set(b,new n),a.get(b).add(c)}},{key:"setUri",value:function(a){var b=void 0===arguments[1]?!1:arguments[1],c=d();return this.uri=a,this.uri?this.sync(b).then(function(a){c.resolve(a)},function(a){c.reject(a)}):c.resolve([]),c.promise}},{key:"sort",value:function(a){return this.toArray().sort(a)}},{key:"sortBy",value:function(a){var b=this,c=[],d=[],e=void 0;return this.indexes.has(a)||(this.index.push(a),this.reindex(a)),e=this.indexes.get(a),e.forEach(function(a,b){d.push(b)}),d.sort().forEach(function(a){e.get(a).forEach(function(a){c.push(b.get(a))})}),p.apply(p,c)}},{key:"sync",value:function(){var a=this,b=void 0===arguments[0]?!1:arguments[0],c=d();return this.request(this.uri).then(function(d){var e=d[0];if(a.source)try{a.source.split(".").forEach(function(a){e=e[a]})}catch(f){return c.reject(f)}b&&a.clear(),a.batch(e,"set").then(function(a){c.resolve(a)},function(a){c.reject(a)})},function(a){c.reject(a[0]||a)}),c.promise}},{key:"toArray",value:function(){var a=[];return this.forEach(function(b){a.push(b)}),a}},{key:"toObject",value:function(){var a={};return this.forEach(function(b,c){a[c]=b}),a}},{key:"values",value:function(){return this.data.values()}}]),Haro}();k.version="1.3.2","undefined"!=typeof exports?module.exports=k:"function"==typeof define?define(function(){return k}):a.haro=k}("undefined"!=typeof global?global:window);
//# sourceMappingURL=haro.min.js.map