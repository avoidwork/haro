/* 2015 Jason Mulligan <jason.mulligan@avoidwork.com> */

"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(a){function b(a){return JSON.parse(JSON.stringify(a))}function c(){var a=void 0,b=void 0,c=void 0;return a=new h(function(a,d){b=a,c=d}),{resolve:b,reject:c,promise:a}}function d(a,c){var d=b(a),e=b(c);return Object.keys(e).forEach(function(a){d[a]=e[a]}),d}function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function f(){return e()+e()+"-"+e()+"-4"+e().substr(0,3)+"-"+m[Math.floor(4*Math.random())]+e().substr(0,3)+"-"+e()+e()+e()}function g(){var a=void 0===arguments[0]?null:arguments[0],b=void 0===arguments[1]?{}:arguments[1],c=void 0===arguments[2]?[]:arguments[2];return new Haro(a,b,c)}var h=a.Promise||require("es6-promise").Promise,i=a.Map||require("es6-map"),j=a.Set||require("es6-set"),k=a.fetch||require("node-fetch"),l=a.tuple||require("tiny-tuple"),m=[8,9,"a","b"],Haro=function(){function Haro(a){var b=this,c=void 0===arguments[1]?{}:arguments[1];_classCallCheck(this,Haro),this.data=new i,this.delimiter="|",this.config={method:"get",credentials:!1,headers:{accept:"application/json","content-type":"application/json"}},this.index=[],this.indexes=new i,this.registry=[],this.key="",this.source="",this.total=0,this.uri="",this.versions=new i,Object.keys(c).forEach(function(a){b[a]=d(b[a],c[a])}),this.index.forEach(function(a){b.indexes.set(a,new i)}),a&&this.batch(a,"set")}return _createClass(Haro,[{key:"batch",value:function(a,b){var d=this,e=c(),f=[];return"del"===b?a.forEach(function(a){f.push(d.del(a,!0))}):a.forEach(function(a){f.push(d.set(null,a,!0))}),h.all(f).then(function(a){e.resolve(a)},function(a){e.reject(a)}),e.promise}},{key:"clear",value:function(){var a=this;return this.total=0,this.registry=[],this.data.clear(),this.indexes.clear(),this.versions.clear(),this.index.forEach(function(b){a.indexes.set(b,new i)}),this}},{key:"del",value:function(a){var b=this,d=void 0===arguments[1]?!1:arguments[1],e=c(),f=function(){var c=b.registry.indexOf(a);c>-1&&(0===c?b.registry.shift():c===b.registry.length-1?b.registry.pop():b.registry.splice(c,1),b.delIndex(a,b.data.get(a)),b.data["delete"](a),b.versions["delete"](a),--b.total),e.resolve()};return this.data.has(a)?!d&&this.uri?this.request(this.uri.replace(/\?.*/,"")+"/"+a,{method:"delete"}).then(f,function(a){e.reject(a[0]||a)}):f():e.reject(new Error("Record not found")),e.promise}},{key:"delIndex",value:function(a,b){var c=this;this.index.forEach(function(d){var e=c.indexes.get(d),f=c.keyIndex(d,b);e.has(f)&&e.get(f)["delete"](a)})}},{key:"entries",value:function(){return this.data.entries()}},{key:"find",value:function(a){var b=this,c=Object.keys(a),d=c.join(this.delimiter),e=this.keyIndex(d,a),f=[];return this.indexes.has(d)&&(this.indexes.get(d).get(e)||new j).forEach(function(a){f.push(b.get(a))}),l.apply(l,f)}},{key:"filter",value:function(a){var c=[];return this.forEach(function(d,e){a(b(d),b(e))===!0&&c.push(l(e,d))}),l.apply(l,c)}},{key:"forEach",value:function(a,b){return this.data.forEach(a,b)}},{key:"get",value:function(a){var b=void 0;return this.data.has(a)&&(b=l(a,this.data.get(a))),b}},{key:"keys",value:function(){return this.data.keys()}},{key:"limit",value:function(){var a=void 0===arguments[0]?0:arguments[0],b=void 0===arguments[1]?0:arguments[1],c=a,d=a+b,e=[],f=void 0;if(0>c||c>=d)throw new Error("Invalid range");do f=this.registry[c],f&&e.push(this.get(f));while(++c<d);return l.apply(l,e)}},{key:"map",value:function(a){var c=[];return this.forEach(function(d,e){c.push(l(e,a(b(d),b(e))))}),l.apply(l,c)}},{key:"request",value:function(a){var b=void 0===arguments[1]?{}:arguments[1],c=d(this.config,b);return k(a,c).then(function(a){return a[a.headers.get("content-type").indexOf("application/json")>-1?"json":"text"]().then(function(b){if(0===a.status||a.status>=400)throw l(b,a.status);return l(b,a.status)},function(b){throw l(b.message,a.status)})},function(a){throw l(a.message,0)})}},{key:"set",value:function(a,e){var g=this,h=void 0===arguments[2]?!1:arguments[2],i=void 0===arguments[3]?!1:arguments[3],k=c(),m="post",n=b(e),o=function(){"post"===m?(++g.total,g.registry.push(a),g.versions.set(a,new j)):g.versions.get(a).add(l(g.data.get(a))),g.delIndex(a,g.data.get(a)),g.data.set(a,n),g.setIndex(a,n),k.resolve(g.get(a))};return void 0===a||null===a?a=this.key?n[this.key]:f()||f():this.data.has(a)&&(m="put",i||(n=d(this.get(a)[1],n))),!h&&this.uri?this.request(this.uri.replace(/\?.*/,"")+"/"+a,{method:m,body:JSON.stringify(n)}).then(o,function(a){k.reject(a[0]||a)}):o(),k.promise}},{key:"keyIndex",value:function(a,b){return a.split(this.delimiter).map(function(a){return b[a].toString()||""}).join(this.delimiter)}},{key:"setIndex",value:function(a,b){var c=this;return this.index.forEach(function(d){var e=c.indexes.get(d),f=c.keyIndex(d,b);e.has(f)||e.set(f,new j),e.get(f).add(a)}),this}},{key:"setUri",value:function(a){var b=this,d=c();return this.uri=a,this.uri?this.request(this.uri).then(function(a){var c=a[0];if(b.source)try{b.source.split(".").forEach(function(a){c=c[a]})}catch(e){return d.reject(e)}b.batch(c,"set").then(function(a){d.resolve(a)},function(a){d.reject(a)})},function(a){d.reject(a[0]||a)}):d.resolve(),d.promise}},{key:"values",value:function(){return this.data.values()}}]),Haro}();g.version="1.1.0","undefined"!=typeof exports?module.exports=g:"function"==typeof define?define(function(){return g}):a.haro=g}("undefined"!=typeof global?global:window);
//# sourceMappingURL=haro.min.js.map