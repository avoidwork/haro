/* 2016 Jason Mulligan <jason.mulligan@avoidwork.com> */

"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(a){function cast(a){var b=void 0;switch(!0){case a instanceof Map:b={},a.forEach(function(a,c){b[c]=cast(a)});break;case a instanceof Set:b=[],a.forEach(function(a){b.push(cast(a))});break;case Array.isArray(a):b=new Set,a.forEach(function(a){b.add(cast(a))});break;case a instanceof Object:b=new Map,Object.keys(a).forEach(function(c){b.set(c,cast(a[c]))});break;default:b=a}return b}function b(b){var c=void 0;try{c=new r([b],{type:"application/javascript"})}catch(d){a.BlobBuilder||(a.BlobBuilder=a.MSBlobBuilder||a.WebKitBlobBuilder||a.MozBlobBuilder),c=(new a.BlobBuilder).append(b).getBlob()}return c}function clone(a){return JSON.parse(JSON.stringify(a,null,0))}function c(a,b){return a.replace(u.querystring,"").replace(u.endslash,"")+(b?"/"+b:"")}function keyIndex(a,b,c,d){var e=void 0;return e=a.indexOf(c)>-1?a.split(c).sort(function(a,b){return a.localeCompare(b)}).map(function(a){return b[a].toString().replace(new RegExp(d,"g"),"").toLowerCase()}).join(c):b[a]}function d(a,b,c,d,e,f){a.forEach(function(a){var g=b.get(a),h=keyIndex(a,e,c,f),i=void 0;g.has(h)&&(i=g.get(h),i.delete(d),0===i.size&&(i=null,g.delete(h)))})}function createIndexes(a,b,c,d,e){var f={};return b.forEach(function(a){f[a]={}}),a.forEach(function(a){var g=a[c];void 0!==g&&b.forEach(function(b){var c=keyIndex(b,a,d,e);void 0===f[b][c]&&(f[b][c]=[]),f[b][c].push(g)})}),f}function each(a,b){for(var c=a.length,d=-1;++d<c&&b(a[d])!==!1;);}function iterate(a,b){a instanceof Object?Object.keys(a).forEach(function(c){b.call(a,a[c],c)}):a.forEach(b)}function e(a,b){return a instanceof Object&&b instanceof Object?Object.keys(b).forEach(function(c){a[c]instanceof Object&&b[c]instanceof Object?a[c]=e(a[c],b[c]):Array.isArray(a[c])&&Array.isArray(b[c])?a[c]=a[c].concat(b[c]):a[c]=b[c]}):a=Array.isArray(a)&&Array.isArray(b)?a.concat(b):b,a}function joinData(a,b,c,d,e){function f(a,b,c){var f=arguments.length>3&&void 0!==arguments[3]&&arguments[3],g=arguments.length>4&&void 0!==arguments[4]&&arguments[4],k=Object.keys(b[0]),l=g?function(a,b){return a[d]===b[e]}:function(a,b){return a[e]===b[d]};each(a,function(a){var d={},g=b.filter(function(b){return l(b,a)}),m=!0;return g.length>1?(i=!0,j="More than one record found on "+a[e],m=!1):1===g.length?[a,g[0]].forEach(function(a,b){iterate(a,function(a,e){d[c[b]+"_"+e]=a})}):f&&(iterate(a,function(a,b){d[c[0]+"_"+b]=a}),k.forEach(function(a){d[c[1]+"_"+a]=null})),m&&Object.keys(d).length>0&&h.push(d),m})}var g=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"inner",h=[],i=!1,j=void 0;return"inner"===g&&f(b,c,a),"left"===g&&f(b,c,a,!0),"right"===g&&f(c,b,clone(a).reverse(),!0,!0),i?j:h}function f(a){var b=JSON.parse(a.data),c=b.cmd,d=void 0;"index"===c&&(d=createIndexes(b.records,b.index,b.key,b.delimiter,b.pattern)),"join"===c&&(d=joinData(b.ids,b.records[0],b.records[1],b.key,b.on,b.type)),postMessage(JSON.stringify(d))}function g(a){var b=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return b?clone(a):q.apply(q,a)}function h(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",d=arguments.length>3&&void 0!==arguments[3]&&arguments[3],e=[];return d&&iterate(a,function(a,d){d!==c&&void 0===b[d]&&e.push({op:"remove",path:"/"+d})}),iterate(b,function(b,d){d!==c&&void 0===a[d]?e.push({op:"add",path:"/"+d,value:b}):JSON.stringify(a[d])!==JSON.stringify(b)&&e.push({op:"replace",path:"/"+d,value:b})}),e}function i(){return(65536*(Math.random()+1)|0).toString(16).substring(1)}function setIndexValue(a,b,c){a.has(b)||a.set(b,new Set),a.get(b).add(c)}function setIndex(a,b,c,d,e,f,g){var h=void 0;f?(h=keyIndex(f,e,c,g),void 0!==h&&null!==h&&setIndexValue(b.get(f),h,d)):a.forEach(function(a){var f=keyIndex(a,e,c,g);void 0!==f&&null!==f&&setIndexValue(b.get(a),f,d)})}function j(a){var b=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],c={};return a.forEach(function(a,d){var e=clone(a);b&&Object.freeze(e),c[clone(d)]=e}),b&&Object.freeze(c),c}function k(){return i()+i()+"-"+i()+"-4"+i().substr(0,3)+"-"+t[Math.floor(4*Math.random())]+i().substr(0,3)+"-"+i()+i()+i()}function l(){var c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,d=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],g=new Haro(c,d,e),h=void 0;if(v){h=[cast.toString(),clone.toString(),createIndexes.toString(),each.toString(),iterate.toString(),joinData.toString(),keyIndex.toString(),setIndexValue.toString(),setIndex.toString(),(m?"self.":"")+"onmessage = "+f.toString()+";"];try{g.worker=m?new Function(h.join("\n")):a.URL.createObjectURL(b(h.join("\n")))}catch(a){g.worker=null}}return g}var m="undefined"!=typeof process&&"function"==typeof process.nextTick,n=a.Promise,Map=a.Map,Set=a.Set,o=a.fetch||require("node-fetch"),p=a.deferred||require("tiny-defer"),q=a.tuple||require("tiny-tuple"),r=a.Blob||require("Blob"),s=a.Worker||require("tiny-worker"),t=[8,9,"a","b"],u={querystring:/\?.*/,endslash:/\/$/},v="undefined"!=typeof r&&"undefined"!=typeof s,w="Web Worker not supported",x={},Haro=function(){function Haro(a){var b=this,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,Haro),this.adapters={},this.data=new Map,this.delimiter="|",this.config={method:"get",credentials:!1,headers:{accept:"application/json","content-type":"application/json"}},this.id=k(),this.index=[],this.indexes=new Map,this.key="",this.loading=!1,this.logging=!0,this.patch=!1,this.pattern="\\s*|\\t*",this.registry=[],this.source="",this.total=0,this.uri="",this.worker=null,this.versions=new Map,this.versioning=!0,Object.keys(c).forEach(function(a){b[a]=e(b[a],c[a])}),this.reindex(),a&&this.batch(a,"set")}return _createClass(Haro,[{key:"batch",value:function(a,b){function d(){n.all(a.map(k)).then(g.resolve,g.reject)}var e=this,f=arguments.length>2&&void 0!==arguments[2]&&arguments[2],g=p(),i="del"===b,j=void 0,k=void 0,l=void 0;return this.loading=!0,k=i?function(a){return e.del(a,!0)}:function(a){return e.set(null,a,!0,!0,f)},this.patch?(i?j=h(this.limit(0,this.total,!0).map(function(a){return a[e.key]}),a,this.key,!0):(j=[],l={},a.forEach(function(a){var b=a[e.key];b?l[b]=a:j.push({op:"add",path:"/",value:a})}),j=j.concat(h(this.toObject(void 0,!1),l,this.key,!0))),j.length>0?this.request(c(this.uri,null),{method:"patch",body:JSON.stringify(j)}).then(d,g.reject):g.resolve()):d(),g.promise.then(function(a){var c=q.apply(q,a);return e.loading=!1,e.onbatch(b,c),e.logging&&console.log("Batch inserted data into",e.id),c},function(a){throw e.loading=!1,e.onerror("batch",a),a})}},{key:"clear",value:function(){return this.total=0,this.registry.length=0,this.data.clear(),this.indexes.clear(),this.versions.clear(),this.reindex().onclear(),this.logging&&console.log("Cleared",this.id),this}},{key:"cmd",value:function(a){var b=p();if(this.adapters[a]&&x[a]){for(var c=arguments.length,d=Array(c>1?c-1:0),e=1;e<c;e++)d[e-1]=arguments[e];x[a].apply(this,[this].concat(d)).then(b.resolve,b.reject)}else b.reject(new Error(a+" not configured for persistent storage"));return b.promise}},{key:"crawl",value:function(a){var b=clone(a);return(this.source||"").split(".").forEach(function(a){b=b[a]}),b}},{key:"del",value:function(a){var b=this,e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],f=p(),g=function(){var c=b.registry.indexOf(a);c>-1&&(0===c?b.registry.shift():c===b.registry.length-1?b.registry.pop():b.registry.splice(c,1),d(b.index,b.indexes,b.delimiter,a,b.data.get(a),b.pattern),b.data.delete(a),--b.total,b.versioning&&b.versions.delete(a),b.storage("remove",a).then(function(c){c&&b.logging&&console.log("Deleted",a,"from persistent storage")},function(c){b.logging&&console.error("Error deleting",a,"from persistent storage:",c.message||c.stack||c)})),f.resolve(a)};return this.data.has(a)?(e||(this.loading=!0),!e&&this.uri?this.patch?this.request(c(this.uri,null),{method:"patch",body:JSON.stringify([{op:"remove",path:"/"+a}])}).then(g,function(d){405===d[1]?(b.patch=!1,b.request(c(b.uri,a),{method:"delete"}).then(g,f.reject)):f.reject(d)}):this.request(c(this.uri,a),{method:"delete"}).then(g,f.reject):g()):f.reject(new Error("Record not found")),f.promise.then(function(a){return e||(b.loading=!1),b.ondelete(a),a},function(a){throw e||(b.loading=!1),b.onerror("delete",a),a})}},{key:"dump",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"records",b=void 0;return b="records"===a?this.toArray(null,!1):this.transform(this.indexes)}},{key:"entries",value:function(){return this.data.entries()}},{key:"find",value:function(a){var b=this,c=arguments.length>1&&void 0!==arguments[1]&&arguments[1],d=Object.keys(a).sort().join(this.delimiter),e=keyIndex(d,a,this.delimiter),f=[];return this.indexes.has(d)&&(this.indexes.get(d).get(e)||new Set).forEach(function(a){f.push(b.get(a,c))}),g(f,c)}},{key:"filter",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]&&arguments[1],c=[];return this.forEach(function(){return b?function(b,d){a(b,d)===!0&&c.push(b)}:function(b,d){a(b,d)===!0&&c.push(q(d,b))}}()),g(c,b)}},{key:"forEach",value:function(a,b){return this.data.forEach(function(b,c){a(clone(b),clone(c))},b),this}},{key:"get",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]&&arguments[1],c=clone(this.data.get(a)||null);return c&&!b?q(a,c):c}},{key:"has",value:function(a){return this.data.has(a)}},{key:"join",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.key,c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"inner",d=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],e=p(),f=void 0;return a.total>0?(f=d.length>0?this.offload([[this.id,a.id],this.find(d[0],!0),d[1]?a.find(d[1],!0):a.toArray(null,!0),this.key,b,c],"join"):this.offload([[this.id,a.id],this.toArray(null,!0),a.toArray(null,!0),this.key,b,c],"join"),f.then(function(a){"string"==typeof a?e.reject(new Error(a)):e.resolve(a)},e.reject)):e.resolve([]),e.promise}},{key:"keys",value:function(){return this.data.keys()}},{key:"limit",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,b=this,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,d=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return g(this.registry.slice(a,a+c).map(function(a){return b.get(a,d)}),d)}},{key:"load",value:function(){var a=this,b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"mongo",c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,d=void 0===c,e=d?this.id:c;return d&&this.clear(),this.cmd(b,"get",c).then(function(f){return a.logging&&console.log("Loaded",e,"from",b,"persistent storage"),d?a.batch(f,"set",!0):a.set(c,f,!0,!0,!0)},function(c){throw a.logging&&console.error("Error loading",e,"from",b,"persistent storage:",c.message||c.stack||c),c})}},{key:"map",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]&&arguments[1],c=[];return this.forEach(function(b,d){c.push(a(b,d))}),g(c,b)}},{key:"offload",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"index",c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.index,d=p(),e=void 0,f=void 0;return this.worker?(f=this.useWorker(d),f&&("index"===b&&(e={cmd:b,index:c,records:a,key:this.key,delimiter:this.delimiter,pattern:this.pattern}),"join"===b&&(e={cmd:b,ids:a[0],records:[a[1],a[2]],key:a[3],on:a[4],type:a[5]}),f.postMessage(JSON.stringify(e)))):d.reject(new Error(w)),d.promise}},{key:"onbatch",value:function(){}},{key:"onclear",value:function(){}},{key:"ondelete",value:function(){}},{key:"onerror",value:function(){}},{key:"onset",value:function(){}},{key:"onsync",value:function(){}},{key:"override",value:function(a){var b=this,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"records",d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0,e=p();return"indexes"===c?(this.indexes=this.transform(a,d),e.resolve(!0)):"records"===c?(this.data.clear(),this.indexes.clear(),this.registry.length=0,a.forEach(function(a){var c=a[b.key]||k();b.data.set(c,a),b.registry.push(c)}),this.total=this.data.size,e.resolve(!0)):e.reject(new Error("Invalid type")),e.promise}},{key:"register",value:function(a,b){return x[a]=b,this}},{key:"reindex",value:function(a){var b=this;return a?(this.index.indexOf(a)===-1&&this.index.push(a),this.indexes.set(a,new Map),this.forEach(function(c,d){setIndex(b.index,b.indexes,b.delimiter,d,c,a,b.pattern)})):(this.indexes.clear(),this.index.forEach(function(a){b.indexes.set(a,new Map)}),this.forEach(function(a,c){b.index.forEach(function(d){setIndex(b.index,b.indexes,b.delimiter,c,a,d,b.pattern)})})),this}},{key:"request",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c=p(),d=e(clone(this.config),b);return d.method=d.method.toUpperCase(),o(a,d).then(function(a){var b=a.status,d=void 0;a.headers._headers?(d={},Object.keys(a.headers._headers).forEach(function(b){d[b]=a.headers._headers[b].join(", ")})):d=j(a.headers),a[a.headers.get("content-type").indexOf("application/json")>-1?"json":"text"]().then(function(a){c[b<200||b>=400?"reject":"resolve"](q(a,b,d))},function(a){c.reject(q(a.message,b,d))})},function(a){c.reject(q(a.message,0,{}))}),c.promise}},{key:"save",value:function(){var a=this,b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"mongo";return this.cmd(b,"set").then(function(c){return a.logging&&console.log("Saved",a.id,"to",b,"persistent storage"),c},function(c){throw a.logging&&console.error("Error saving ",a.id,"to",b,"persistent storage:",c.message||c.stack||c),c})}},{key:"search",value:function(a,b){var c=this,d=arguments.length>2&&void 0!==arguments[2]&&arguments[2],e=[],f="function"==typeof a,h=a&&"function"==typeof a.test,i=new Set,j=void 0;return a&&(j=b?Array.isArray(b)?b:[b]:this.index,j.forEach(function(b){var g=c.indexes.get(b);g&&g.forEach(function(g,j){switch(!0){case f&&a(j,b):case h&&a.test(Array.isArray(j)?j.join(", "):j):case j===a:g.forEach(function(a){i.has(a)||(i.add(a),e.push(c.get(a,d)))})}})})),g(e,d)}},{key:"set",value:function(a,b){var f=arguments.length>2&&void 0!==arguments[2]&&arguments[2],g=this,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],j=arguments.length>4&&void 0!==arguments[4]&&arguments[4],l=p(),m="post",n=clone(b),o=a,r=void 0,s=void 0,t=void 0,u=function(a){var b=a?a[0]:{};null===o&&(g.key?(b=g.crawl(b),o=b[g.key]||n[g.key]||k()):o=k()),"post"===m?(g.registry[g.total]=o,++g.total,g.versioning&&g.versions.set(o,new Set)):(g.versioning&&g.versions.get(o).add(q(s)),d(g.index,g.indexes,g.delimiter,o,s,g.pattern)),g.data.set(o,n),setIndex(g.index,g.indexes,g.delimiter,o,n,null,g.pattern),l.resolve(g.get(o)),j||g.storage("set",o,n).then(function(a){a&&g.logging&&console.log("Saved",o,"to persistent storage")},function(a){g.logging&&console.error("Error saving",o,"to persistent storage:",a.message||a.stack||a)})};return void 0!==o&&null!==o||(o=n[this.key]||null),o&&this.data.has(o)&&(m="put",s=clone(this.data.get(o)||{}),i||(n=e(s,n))),f||(this.loading=!0),!f&&this.uri?(t=c(this.uri,o),this.patch?(r="post"===m?[{op:"add",path:"/",value:n}]:i?[{op:"replace",path:"/",value:n}]:h(s,n,this.key),this.request(t,{method:"patch",body:JSON.stringify(r,null,0)}).then(u,function(a){405===a[1]?(g.patch=!1,g.request(t,{method:m,body:JSON.stringify(n,null,0)}).then(u,l.reject)):l.reject(a)})):this.request(t,{method:m,body:JSON.stringify(n)}).then(u,l.reject)):u(),l.promise.then(function(a){return f||(g.loading=!1),g.onset(a),a},function(a){throw f||(g.loading=!1),g.onerror("set",a),a})}},{key:"setUri",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]&&arguments[1],c=p();return this.uri=a,this.uri?this.sync(b).then(c.resolve,c.reject):c.resolve([]),c.promise}},{key:"sort",value:function(a){var b=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],c=void 0;return c=b?Object.freeze(this.limit(0,this.total,!0).sort(a).map(function(a){return Object.freeze(a)})):this.limit(0,this.total,!0).sort(a)}},{key:"sortBy",value:function(a){var b=this,c=[],d=[],e=void 0;return this.indexes.has(a)||this.reindex(a),e=this.indexes.get(a),e.forEach(function(a,b){d.push(b)}),d.sort().forEach(function(a){e.get(a).forEach(function(a){c.push(b.get(a))})}),q.apply(q,c)}},{key:"storage",value:function(){for(var a=this,b=arguments.length,c=Array(b),d=0;d<b;d++)c[d]=arguments[d];var e=p(),f=Object.keys(this.adapters).map(function(b){return a.cmd.apply(a,[b].concat(c))});return f.length>0?n.all(f).then(function(){e.resolve(!0)},e.reject):e.resolve(!1),e.promise}},{key:"sync",value:function(){var a=this,b=arguments.length>0&&void 0!==arguments[0]&&arguments[0],c=p(),d=!0;return this.request(this.uri).then(function(e){var f=void 0;a.patch=(e[2].Allow||e[2].allow||"").indexOf("PATCH")>-1;try{f=a.crawl(e[0])}catch(a){d=!1,c.reject(a)}d&&(b&&a.clear(),a.batch(f,"set").then(c.resolve,c.reject))},function(a){c.reject(a[0]||a)}),c.promise.then(function(b){var c=q.apply(q,b);return a.onsync(c),c},function(b){throw a.onerror("sync",b),b})}},{key:"toArray",value:function(a){var b=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],c=void 0;return a?c=a.map(function(a){return b?a[1]:clone(a[1])}):(c=this.limit(0,this.total,!0),b&&c.forEach(function(a){Object.freeze(a)})),b?Object.freeze(c):c}},{key:"toObject",value:function(a){var b=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],c=void 0;return c=a?a.reduce(function(a,c){var d=clone(c[1]);return b&&Object.freeze(d),a[c[0]]=d,a},{}):j(this,b),b&&Object.freeze(c),c}},{key:"transform",value:function(a,b){return"function"==typeof b?b(a):cast(a)}},{key:"unload",value:function(){var a=this,b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"mongo",c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,d=void 0!==c?c:this.id;return this.cmd(b,"remove",c).then(function(c){return a.logging&&console.log("Unloaded",d,"from",b,"persistent storage"),c},function(c){throw a.logging&&console.error("Error unloading",d,"from",b,"persistent storage:",c.message||c.stack||c),c})}},{key:"unregister",value:function(a){delete x[a]}},{key:"values",value:function(){return this.data.values()}},{key:"useWorker",value:function(a){var b=void 0;return this.worker?(b=new s(this.worker),b.onerror=function(c){a.reject(c),b.terminate()},b.onmessage=function(c){a.resolve(JSON.parse(c.data)),b.terminate()}):a.reject(new Error(w)),b}}]),Haro}();l.transform=cast,l.version="3.0.8","undefined"!=typeof exports?module.exports=l:"function"==typeof define&&define.amd?define(function(){return l}):a.haro=l}("undefined"!=typeof window?window:global);
//# sourceMappingURL=haro.min.js.map