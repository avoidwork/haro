/*!
 2025 Jason Mulligan <jason.mulligan@avoidwork.com>
 @version 17.0.0
*/
import{randomUUID as t}from"crypto";class e extends Error{constructor(t,e,s){super(t),this.name=this.constructor.name,this.code=e,this.context=s,this.timestamp=(new Date).toISOString(),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}toJSON(){return{name:this.name,message:this.message,code:this.code,context:this.context,timestamp:this.timestamp,stack:this.stack}}}class s extends e{constructor(t,e,s){super(t,"VALIDATION_ERROR",{field:e,value:s})}}class i extends e{constructor(t,e){super(`Record with key '${t}' not found${e?` in store '${e}'`:""}`,"RECORD_NOT_FOUND",{key:t,storeName:e})}}class r extends e{constructor(t,e,s){super(t,"INDEX_ERROR",{indexName:e,operation:s})}}class n extends e{constructor(t,e,s){super(t,"CONFIGURATION_ERROR",{configKey:e,configValue:s})}}class o extends e{constructor(t,e,s){super(t,"QUERY_ERROR",{query:e,operation:s})}}class a extends e{constructor(t,e,s){super(t,"TRANSACTION_ERROR",{transactionId:e,operation:s})}}class h extends e{constructor(t,e,s,i){super(t,"TYPE_CONSTRAINT_ERROR",{expected:e,actual:s,field:i})}}class c extends e{constructor(t,e,s){super(t,"CONCURRENCY_ERROR",{resource:e,operation:s})}}class u{static isRecoverable(t){return t instanceof e&&["RECORD_NOT_FOUND","VALIDATION_ERROR","QUERY_ERROR","TYPE_CONSTRAINT_ERROR"].includes(t.code)}static getRecoveryActions(t){if(!(t instanceof e))return["Check error details and retry"];switch(t.code){case"RECORD_NOT_FOUND":return["Verify the record key is correct","Check if record was deleted","Use has() method to check existence before get()"];case"VALIDATION_ERROR":return["Check data types match expected schema","Verify required fields are present","Validate field constraints"];case"INDEX_ERROR":return["Verify index exists before querying","Check index configuration","Try reindexing the affected field"];case"CONFIGURATION_ERROR":return["Review configuration parameters","Check for typos in configuration keys","Refer to documentation for valid options"];case"QUERY_ERROR":return["Verify query syntax is correct","Check if indexed fields are being used","Simplify complex queries"];case"TRANSACTION_ERROR":return["Retry the transaction","Check for concurrent modifications","Reduce transaction scope"];case"TYPE_CONSTRAINT_ERROR":return["Check data types match schema","Convert data to expected type","Update type constraints if needed"];default:return["Check error details and retry"]}}static createRecoveryStrategy(t){return{error:t,isRecoverable:this.isRecoverable(t),actions:this.getRecoveryActions(t),retryable:["CONCURRENCY_ERROR","TRANSACTION_ERROR"].includes(t.code),backoffMs:"CONCURRENCY_ERROR"===t.code?100:0}}}const l={STRING:"string",NUMBER:"number",BOOLEAN:"boolean",OBJECT:"object",ARRAY:"array",DATE:"date",UUID:"uuid",EMAIL:"email",URL:"url",ANY:"any"};class f{static getValueType(t){if(null===t)return"null";if(Array.isArray(t))return l.ARRAY;if(t instanceof Date)return l.DATE;const e=typeof t;if("string"===e){if(f.isUUID(t))return l.UUID;if(f.isEmail(t))return l.EMAIL;if(f.isURL(t))return l.URL}return e}static isTypeMatch(t,e){return t===e||e===l.STRING&&["string",l.UUID,l.EMAIL,l.URL].includes(t)}static isUUID(t){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(t)}static isEmail(t){return/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/.test(t)}static isURL(t){try{const e=new URL(t);return Boolean(e)}catch{return!1}}}class d{constructor({type:t=l.ANY,required:e=!1,default:s,validator:i,min:r,max:n,enum:o,pattern:a}={}){this.type=t,this.required=e,this.default=s,this.validator=i,this.min=r,this.max=n,this.enum=o,this.pattern=a}validate(t,e="field"){if(null==t){if(this.required)throw new s(`Field '${e}' is required`,e,t);return void 0!==this.default?this.default:t}const i=f.getValueType(t);if(this.type!==l.ANY&&!f.isTypeMatch(i,this.type))throw new h(`Field '${e}' expected type '${this.type}' but got '${i}'`,this.type,i,e);if(void 0!==this.min&&this.min>t)throw new s(`Field '${e}' value ${t} is below minimum ${this.min}`,e,t);if(void 0!==this.max&&t>this.max)throw new s(`Field '${e}' value ${t} exceeds maximum ${this.max}`,e,t);if(("string"==typeof t||Array.isArray(t))&&void 0!==t.length){if(void 0!==this.min&&this.min>t.length)throw new s(`Field '${e}' length ${t.length} is below minimum ${this.min}`,e,t);if(void 0!==this.max&&t.length>this.max)throw new s(`Field '${e}' length ${t.length} exceeds maximum ${this.max}`,e,t)}if(this.enum&&!this.enum.includes(t))throw new s(`Field '${e}' value '${t}' is not in allowed values: ${this.enum.join(", ")}`,e,t);if(this.pattern&&"string"==typeof t&&!this.pattern.test(t))throw new s(`Field '${e}' value '${t}' does not match required pattern`,e,t);if(this.validator&&"function"==typeof this.validator){const i=this.validator(t,e);if(!0!==i&&void 0!==i)throw new s("string"==typeof i?i:`Custom validation failed for field '${e}'`,e,t)}return t}}class p{constructor(t={},{strict:e=!1,stripUnknown:s=!1}={}){this.fields=t,this.strict=e,this.stripUnknown=s}validate(t){if(!t||"object"!=typeof t||Array.isArray(t))throw new s("Record must be an object","record",t);const e={},i=Object.keys(this.fields),r=Object.keys(t);for(const s of i)e[s]=this.fields[s].validate(t[s],s);const n=r.filter(t=>!i.includes(t));if(n.length>0){if(this.strict)throw new s(`Unknown fields not allowed: ${n.join(", ")}`,"record",t);if(!this.stripUnknown)for(const s of n)e[s]=t[s]}return e}addField(t,e){return this.fields[t]=e,this}removeField(t){return delete this.fields[t],this}}class y{static validate(t={}){const e={...t};if(void 0!==e.delimiter&&("string"!=typeof e.delimiter||0===e.delimiter.length))throw new n("Delimiter must be a non-empty string","delimiter",e.delimiter);if(void 0!==e.id&&"string"!=typeof e.id)throw new n("ID must be a string","id",e.id);if(void 0!==e.immutable&&"boolean"!=typeof e.immutable)throw new n("Immutable must be a boolean","immutable",e.immutable);if(void 0!==e.index){if(!Array.isArray(e.index))throw new n("Index must be an array","index",e.index);for(const t of e.index)if("string"!=typeof t)throw new n("Index field names must be strings","index",t)}if(void 0!==e.key&&"string"!=typeof e.key)throw new n("Key field must be a string","key",e.key);if(void 0!==e.versioning&&"boolean"!=typeof e.versioning)throw new n("Versioning must be a boolean","versioning",e.versioning);if(void 0!==e.schema&&!(e.schema instanceof p))throw new n("Schema must be an instance of Schema class","schema",e.schema);return e}}const w={requiredString:(t={})=>new d({type:l.STRING,required:!0,...t}),optionalString:(t={})=>new d({type:l.STRING,required:!1,...t}),requiredNumber:(t={})=>new d({type:l.NUMBER,required:!0,...t}),optionalNumber:(t={})=>new d({type:l.NUMBER,required:!1,...t}),uuid:(t=!0)=>new d({type:l.UUID,required:t}),email:(t=!0)=>new d({type:l.EMAIL,required:t}),enum:(t,e=!0)=>new d({enum:t,required:e}),date:(t=!0)=>new d({type:l.DATE,required:t})},m="pending",_="active",g="committed",R="aborted",b="set",S="delete",O={READ_UNCOMMITTED:0,READ_COMMITTED:1,REPEATABLE_READ:2,SERIALIZABLE:3},A="shared",x="exclusive";class v{constructor(t,e,s={}){this.t=t,this.i=e,this.o={createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),version:1,...s},Object.freeze(this)}get key(){return this.t}get data(){return Object.freeze({...this.i})}get metadata(){return Object.freeze({...this.o})}get(t){return this.i[t]}has(t){return t in this.i}getFields(){return Object.keys(this.i)}update(t,e={}){const s={...this.i,...t},i={...this.o,...e,updatedAt:(new Date).toISOString(),version:this.o.version+1};return new v(this.t,s,i)}toObject(t=!1){const e={...this.i};return t&&(e.o=this.o),e}toJSON(t=!1){return JSON.stringify(this.toObject(t))}equals(t){return t instanceof v&&this.t===t.t&&JSON.stringify(this.i)===JSON.stringify(t.i)}clone(){return new v(this.t,structuredClone(this.i),structuredClone(this.o))}getSize(){return 2*JSON.stringify(this.i).length}matches(t){return"function"==typeof t?t(this.i,this.t,this):"object"==typeof t&&null!==t&&Object.entries(t).every(([t,e])=>{const s=this.i[t];return e instanceof RegExp?e.test(s):Array.isArray(e)?Array.isArray(s)?e.some(t=>s.includes(t)):e.includes(s):s===e})}toString(){return`Record(${this.t}: ${JSON.stringify(this.i)})`}*[Symbol.iterator](){for(const[t,e]of Object.entries(this.i))yield[t,e]}}class C{constructor(t=[]){this.h=[...t],Object.freeze(this)}get length(){return this.h.length}at(t){return this.h[t]}first(){return this.h[0]}last(){return this.h[this.h.length-1]}filter(t){return new C(this.h.filter(t))}map(t){return this.h.map(t)}find(t){return this.h.find(t)}some(t){return this.h.some(t)}every(t){return this.h.every(t)}sort(t){return new C([...this.h].sort(t))}slice(t=0,e){return new C(this.h.slice(t,e))}reduce(t,e){return this.h.reduce(t,e)}toArray(){return[...this.h]}toObjects(t=!1){return this.h.map(e=>e.toObject(t))}toPairs(){return this.h.map(t=>[t.key,t.data])}groupBy(t){const e=new Map,s="function"==typeof t?t:e=>e.get(t);for(const t of this.h){const i=s(t);e.has(i)||e.set(i,[]),e.get(i).push(t)}for(const[t,s]of e)e.set(t,new C(s));return e}unique(){const t=new Set,e=[];for(const s of this.h)t.has(s.key)||(t.add(s.key),e.push(s));return new C(e)}forEach(t){this.h.forEach(t)}*[Symbol.iterator](){for(const t of this.h)yield t}toString(){return`RecordCollection(${this.h.length} records)`}}const E={create:(t,e,s={})=>new v(t,e,s),fromObject(t,e="id",s={}){const i=t[e];if(!i)throw new Error(`Key field '${e}' not found in data`);return new v(i,t,s)},createCollection(t,e="id"){const s=t.map(t=>t instanceof v?t:this.fromObject(t,e));return new C(s)},emptyCollection:()=>new C},T={SINGLE:"single",COMPOSITE:"composite",ARRAY:"array",PARTIAL:"partial"};class k{constructor(t,e,{type:s=T.SINGLE,unique:i=!1,filter:r,transform:n,delimiter:o="|"}={}){this.name=t,this.fields=Array.isArray(e)?e:[e],this.type=this.u(this.fields,s),this.unique=i,this.filter=r,this.transform=n,this.delimiter=o,this.createdAt=new Date,this.stats={totalKeys:0,totalEntries:0,memoryUsage:0,lastUpdated:new Date}}u(t,e){return e===T.PARTIAL?T.PARTIAL:t.length>1?T.COMPOSITE:T.SINGLE}generateKeys(t){if(this.filter&&!this.filter(t))return[];const e=this.l(t);return this.transform?e.map(e=>this.transform(e,t)):e}l(t){if(this.type===T.COMPOSITE)return this.p(t);const e=t[this.fields[0]];return null==e?[]:Array.isArray(e)?e.map(t=>String(t)):[String(e)]}p(t){let e=[""];for(const s of this.fields.sort()){const i=t[s];if(null==i)return[];const r=Array.isArray(i)?i:[i],n=[];for(const t of e)for(const e of r){const s=""===t?String(e):`${t}${this.delimiter}${String(e)}`;n.push(s)}e=n}return e}updateStats(t,e,s){this.stats.totalKeys=t,this.stats.totalEntries=e,this.stats.memoryUsage+=s,this.stats.lastUpdated=new Date}}class I{constructor(){this.m=new Map,this._=new Map}add(t,e){this.m.has(t)||(this.m.set(t,new Set),this._.set(t,0));const s=this.m.get(t);s.has(e)||(s.add(e),this._.set(t,this._.get(t)+1))}remove(t,e){const s=this.m.get(t);if(!s)return!1;const i=s.delete(e);if(i){const e=this._.get(t)-1;0===e?(this.m.delete(t),this._.delete(t)):this._.set(t,e)}return i}get(t){return this.m.get(t)||new Set}has(t){return this.m.has(t)}keys(){return Array.from(this.m.keys())}getStats(){let t=0;for(const e of this.m.values())t+=e.size;return{totalKeys:this.m.size,totalEntries:t,memoryUsage:this.R()}}clear(){this.m.clear(),this._.clear()}R(){let t=0;for(const[e,s]of this.m){t+=2*e.length,t+=64;for(const e of s)t+=2*e.length}return t}}class D{constructor(t="|"){this.delimiter=t,this.S=new Map,this.O=new Map,this.A={totalOperations:0,totalTime:0,lastOptimized:new Date}}createIndex(t,e,s={}){if(this.S.has(t))throw new r(`Index '${t}' already exists`,t,"create");const i=new k(t,e,{delimiter:this.delimiter,...s});return this.S.set(t,i),this.O.set(t,new I),this}dropIndex(t){if(!this.S.has(t))throw new r(`Index '${t}' does not exist`,t,"drop");return this.S.delete(t),this.O.delete(t),this}hasIndex(t){return this.S.has(t)}getIndexDefinition(t){return this.S.get(t)}listIndexes(){return Array.from(this.S.keys())}addRecord(t,e){const s=Date.now();for(const[s,i]of this.S){const n=this.O.get(s),o=i.generateKeys(e);for(const e of o){if(i.unique&&n.has(e)){const i=n.get(e);if(i.size>0&&!i.has(t))throw new r(`Unique constraint violation on index '${s}' for value '${e}'`,s,"add")}n.add(e,t)}const a=n.getStats();i.updateStats(a.totalKeys,a.totalEntries,0)}this.v(Date.now()-s)}removeRecord(t,e){const s=Date.now();for(const[s,i]of this.S){const r=this.O.get(s),n=i.generateKeys(e);for(const e of n)r.remove(e,t);const o=r.getStats();i.updateStats(o.totalKeys,o.totalEntries,0)}this.v(Date.now()-s)}updateRecord(t,e,s){this.removeRecord(t,e),this.addRecord(t,s)}findByIndex(t,e){const s=this.O.get(t);if(!s)throw new r(`Index '${t}' does not exist`,t,"query");return new Set(s.get(e))}findByCriteria(t){const e=Object.keys(t);if(0===e.length)return new Set;let s=null;for(const i of e){const e=String(t[i]),r=this.findByIndex(i,e);if(s=null===s?r:new Set([...s].filter(t=>r.has(t))),0===s.size)break}return s}getOptimalIndex(t){const e=[...t].sort();for(const[t,s]of this.S){const i=[...s.fields].sort();if(JSON.stringify(i)===JSON.stringify(e))return t}for(const[e,s]of this.S)if(t.every(t=>s.fields.includes(t)))return e;const s=[];for(const[e,i]of this.S){const r=t.filter(t=>i.fields.includes(t)).length;r>0&&s.push({name:e,coverage:r,fields:i.fields.length})}return s.length>0?(s.sort((t,e)=>t.coverage!==e.coverage?e.coverage-t.coverage:t.fields-e.fields),s[0].name):null}rebuild(t){for(const t of this.O.values())t.clear();for(const[e,s]of t)this.addRecord(e,s);this.A.lastOptimized=new Date}getStats(){const t={};let e=0;for(const[s,i]of this.S){const r=this.O.get(s).getStats();t[s]={...i.stats,...r,type:i.type,fields:i.fields},e+=r.memoryUsage}return{indexes:t,totalIndexes:this.S.size,totalMemoryUsage:e,performance:{...this.A,averageOperationTime:this.A.totalOperations>0?this.A.totalTime/this.A.totalOperations:0}}}clear(){for(const t of this.O.values())t.clear()}v(t){this.A.totalOperations++,this.A.totalTime+=t}}const M={COUNT:"count",TIME:"time",SIZE:"size",NONE:"none"};class ${constructor(t,e={}){this.data=Object.freeze(structuredClone(t)),this.timestamp=new Date,this.size=this.C(t),this.metadata=Object.freeze({operation:"update",...e}),Object.freeze(this)}C(t){try{return 2*JSON.stringify(t).length}catch{return 1024}}isOlderThan(t){return Date.now()-this.timestamp.getTime()>t}getAge(){return Date.now()-this.timestamp.getTime()}toObject(){return{data:this.data,timestamp:this.timestamp.toISOString(),size:this.size,metadata:this.metadata}}}class N{constructor(t,e={}){this.recordKey=t,this.policy=e,this.versions=[],this.totalSize=0,this.createdAt=new Date,this.lastAccessed=new Date}addVersion(t,e={}){const s=new $(t,e);return this.versions.push(s),this.totalSize+=s.size,this.lastAccessed=new Date,this.T(),s}getVersion(t){return this.lastAccessed=new Date,0>t?this.versions[this.versions.length+t]:this.versions[t]}getLatest(){return this.getVersion(-1)}getOldest(){return this.getVersion(0)}getVersionsInRange(t,e){return this.lastAccessed=new Date,this.versions.filter(s=>{const i=s.timestamp;return!(t&&t>i||e&&i>e)})}getCount(){return this.versions.length}getTotalSize(){return this.totalSize}clear(){const t=this.versions.length;return this.versions=[],this.totalSize=0,t}removeOlderThan(t){const e=this.versions.length,s=Date.now()-t;return this.versions=this.versions.filter(t=>{const e=t.timestamp.getTime()>=s;return e||(this.totalSize-=t.size),e}),e-this.versions.length}T(){if(!this.policy||this.policy.type===M.NONE)return 0;let t=0;switch(this.policy.type){case M.COUNT:t=this.k();break;case M.TIME:t=this.I();break;case M.SIZE:t=this.D();break;default:t=0}return t}k(){const t=this.policy.maxCount||10;if(t>=this.versions.length)return 0;const e=this.versions.splice(0,this.versions.length-t);for(const t of e)this.totalSize-=t.size;return e.length}I(){return this.removeOlderThan(this.policy.maxAge||2592e6)}D(){const t=this.policy.maxSize||10485760;if(t>=this.totalSize)return 0;let e=0;for(;this.totalSize>t&&this.versions.length>1;){const t=this.versions.shift();this.totalSize-=t.size,e++}return e}getStats(){return{recordKey:this.recordKey,versionCount:this.versions.length,totalSize:this.totalSize,averageSize:this.versions.length>0?this.totalSize/this.versions.length:0,oldestVersion:this.versions.length>0?this.versions[0].timestamp:null,newestVersion:this.versions.length>0?this.versions[this.versions.length-1].timestamp:null,createdAt:this.createdAt,lastAccessed:this.lastAccessed,policy:this.policy}}}class j{constructor(t={}){this.globalPolicy=this.M(t),this.histories=new Map,this.stats={totalHistories:0,totalVersions:0,totalSize:0,lastCleanup:new Date,cleanupCount:0}}enableVersioning(t,e){if(this.histories.has(t))return this.histories.get(t);const s=new N(t,e||this.globalPolicy);return this.histories.set(t,s),this.stats.totalHistories++,s}disableVersioning(t){const e=this.histories.get(t);return!!e&&(this.stats.totalVersions-=e.getCount(),this.stats.totalSize-=e.getTotalSize(),this.stats.totalHistories--,this.histories.delete(t))}addVersion(t,e,s={}){let i=this.histories.get(t);i||(i=this.enableVersioning(t));const r=i.getCount(),n=i.getTotalSize(),o=i.addVersion(e,s);return this.stats.totalVersions+=i.getCount()-r,this.stats.totalSize+=i.getTotalSize()-n,o}getHistory(t){return this.histories.get(t)}getVersion(t,e){const s=this.histories.get(t);return s?s.getVersion(e):void 0}getLatestVersion(t){const e=this.histories.get(t);return e?e.getLatest():void 0}isVersioningEnabled(t){return this.histories.has(t)}cleanup(t={}){const{recordKeys:e}=t,s={historiesProcessed:0,versionsRemoved:0,sizeFreed:0,startTime:new Date},i=e||Array.from(this.histories.keys());for(const t of i){const e=this.histories.get(t);if(e){const i=e.getCount(),r=e.getTotalSize();e.T();const n=e.getCount(),o=e.getTotalSize();s.historiesProcessed++,s.versionsRemoved+=i-n,s.sizeFreed+=r-o,0===n&&(this.histories.delete(t),this.stats.totalHistories--)}}return this.stats.totalVersions-=s.versionsRemoved,this.stats.totalSize-=s.sizeFreed,this.stats.lastCleanup=new Date,this.stats.cleanupCount++,s.endTime=new Date,s.duration=s.endTime.getTime()-s.startTime.getTime(),s}setGlobalPolicy(t){return this.globalPolicy=this.M(t),this}getStats(){let t=0,e=0;const s=[];for(const i of this.histories.values()){const r=i.getStats();s.push(r),t+=r.versionCount,e+=r.totalSize}return{...this.stats,totalHistories:this.histories.size,totalVersions:t,totalSize:e,averageVersionsPerRecord:this.histories.size>0?t/this.histories.size:0,averageSizePerRecord:this.histories.size>0?e/this.histories.size:0,globalPolicy:this.globalPolicy,histories:s}}export(t){const e=t||Array.from(this.histories.keys()),s={globalPolicy:this.globalPolicy,histories:{},exportedAt:(new Date).toISOString()};for(const t of e){const e=this.histories.get(t);e&&(s.histories[t]={policy:e.policy,versions:e.versions.map(t=>t.toObject()),createdAt:e.createdAt.toISOString(),lastAccessed:e.lastAccessed.toISOString()})}return s}import(t,e={}){const{merge:s=!1}=e,i={historiesImported:0,versionsImported:0,errors:[]};s||this.histories.clear(),t.globalPolicy&&(this.globalPolicy=this.M(t.globalPolicy));for(const[e,s]of Object.entries(t.histories))try{const t=new N(e,s.policy);t.createdAt=new Date(s.createdAt),t.lastAccessed=new Date(s.lastAccessed);for(const e of s.versions){const s=new $(e.data,e.metadata);Object.defineProperty(s,"timestamp",{value:new Date(e.timestamp),writable:!1}),t.versions.push(s),t.totalSize+=s.size,i.versionsImported++}this.histories.set(e,t),i.historiesImported++}catch(t){i.errors.push({recordKey:e,error:t.message})}return this.$(),i}clear(){const t={historiesCleared:this.histories.size,versionsCleared:this.stats.totalVersions,sizeFreed:this.stats.totalSize};return this.histories.clear(),this.stats={totalHistories:0,totalVersions:0,totalSize:0,lastCleanup:new Date,cleanupCount:this.stats.cleanupCount},t}M(t){if(!t||"object"!=typeof t)return{type:M.NONE};const e=Object.values(M);if(t.type&&!e.includes(t.type))throw new n(`Invalid retention policy type: ${t.type}`,"retentionPolicy.type",t.type);const s={...t};if(s.type===M.COUNT&&void 0!==s.maxCount&&("number"!=typeof s.maxCount||1>s.maxCount))throw new n("maxCount must be a positive number","retentionPolicy.maxCount",s.maxCount);if(s.type===M.TIME&&void 0!==s.maxAge&&("number"!=typeof s.maxAge||1>s.maxAge))throw new n("maxAge must be a positive number","retentionPolicy.maxAge",s.maxAge);if(s.type===M.SIZE&&void 0!==s.maxSize&&("number"!=typeof s.maxSize||1>s.maxSize))throw new n("maxSize must be a positive number","retentionPolicy.maxSize",s.maxSize);return s}$(){let t=0,e=0;for(const s of this.histories.values())t+=s.getCount(),e+=s.getTotalSize();this.stats.totalHistories=this.histories.size,this.stats.totalVersions=t,this.stats.totalSize=e}}class L{constructor(e,s,i,r,n={}){this.id=t(),this.type=e,this.key=s,this.oldValue=i,this.newValue=r,this.metadata=n,this.timestamp=new Date,Object.freeze(this)}createRollback(){switch(this.type){case b:return void 0===this.oldValue?new L(S,this.key,this.newValue,void 0):new L(b,this.key,this.newValue,this.oldValue);case S:return new L(b,this.key,void 0,this.oldValue);default:throw new a(`Cannot create rollback for operation type: ${this.type}`,null,"rollback")}}}class U{constructor(e=t(),s={}){this.id=e,this.state=m,this.isolationLevel=s.isolationLevel||O.READ_COMMITTED,this.timeout=s.timeout||6e4,this.readOnly=s.readOnly||!1,this.startTime=null,this.endTime=null,this.operations=[],this.readSet=new Set,this.writeSet=new Set,this.snapshot=new Map,this.validationCallback=null,this.abortReason=null,Object.seal(this)}begin(){if(this.state!==m)throw new a(`Cannot begin transaction in state: ${this.state}`,this.id,"begin");return this.state=_,this.startTime=new Date,this}addOperation(t,e,s,i,r={}){if(this.N(),this.readOnly&&"read"!==t)throw new a("Cannot perform write operations in read-only transaction",this.id,"write");if(this.j())throw new a("Transaction has timed out",this.id,"timeout");const n=new L(t,e,s,i,r);return this.operations.push(n),"read"===t?this.readSet.add(e):this.writeSet.add(e),n}setValidation(t){return this.validationCallback=t,this}validate(t={}){if(this.validationCallback){const e=this.validationCallback(this,t);if(!0!==e)throw new a("string"==typeof e?e:"Transaction validation failed",this.id,"validation")}return!0}commit(t={}){this.N();try{return this.validate(t),this.state=g,this.endTime=new Date,this}catch(t){throw this.abort(),t}}abort(t="User abort"){return this.state===R||this.state===g||(this.state=R,this.endTime=new Date,this.abortReason=t),this}getRollbackOperations(){return this.operations.slice().reverse().filter(t=>"read"!==t.type).map(t=>t.createRollback()).filter(t=>null!==t)}isActive(){return this.state===_}isCommitted(){return this.state===g}isAborted(){return this.state===R}getDuration(){return this.startTime?(this.endTime||new Date).getTime()-this.startTime.getTime():null}getStats(){return{id:this.id,state:this.state,isolationLevel:this.isolationLevel,readOnly:this.readOnly,startTime:this.startTime,endTime:this.endTime,duration:this.getDuration(),operationCount:this.operations.length,readSetSize:this.readSet.size,writeSetSize:this.writeSet.size,snapshotSize:this.snapshot.size,abortReason:this.abortReason,timedOut:this.j()}}export(){return{...this.getStats(),operations:this.operations.map(t=>({id:t.id,type:t.type,key:t.key,timestamp:t.timestamp,metadata:t.metadata})),readSet:Array.from(this.readSet),writeSet:Array.from(this.writeSet)}}N(){if(this.state!==_)throw new a(`Transaction is not active (current state: ${this.state})`,this.id,"state")}j(){return!!this.startTime&&Date.now()-this.startTime.getTime()>this.timeout}}class P{constructor(){this.locks=new Map,this.lockTimeout=3e4}async acquireLock(t,e,s,i=this.lockTimeout){const r=Date.now();for(;Date.now()-r<i;){if(this.L(t,e,s))return!0;await new Promise(t=>setTimeout(t,10))}throw new c(`Failed to acquire ${s} lock on record '${e}' within timeout`,e,"lock")}L(t,e,s){const i=this.locks.get(e);return i?i.holders.has(t)?i.type!==A||s!==x||1===i.holders.size&&(i.type=x,!0):s===A&&i.type===A&&(i.holders.add(t),!0):(this.locks.set(e,{type:s,holders:new Set([t]),waiters:[]}),!0)}releaseLock(t,e){const s=this.locks.get(e);return!(!s||!s.holders.has(t)||(s.holders.delete(t),0===s.holders.size&&this.locks.delete(e),0))}releaseAllLocks(t){let e=0;for(const[s,i]of this.locks)i.holders.has(t)&&(i.holders.delete(t),e++,0===i.holders.size&&this.locks.delete(s));return e}holdsLocks(t){for(const e of this.locks.values())if(e.holders.has(t))return!0;return!1}getStats(){const t={totalLocks:this.locks.size,sharedLocks:0,exclusiveLocks:0,lockHolders:new Set,recordsLocked:[]};for(const[e,s]of this.locks){s.type===A?t.sharedLocks++:t.exclusiveLocks++;for(const e of s.holders)t.lockHolders.add(e);t.recordsLocked.push({recordKey:e,type:s.type,holders:Array.from(s.holders)})}return t.uniqueHolders=t.lockHolders.size,t}}class z{constructor(){this.stats={totalTransactions:0,committedTransactions:0,abortedTransactions:0,activeTransactions:0,averageDuration:0,totalDuration:0}}incrementTotal(){this.stats.totalTransactions++}incrementCommitted(){this.stats.committedTransactions++}incrementAborted(){this.stats.abortedTransactions++}incrementActive(){this.stats.activeTransactions++}decrementActive(){this.stats.activeTransactions--}updateDurationStats(t){const e=t.getDuration();null!==e&&(this.stats.totalDuration+=e,this.stats.averageDuration=this.stats.totalDuration/(this.stats.committedTransactions+this.stats.abortedTransactions))}getStats(t,e,s){return{...this.stats,activeTransactions:e,lockStats:t,transactionCounter:s}}reset(){this.stats={totalTransactions:0,committedTransactions:0,abortedTransactions:0,activeTransactions:0,averageDuration:0,totalDuration:0}}getRawStats(){return{...this.stats}}}class F{constructor(){this.patternCache=new Map,this.semanticCache=new Map}areKeysRelated(t,e){return!!(t===e||this.U(t,e)||this.P(t,e)||this.F(t,e)||this.V(t,e)||this.q(t,e)||this.K(t,e)||this.H(t,e)||this.B(t,e))}isKeyInSnapshotRange(t,e,s,i){return e===s||(this.G(t,s)?this.Y(t,e,s):this.J(s)?this.W(e,s):this.X(e,s)?this.Z(e,s,i):this.tt(t,s)?this.et(t,e,s):this.st(e,s)?this.it(e,s):this.rt(s)?this.nt(e,s):!!this.ot(s)&&this.ht(e,s))}keyMatchesRange(t,e){if(void 0!==e.min&&void 0!==e.max)return t>=e.min&&e.max>=t;if(void 0!==e.prefix)return t.startsWith(e.prefix);if(void 0!==e.pattern)try{return new RegExp(e.pattern).test(t)}catch{return!1}return!1}keyMatchesQuery(t,e){if("range"===e.type)return this.keyMatchesRange(t,e);if("prefix"===e.type)return t.startsWith(e.prefix||"");if("pattern"===e.type)try{return new RegExp(e.pattern||"").test(t)}catch{return!1}return"in"===e.type&&Array.isArray(e.values)&&e.values.includes(t)}keyMatchesIndexRange(t,e){if(e.fields&&Array.isArray(e.fields))for(const s of e.fields)if(t.includes(s))return!0;return!!e.values&&this.keyMatchesRange(t,e.values)}U(t,e){const s=[":","/",".","_","-"];for(const i of s)if(t.includes(i)&&e.includes(i)){const s=t.split(i),r=e.split(i);if(this.ct(s,r)||this.ut(s,r)||this.lt(s,r))return!0}return t.startsWith(e)||e.startsWith(t)}X(t,e){const s=[":","/",".","_","-"];for(const i of s)if(t.includes(i)&&e.includes(i))return!0;return!1}Z(t,e,s){const i=[":","/",".","_","-"];for(const r of i)if(t.includes(r)&&e.includes(r)){const i=t.split(r),n=e.split(r);if(this.ct(i,n)||this.ut(i,n)||this.ft(i,n,s))return!0}return!1}ct(t,e){if(t.length>e.length){for(let s=0;e.length>s;s++)if(t[s]!==e[s])return!1;return!0}if(e.length>t.length){for(let s=0;t.length>s;s++)if(t[s]!==e[s])return!1;return!0}return!1}ut(t,e){if(t.length===e.length&&t.length>1){for(let s=0;t.length-1>s;s++)if(t[s]!==e[s])return!1;return t[t.length-1]!==e[e.length-1]}return!1}lt(t,e){const s=e.length>t.length?t:e,i=e.length>t.length?e:t;if(i.length>s.length){for(let t=0;s.length>t;t++)if(s[t]!==i[t])return!1;return!0}return!1}ft(t,e,s){return!!(Array.isArray(s)||s&&"object"==typeof s&&void 0!==s.length)&&(this.ct(t,e)||this.ut(t,e))}P(t,e){const s=this.dt(t),i=this.dt(e);for(const t of s)for(const e of i)if(this.yt(t,e))return!0;return this.wt(s,i)}st(t,e){const s=["user","account","profile","session","order","product","cart","payment","post","comment","thread","message","document","file","folder","workspace"];for(const i of s)if(t.toLowerCase().includes(i)&&e.toLowerCase().includes(i))return!0;return!1}it(t,e){const s=this.dt(t),i=this.dt(e);for(const t of s)for(const e of i)if(this.yt(t,e))return!0;return!1}dt(t){const e=`semantic:${t}`;if(this.semanticCache.has(e))return this.semanticCache.get(e);const s=[],i=[/(\w+):(\w+)/g,/(\w+)_(\w+)/g,/([a-z]+)([A-Z]\w+)/g];for(const e of i){let i;for(;null!==(i=e.exec(t));)s.push(i[1].toLowerCase()),i[2]&&s.push(i[2].toLowerCase())}return this.semanticCache.set(e,s),s}yt(t,e){if(t===e)return!0;const s=[["user","users"],["account","accounts"],["profile","profiles"],["order","orders"],["product","products"],["item","items"],["post","posts"],["comment","comments"],["message","messages"],["file","files"],["document","documents"],["folder","folders"]];for(const[i,r]of s)if(t===i&&e===r||t===r&&e===i)return!0;return!1}wt(t,e){const s=[["user","profile"],["user","account"],["user","session"],["profile","account"],["account","session"],["user","order"],["user","cart"],["user","payment"],["order","product"],["order","payment"],["cart","product"],["user","post"],["user","comment"],["user","message"],["post","comment"],["thread","message"],["document","file"],["user","workspace"],["workspace","document"],["workspace","folder"],["folder","file"],["document","file"]];for(const[i,r]of s){const s=t.includes(i)&&e.includes(r),n=t.includes(r)&&e.includes(i);if(s||n)return!0}return!1}F(t,e){return this.J(t)?this.W(e,t):this.J(e)?this.W(t,e):this._t(t,e)}J(t){return t.includes("*")||t.includes("?")||t.includes("[")||t.includes("{")||t.endsWith("_range")||t.endsWith("_pattern")}W(t,e){if(e.includes("*")){const s=e.replace(/\*/g,".*");try{return new RegExp(`^${s}$`).test(t)}catch{const s=e.split("*")[0];return t.startsWith(s)}}if(e.includes("?")){const s=e.replace(/\?/g,".");try{return new RegExp(`^${s}$`).test(t)}catch{return!1}}if(e.includes("["))try{return new RegExp(`^${e}$`).test(t)}catch{return!1}if(e.includes("{")&&e.includes("}")){const s=e.substring(0,e.indexOf("{")),i=e.substring(e.indexOf("}")+1),r=e.substring(e.indexOf("{")+1,e.indexOf("}")).split(",");for(const e of r){const r=s+e.trim()+i;if(t===r||t.startsWith(r))return!0}}if(e.endsWith("_range")||e.endsWith("_pattern")){const s=e.replace(/_range$|_pattern$/,"");return t.startsWith(s)}return!1}_t(t,e){const s=this.gt(t),i=this.gt(e);return this.Rt(s,i)}gt(t){const e=`pattern:${t}`;if(this.patternCache.has(e))return this.patternCache.get(e);const s=t.replace(/\d+/g,"#").replace(/[a-f0-9]{8,}/g,"&").replace(/\w{1,3}(?=:|_|-)/g,"@");return this.patternCache.set(e,s),s}Rt(t,e){return t===e||this.bt(t,e)>.7}bt(t,e){const s=Math.max(t.length,e.length);return 0===s?1:1-this.St(t,e)/s}St(t,e){const s=[];for(let t=0;e.length>=t;t++)s[t]=[t];for(let e=0;t.length>=e;e++)s[0][e]=e;for(let i=1;e.length>=i;i++)for(let r=1;t.length>=r;r++)s[i][r]=e.charAt(i-1)===t.charAt(r-1)?s[i-1][r-1]:Math.min(s[i-1][r-1]+1,s[i][r-1]+1,s[i-1][r]+1);return s[e.length][t.length]}q(t,e){if(this.rt(t)&&this.rt(e)){const s=this.Ot(t),i=this.Ot(e);return this.At(s,i)}return!1}rt(t){return["timestamp","time","date","created","updated","modified","datetime","ts","epoch","iso","utc","log","event","history"].some(e=>t.toLowerCase().includes(e))}nt(t,e){if(this.rt(t)){const s=this.Ot(t),i=this.Ot(e);return this.At(s,i)}return!1}Ot(t){const e={hasDate:!1,hasTime:!1,hasTimestamp:!1,hasEpoch:!1};return/\d{4}-\d{2}-\d{2}/.test(t)&&(e.hasDate=!0),/\d{2}:\d{2}:\d{2}/.test(t)&&(e.hasTime=!0),/\d{13}/.test(t)&&(e.hasTimestamp=!0),/\d{10}/.test(t)&&(e.hasEpoch=!0),e}At(t,e){return t.hasDate&&e.hasDate||t.hasTime&&e.hasTime||t.hasTimestamp&&e.hasTimestamp||t.hasEpoch&&e.hasEpoch}V(t,e){return this.ht(t,e)||this.ht(e,t)}ot(t){return t.includes(":")||t.includes("#")||t.includes("|")||t.includes("@")||t.split("_").length>2||t.split("-").length>2}ht(t,e){const s=[":","#","|","@","_","-"];for(const i of s)if(t.includes(i)&&e.includes(i)){const s=t.split(i),r=e.split(i);if(this.xt(s,r))return!0}return!1}xt(t,e){const s=Math.min(t.length,e.length);for(let i=1;s>=i;i++){let s=!0;for(let r=0;i>r;r++)if(t[r]!==e[r]){s=!1;break}if(s)return!0}return!1}K(t,e){const s=this.vt(t),i=this.vt(e);if(s||i){const s=this.Ct(t),i=this.Ct(e);return s===i||t.startsWith(i)||e.startsWith(s)||s.startsWith(i)||i.startsWith(s)}return!1}vt(t){return t.includes("_index")||t.includes("_idx")||t.startsWith("idx_")||t.includes("_key")||t.includes("_lookup")}Ct(t){return t.replace(/_index.*$/,"").replace(/_idx.*$/,"").replace(/^idx_/,"").replace(/_key.*$/,"").replace(/_lookup.*$/,"")}tt(t,e){return e.includes("_index")||e.includes("_idx")||e.startsWith("idx_")||t.snapshot.has(`${e}:index_range`)}et(t,e,s){const i=t.snapshot.get(`${s}:index_range`);if(i)return this.keyMatchesIndexRange(e,i);if(s.includes("_index")||s.includes("_idx")){const t=s.replace(/_index.*$|_idx.*$/,"");return e.startsWith(t)}return!1}H(t,e){const s=this.Et(t),i=this.Et(e);if(s||i){const s=this.Tt(t),i=this.Tt(e);return s===i||t.startsWith(i)||e.startsWith(s)}return!1}Et(t){return["_list","_array","_set","_collection","_items","_elements","_members","_entries"].some(e=>t.includes(e))}Tt(t){const e=["_list","_array","_set","_collection","_items","_elements","_members","_entries"];for(const s of e)if(t.includes(s))return t.replace(s,"");return t}B(t,e){const s=[["user_id","user_email"],["user_id","user_profile"],["account_id","user_id"],["session_id","user_id"],["order_id","user_id"],["order_id","order_total"],["payment_id","order_id"],["shipping_id","order_id"],["post_id","user_id"],["comment_id","post_id"],["message_id","thread_id"],["file_id","folder_id"],["document_id","workspace_id"],["task_id","project_id"]],i=this.kt(t),r=this.kt(e);for(const[t,e]of s)if(i.includes(t)&&r.includes(e)||i.includes(e)&&r.includes(t))return!0;return!1}kt(t){return t.toLowerCase().replace(/[:\-/.]/g,"_").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}G(t,e){return t.snapshot.has(`${e}:range`)||t.snapshot.has(`${e}:query`)||t.snapshot.has(`${e}:predicate`)}Y(t,e,s){const i=t.snapshot.get(`${s}:range`);if(i&&"object"==typeof i)return this.keyMatchesRange(e,i);const r=t.snapshot.get(`${s}:query`);if(r)return this.keyMatchesQuery(e,r);const n=t.snapshot.get(`${s}:predicate`);if(n&&"function"==typeof n)try{return n(e)}catch{return!1}return!1}clearCaches(){this.patternCache.clear(),this.semanticCache.clear()}}class V{constructor(t){this.lockManager=t,this.keyAnalyzer=new F}detectDeadlocks(t,e={}){const s={useLockGraph:!0,useResourceGraph:!0,useTimeoutDetection:!0,timeoutThreshold:1e4,...e},i={deadlocks:[],suspectedDeadlocks:[],timeoutVictims:[],waitForGraph:null,resourceGraph:null};if(2>t.length)return i;if(s.useLockGraph){const e=this.It(t);i.deadlocks.push(...e.cycles),i.waitForGraph=e.graph}if(s.useResourceGraph){const e=this.Dt(t);i.deadlocks.push(...e.cycles),i.resourceGraph=e.graph}const r=this.Mt(t);if(i.suspectedDeadlocks.push(...r),s.useTimeoutDetection){const e=this.$t(t,s.timeoutThreshold);i.timeoutVictims.push(...e)}return i.deadlocks=this.Nt(i.deadlocks),i}It(t){const e=this.jt(t);return{graph:e,cycles:this.Lt(e).map(e=>({type:"lock",transactions:e,resources:this.Ut(e,t)}))}}jt(t){const e=new Map,s=this.lockManager.getStats();for(const s of t)e.set(s.id,new Set);for(const i of s.recordsLocked){const{recordKey:s,holders:r}=i,n=this.Pt(s,t);for(const t of n)for(const s of r)t!==s&&e.has(t)&&e.has(s)&&e.get(t).add(s)}return e}Pt(t,e){const s=[];for(const i of e){const e=i.writeSet.has(t)||i.readSet.has(t),r=this.lockManager.holdsLocks(i.id);e&&!r&&s.push(i.id)}return s}Dt(t){const e=this.zt(t);return{graph:e,cycles:this.Ft(e).map(t=>({type:"resource",transactions:t.transactions,resources:t.resources}))}}zt(t){const e={transactions:new Map,resources:new Map,waiting:new Map};for(const s of t)e.transactions.set(s.id,new Set),e.waiting.set(s.id,new Set);const s=this.lockManager.getStats();for(const i of s.recordsLocked){const{recordKey:s,holders:r}=i;e.resources.has(s)||e.resources.set(s,new Set);for(const t of r)e.transactions.has(t)&&(e.transactions.get(t).add(s),e.resources.get(s).add(t));const n=this.Pt(s,t);for(const t of n)e.waiting.has(t)&&e.waiting.get(t).add(s)}return e}Lt(t){const e=new Set,s=new Set,i=[],r=(n,o)=>{if(s.has(n)){const t=o.indexOf(n),e=o.slice(t);return void i.push([...e,n])}if(e.has(n))return;e.add(n),s.add(n),o.push(n);const a=t.get(n)||new Set;for(const t of a)r(t,[...o]);s.delete(n)};for(const s of t.keys())e.has(s)||r(s,[]);return i}Ft(t){const e=[],s=new Map;for(const[e]of t.transactions)s.set(e,new Set);for(const[e,i]of t.waiting)for(const r of i){const i=t.resources.get(r)||new Set;for(const t of i)e!==t&&s.get(e).add(t)}const i=this.Lt(s);for(const s of i){const i=this.Ut(s,Array.from(t.transactions.keys()).map(t=>({id:t})));e.push({transactions:s,resources:Array.from(i)})}return e}Ut(t,e){const s=new Set;for(const i of t){const t=e.find(t=>t.id===i);if(t&&t.writeSet&&t.readSet){for(const e of t.writeSet)s.add(e);for(const e of t.readSet)s.add(e)}}return s}Mt(t){const e=[];for(let s=0;t.length>s;s++)for(let i=s+1;t.length>i;i++){const r=t[s],n=t[i];this.Vt(r,n)&&e.push({type:"isolation",transactions:[r.id,n.id],conflict:this.qt(r,n)})}return e}Vt(t,e){if(t.isolationLevel>=O.REPEATABLE_READ||e.isolationLevel>=O.REPEATABLE_READ){const s=this.Kt(t,e),i=this.Kt(e,t);return s||i}return!1}qt(t,e){return this.Kt(t,e)&&this.Kt(e,t)?"bidirectional-dependency":this.Kt(t,e)?"tx1-depends-on-tx2":this.Kt(e,t)?"tx2-depends-on-tx1":"unknown"}Kt(t,e){for(const s of t.readSet)if(e.writeSet.has(s))return!0;return!1}$t(t,e){const s=[];for(const i of t){const t=i.getDuration();null!==t&&t>e&&s.push(i.id)}return s}Nt(t){const e=new Set,s=[];for(const i of t){const t=this.Ht(i);e.has(t)||(e.add(t),s.push(i))}return s}Ht(t){const e=[...t.transactions].sort(),s=t.resources?[...t.resources].sort():[];return`${t.type}:${e.join(",")}:${s.join(",")}`}}class q{constructor(){this.keyAnalyzer=new F}validateIsolation(t,e){switch(t.isolationLevel){case O.READ_UNCOMMITTED:break;case O.READ_COMMITTED:this.Bt(t,e);break;case O.REPEATABLE_READ:this.Gt(t,e);break;case O.SERIALIZABLE:this.Yt(t,e);break;default:throw new a(`Unknown isolation level: ${t.isolationLevel}`,t.id,"isolation")}}Bt(t,e){for(const s of t.writeSet){const i=this.Jt(t.id,s,e);if(i.length>0)throw new a(`Write conflict detected on key '${s}' with transactions: ${i.join(", ")}`,t.id,"write-conflict")}}Gt(t,e){this.Bt(t,e);for(const s of t.readSet)if(this.Wt(t,s,e))throw new a(`Repeatable read violation: key '${s}' was modified by another transaction`,t.id,"repeatable-read-violation");if(t.snapshot.size>0)for(const[s,i]of t.snapshot)if(this.Xt(t,s,i,e))throw new a(`Phantom read detected: snapshot inconsistency for key '${s}'`,t.id,"phantom-read")}Yt(t,e){this.Gt(t,e);for(const s of t.readSet){const i=this.Zt(t,s,e);if(i.length>0)throw new a(`Serialization conflict: key '${s}' was written by concurrent transactions: ${i.join(", ")}`,t.id,"serialization-conflict")}for(const s of t.writeSet){const i=this.Qt(t,s,e);if(i.length>0)throw new a(`Serialization conflict: key '${s}' was read by concurrent transactions: ${i.join(", ")}`,t.id,"serialization-conflict")}}Jt(t,e,s){const i=[];for(const[r,n]of s)r!==t&&n.isActive()&&n.writeSet.has(e)&&i.push(r);return i}Zt(t,e,s){const i=[];for(const[r,n]of s)r!==t.id&&n.isActive()&&n.writeSet.has(e)&&this.te(t,n)&&i.push(r);return i}Qt(t,e,s){const i=[];for(const[r,n]of s)r!==t.id&&n.isActive()&&n.readSet.has(e)&&this.te(t,n)&&i.push(r);return i}Wt(t,e,s){for(const[i,r]of s)if(i!==t.id&&r.isCommitted()&&r.writeSet.has(e)&&r.startTime>t.startTime&&r.endTime<new Date)return!0;return!1}Xt(t,e,s,i){if(this.Wt(t,e,i))return!0;for(const[r,n]of i)if(r!==t.id&&this.te(t,n)&&this.ee(t,n,e,s))return!0;return!!this.se(t,e,i)}ee(t,e,s,i){for(const r of e.operations)if("read"!==r.type){if(r.key===s)return!0;if(this.keyAnalyzer.isKeyInSnapshotRange(t,r.key,s,i))return!0}return!1}se(t,e,s){for(const[i,r]of s)if(i!==t.id&&r.isActive()&&this.te(t,r)){if(this.ie(t,r,e))return!0;if(this.re(t,r))return!0}return!1}ie(t,e,s){const i=this.ne(t,s),r=this.ne(e,s);if(!i||!r)return!1;const n=Array.from(t.writeSet),o=Array.from(e.writeSet);return!n.some(t=>o.includes(t))&&n.length>0&&o.length>0}ne(t,e){for(const s of t.readSet)if(this.keyAnalyzer.areKeysRelated(s,e))return!0;return!1}re(t,e){const s=this.Kt(t,e),i=this.Kt(e,t);return s&&i}Kt(t,e){for(const s of t.readSet)if(e.writeSet.has(s))return!0;return!1}te(t,e){if(!t.startTime||!e.startTime)return!1;const s=t.startTime.getTime(),i=t.endTime?t.endTime.getTime():Date.now(),r=e.startTime.getTime();return(e.endTime?e.endTime.getTime():Date.now())>s&&i>r}}class K{constructor(){this.transactions=new Map,this.lockManager=new P,this.transactionCounter=0,this.statistics=new z,this.deadlockDetector=new V(this.lockManager),this.isolationValidator=new q}begin(t={}){const e=new U(void 0,t);return e.begin(),this.transactions.set(e.id,e),this.transactionCounter++,this.statistics.incrementTotal(),this.statistics.incrementActive(),e}getTransaction(t){return this.transactions.get(t)}async commit(t,e={}){const s=this.transactions.get(t);if(!s)throw new a(`Transaction ${t} not found`,t,"commit");try{for(const e of s.writeSet)await this.lockManager.acquireLock(t,e,x);return this.isolationValidator.validateIsolation(s,this.transactions),s.commit(e),this.statistics.incrementCommitted(),this.statistics.decrementActive(),this.statistics.updateDurationStats(s),s}catch(e){throw this.abort(t,e.message),e}finally{this.lockManager.releaseAllLocks(t)}}abort(t,e="Manual abort"){const s=this.transactions.get(t);if(!s)throw new a(`Transaction ${t} not found`,t,"abort");return s.abort(e),this.lockManager.releaseAllLocks(t),this.statistics.incrementAborted(),this.statistics.decrementActive(),this.statistics.updateDurationStats(s),s}cleanup(t=36e5){const e=Date.now()-t;let s=0;for(const[i,r]of this.transactions)r.endTime&&(0===t||r.endTime.getTime()<e)&&(this.transactions.delete(i),s++);return s}getActiveTransactions(){return Array.from(this.transactions.values()).filter(t=>t.isActive())}detectDeadlocks(t={}){const e=this.getActiveTransactions();return this.deadlockDetector.detectDeadlocks(e,t)}getStats(){const t=this.getActiveTransactions().length,e=this.lockManager.getStats();return this.statistics.getStats(e,t,this.transactionCounter)}resetStats(){this.statistics.reset()}getComponents(){return{statistics:this.statistics,deadlockDetector:this.deadlockDetector,isolationValidator:this.isolationValidator,lockManager:this.lockManager}}validateTransactionIsolation(t){const e=this.transactions.get(t);if(!e)throw new a(`Transaction ${t} not found`,t,"validate");this.isolationValidator.validateIsolation(e,this.transactions)}checkForDeadlocks(t={}){return this.detectDeadlocks(t)}getTransactionDetails(t){const e=this.transactions.get(t);return e?{...e.getStats(),lockInfo:this.lockManager.getStats().recordsLocked.filter(e=>e.holders.includes(t))}:null}getSystemHealth(){const t=this.getStats(),e=this.detectDeadlocks();return{activeTransactions:t.activeTransactions,totalTransactions:t.totalTransactions,commitRate:t.totalTransactions>0?t.committedTransactions/t.totalTransactions:0,averageDuration:t.averageDuration,hasDeadlocks:e.deadlocks.length>0,suspectedDeadlocks:e.suspectedDeadlocks.length,timeoutVictims:e.timeoutVictims.length,totalLocks:t.lockStats.totalLocks,lockUtilization:t.lockStats.totalLocks>0?t.lockStats.uniqueHolders/t.lockStats.totalLocks:0}}}const H={FIND:"find",FILTER:"filter",SEARCH:"search",WHERE:"where",SORT:"sort",LIMIT:"limit",AGGREGATE:"aggregate"},B={INDEX_LOOKUP:1,FULL_SCAN:100,FILTER_EVALUATION:10,SORT_OPERATION:50,MEMORY_ACCESS:1,COMPARISON:2,REGEX_MATCH:20};class G{constructor(t,e={},s=0,i=0){this.operation=t,this.options=e,this.estimatedCost=s,this.estimatedRows=i,this.actualCost=null,this.actualRows=null,this.startTime=null,this.endTime=null}startExecution(){this.startTime=Date.now()}endExecution(t){this.endTime=Date.now(),this.actualCost=this.endTime-this.startTime,this.actualRows=t}getStats(){return{operation:this.operation,options:this.options,estimatedCost:this.estimatedCost,estimatedRows:this.estimatedRows,actualCost:this.actualCost,actualRows:this.actualRows,costAccuracy:this.actualCost&&this.estimatedCost?Math.abs(this.actualCost-this.estimatedCost)/this.estimatedCost:null,rowAccuracy:null!==this.actualRows&&this.estimatedRows?Math.abs(this.actualRows-this.estimatedRows)/this.estimatedRows:null}}}class Y{constructor(t,e){this.queryId=t,this.originalQuery=e,this.steps=[],this.totalEstimatedCost=0,this.totalEstimatedRows=0,this.totalActualCost=null,this.totalActualRows=null,this.createdAt=new Date,this.executedAt=null,this.completedAt=null}addStep(t){return this.steps.push(t),this.totalEstimatedCost+=t.estimatedCost,this}startExecution(){this.executedAt=new Date}completeExecution(t){this.completedAt=new Date,this.totalActualRows=t,this.totalActualCost=this.completedAt.getTime()-(this.executedAt?.getTime()||this.createdAt.getTime())}getStats(){return{queryId:this.queryId,originalQuery:this.originalQuery,stepCount:this.steps.length,totalEstimatedCost:this.totalEstimatedCost,totalEstimatedRows:this.totalEstimatedRows,totalActualCost:this.totalActualCost,totalActualRows:this.totalActualRows,createdAt:this.createdAt,executedAt:this.executedAt,completedAt:this.completedAt,steps:this.steps.map(t=>t.getStats()),efficiency:this.totalActualCost&&this.totalEstimatedCost?this.totalEstimatedCost/this.totalActualCost:null}}export(){return{...this.getStats(),explanation:this.oe()}}oe(){const t=[];return t.push(`Query Plan for: ${JSON.stringify(this.originalQuery)}`),t.push(`Estimated cost: ${this.totalEstimatedCost}, rows: ${this.totalEstimatedRows}`),null!==this.totalActualCost&&t.push(`Actual cost: ${this.totalActualCost}, rows: ${this.totalActualRows}`),t.push(""),t.push("Execution steps:"),this.steps.forEach((e,s)=>{const i=e.getStats();t.push(`${s+1}. ${i.operation} (cost: ${i.estimatedCost}, rows: ${i.estimatedRows})`),null!==i.actualCost&&t.push(`   Actual: cost: ${i.actualCost}, rows: ${i.actualRows}`)}),t}}class J{constructor(){this.totalRecords=0,this.indexStatistics=new Map,this.fieldStatistics=new Map,this.lastUpdated=new Date}update(t,e){this.totalRecords=t.size,this.lastUpdated=new Date,this.ae(t),this.he(e)}getSelectivity(t){const e=this.fieldStatistics.get(t);return e?1/(e.uniqueValues||1):.1}getIndexCardinality(t){const e=this.indexStatistics.get(t);return e?e.cardinality:this.totalRecords}ae(t){const e=new Map;for(const s of t.values())for(const[t,i]of Object.entries(s)){e.has(t)||e.set(t,{values:new Set,nullCount:0,totalLength:0,count:0});const s=e.get(t);s.count++,null==i?s.nullCount++:(s.values.add(i),"string"==typeof i&&(s.totalLength+=i.length))}for(const[t,s]of e)this.fieldStatistics.set(t,{uniqueValues:s.values.size,nullCount:s.nullCount,dataType:this.ce(s.values),avgLength:s.totalLength/s.count||0,cardinality:s.values.size/this.totalRecords})}he(t){for(const[e,s]of t){const t=s.getStats();this.indexStatistics.set(e,{cardinality:t.totalKeys,selectivity:t.totalKeys/this.totalRecords||1,avgEntriesPerKey:t.totalEntries/t.totalKeys||1,memoryUsage:t.memoryUsage})}}ce(t){const e=Array.from(t).slice(0,10),s=new Set(e.map(t=>typeof t));return 1===s.size?s.values().next().value:"mixed"}}class W{constructor(t={}){this.options={collectStatistics:!0,statisticsUpdateInterval:1e3,...t},this.statistics=new J,this.queryCounter=0,this.planCache=new Map,this.executionHistory=[],this.maxHistorySize=1e3,this.cacheHits=0,this.totalCacheRequests=0,this.costAdjustments=new Map([["INDEX_LOOKUP",1],["FULL_SCAN",1],["FILTER_EVALUATION",1],["SORT_OPERATION",1],["MEMORY_ACCESS",1],["COMPARISON",1],["REGEX_MATCH",1]]),this.lastCostModelUpdate=new Date}createPlan(t,e){const s="query_"+ ++this.queryCounter,i=new Y(s,t);this.totalCacheRequests++;const r=this.ue(t),n=this.planCache.get(r);return n&&this.le(n)?(this.cacheHits++,this.fe(n,s)):(this.de(i,t,e),this.planCache.set(r,i),i)}updateStatistics(t,e){this.statistics.update(t,e)}recordExecution(t){this.options.collectStatistics&&(this.executionHistory.push(t.getStats()),this.executionHistory.length>this.maxHistorySize&&this.executionHistory.shift(),this.queryCounter%this.options.statisticsUpdateInterval===0&&this.pe())}getOptimalStrategy(t,e){const s=this.ye(t,e).map(t=>({...t,estimatedCost:this.we(t)}));return s.sort((t,e)=>t.estimatedCost-e.estimatedCost),s[0]||{type:"full_scan",estimatedCost:this.me("FULL_SCAN")*this.statistics.totalRecords}}getStats(){return{queryCounter:this.queryCounter,planCacheSize:this.planCache.size,executionHistorySize:this.executionHistory.length,dataStatistics:{totalRecords:this.statistics.totalRecords,lastUpdated:this.statistics.lastUpdated,indexCount:this.statistics.indexStatistics.size,fieldCount:this.statistics.fieldStatistics.size},averageQueryCost:this._e(),cacheHitRate:this.ge(),cacheStatistics:{totalRequests:this.totalCacheRequests,hits:this.cacheHits,misses:this.totalCacheRequests-this.cacheHits,hitRate:this.ge()},costModel:{adjustments:Object.fromEntries(this.costAdjustments),lastUpdated:this.lastCostModelUpdate}}}clear(){this.planCache.clear(),this.executionHistory=[],this.queryCounter=0,this.cacheHits=0,this.totalCacheRequests=0,this.costAdjustments.clear(),this.costAdjustments.set("INDEX_LOOKUP",1),this.costAdjustments.set("FULL_SCAN",1),this.costAdjustments.set("FILTER_EVALUATION",1),this.costAdjustments.set("SORT_OPERATION",1),this.costAdjustments.set("MEMORY_ACCESS",1),this.costAdjustments.set("COMPARISON",1),this.costAdjustments.set("REGEX_MATCH",1),this.lastCostModelUpdate=new Date}de(t,e,s){const i=this.getOptimalStrategy(e,s);switch(i.type){case"index_lookup":this.Re(t,i);break;case"filtered_scan":this.be(t,e,i);break;default:this.Se(t)}this.Oe(t,e)}Re(t,e){const s=new G("index_lookup",{indexName:e.indexName,lookupKey:e.lookupKey},this.me("INDEX_LOOKUP"),this.Ae(e.indexName));t.addStep(s)}be(t,e,s){s.indexName&&this.Re(t,s);const i=new G("filter",{predicate:e.filter||e.where},this.me("FILTER_EVALUATION")*this.statistics.totalRecords,.1*this.statistics.totalRecords);t.addStep(i)}Se(t){const e=new G("full_scan",{scanType:"sequential"},this.me("FULL_SCAN")*this.statistics.totalRecords,this.statistics.totalRecords);t.addStep(e)}Oe(t,e){if(e.sort||e.sortBy){const s=new G("sort",{sortField:e.sortBy,sortFunction:e.sort},this.me("SORT_OPERATION")*t.totalEstimatedRows,t.totalEstimatedRows);t.addStep(s)}if(e.limit){const s=new G("limit",{offset:e.offset||0,max:e.limit},this.me("MEMORY_ACCESS"),Math.min(e.limit,t.totalEstimatedRows));t.addStep(s)}}ye(t,e){const s=[];if(s.push({type:"full_scan"}),t.find&&e.indexManager){const i=Object.keys(t.find),r=e.indexManager.getOptimalIndex(i);r&&s.push({type:"index_lookup",indexName:r,lookupKey:this.xe(t.find,i)})}if((t.filter||t.where)&&e.indexManager){const t=e.indexManager.listIndexes();for(const e of t)s.push({type:"filtered_scan",indexName:e,partialFilter:!0})}return s}we(t){switch(t.type){case"index_lookup":return this.me("INDEX_LOOKUP")+this.Ae(t.indexName,t.lookupKey)*this.me("MEMORY_ACCESS");case"filtered_scan":return(t.indexName?this.me("INDEX_LOOKUP"):0)+this.me("FILTER_EVALUATION")*this.statistics.totalRecords;case"full_scan":return this.me("FULL_SCAN")*this.statistics.totalRecords;default:return Number.MAX_SAFE_INTEGER}}me(t){return(B[t]||1)*(this.costAdjustments.get(t)||1)}Ae(t){const e=this.statistics.indexStatistics.get(t);return e?Math.max(1,this.statistics.totalRecords/e.cardinality):.1*this.statistics.totalRecords}ue(t){return JSON.stringify(t)}le(t){return 3e5>Date.now()-t.createdAt.getTime()}fe(t,e){const s=new Y(e,t.originalQuery);for(const e of t.steps){const t=new G(e.operation,e.options,e.estimatedCost,e.estimatedRows);s.addStep(t)}return s}xe(t,e){return e.sort().map(e=>String(t[e])).join("|")}pe(){if(10>this.executionHistory.length)return;this.lastCostModelUpdate=new Date;const t=this.ve();for(const[e,s]of t)if(s.sampleSize>=3){const t=this.costAdjustments.get(e)||1;let i=t;s.consistency>.7&&(i=t*(1+.1*(s.avgActualCost/s.avgEstimatedCost-1)),i=Math.max(.1,Math.min(10,i)),this.costAdjustments.set(e,i))}this.executionHistory.length>.8*this.maxHistorySize&&(this.executionHistory=this.executionHistory.slice(-Math.floor(.6*this.maxHistorySize)))}ve(){const t=new Map;for(const e of this.executionHistory)if(e.steps&&Array.isArray(e.steps))for(const s of e.steps)if(s.operation&&null!==s.actualCost&&0!==s.estimatedCost){const e=this.Ce(s.operation);if(e){t.has(e)||t.set(e,{sampleSize:0,totalActualCost:0,totalEstimatedCost:0,costs:[],estimatedCosts:[]});const i=t.get(e);i.sampleSize++,i.totalActualCost+=s.actualCost,i.totalEstimatedCost+=s.estimatedCost,i.costs.push(s.actualCost),i.estimatedCosts.push(s.estimatedCost)}}for(const[,e]of t){e.avgActualCost=e.totalActualCost/e.sampleSize,e.avgEstimatedCost=e.totalEstimatedCost/e.sampleSize;const t=this.Ee(e.costs,e.avgActualCost),s=Math.sqrt(t);e.consistency=Math.max(0,1-s/e.avgActualCost);const i=e.costs.map((t,s)=>{const i=e.estimatedCosts[s];return 1-Math.abs(t-i)/Math.max(t,i)});e.accuracy=i.reduce((t,e)=>t+e,0)/i.length}return t}Ce(t){return{index_lookup:"INDEX_LOOKUP",full_scan:"FULL_SCAN",filter:"FILTER_EVALUATION",sort:"SORT_OPERATION",limit:"MEMORY_ACCESS",regex:"REGEX_MATCH"}[t]||null}Ee(t,e){return t.length>1?t.map(t=>Math.pow(t-e,2)).reduce((t,e)=>t+e,0)/(t.length-1):0}_e(){return 0===this.executionHistory.length?0:this.executionHistory.reduce((t,e)=>t+(e.totalActualCost||0),0)/this.executionHistory.length}ge(){return 0===this.totalCacheRequests?0:this.cacheHits/this.totalCacheRequests}}class X{constructor(t=new Map){this.i=new Map(t),this.Te=new WeakMap,Object.freeze(this)}get(t){const e=this.i.get(t);if(!e)return null;if(this.Te.has(e))return this.Te.get(e);const s=this.ke(structuredClone(e));return this.Te.set(e,s),s}set(t,e){const s=new Map(this.i);return s.set(t,e),new X(s)}delete(t){const e=new Map(this.i);return e.delete(t),new X(e)}has(t){return this.i.has(t)}keys(){return Array.from(this.i.keys())}get size(){return this.i.size}entries(){return Array.from(this.i.entries())}ke(t){return null===t||"object"!=typeof t?t:(Array.isArray(t)?t.forEach(t=>this.ke(t)):Object.values(t).forEach(t=>this.ke(t)),Object.freeze(t))}}class Z{constructor(t,e={}){this.iterator=t,this.options={batchSize:1e3,bufferSize:1e4,...e},this.buffer=[],this.ended=!1,this.position=0}async read(t=this.options.batchSize){const e=[];for(;t>e.length&&!this.ended;){const{value:t,done:s}=this.iterator.next();if(s){this.ended=!0;break}e.push(t),this.position++}return e}async readAll(){const t=[];for(;!this.ended;){const e=await this.read();t.push(...e)}return t}map(t){return new Z({next:()=>{const{value:e,done:s}=this.iterator.next();return s?{done:!0}:{value:t(e),done:!1}}},this.options)}filter(t){return new Z({next:()=>{for(;;){const{value:e,done:s}=this.iterator.next();if(s)return{done:!0};if(t(e))return{value:e,done:!1}}}},this.options)}take(t){let e=0;return new Z({next:()=>{if(e>=t)return{done:!0};const{value:s,done:i}=this.iterator.next();return i?{done:!0}:(e++,{value:s,done:!1})}},this.options)}getStats(){return{position:this.position,ended:this.ended,bufferSize:this.buffer.length,options:this.options}}}class Q{constructor(t={}){this.config={immutable:!1,...t},this.Ie=this.config.immutable?new X:new Map}get(t){return this.Ie.get(t)||null}set(t,e){return this.config.immutable?this.Ie=this.Ie.set(t,e):this.Ie.set(t,e),!0}delete(t){return this.config.immutable?this.Ie=this.Ie.delete(t):this.Ie.delete(t),!0}has(t){return this.Ie.has(t)}keys(){return this.config.immutable?this.Ie.keys():Array.from(this.Ie.keys())}values(){return this.config.immutable?this.Ie.values():Array.from(this.Ie.values())}entries(){return this.config.immutable?this.Ie.entries():Array.from(this.Ie.entries())}get size(){return this.Ie.size}clear(){this.config.immutable?this.Ie=new X:this.Ie.clear()}getStore(){return this.Ie}estimateMemoryUsage(){let t=0;for(const[e,s]of this.entries())t+=2*JSON.stringify({key:e,value:s}).length;return t}}class tt{constructor({storageManager:t,indexManager:e,versionManager:s=null,config:i}){this.storageManager=t,this.indexManager=e,this.versionManager=s,this.config=i}set(i,r={},n={}){try{const{override:e=!1,validate:s=!0}=n;null===i&&(i=r[this.config.key]??t());const o={...r,[this.config.key]:i};s&&this.config.schema&&this.config.schema.validate(o);const a=this.storageManager.has(i)?this.storageManager.get(i):null;let h=o;return a&&!e&&(h=this.De(a,o)),this.versionManager&&a&&this.versionManager.addVersion(i,a),a&&this.indexManager.removeRecord(i,a),this.indexManager.addRecord(i,h),this.storageManager.set(i,h),E.create(i,h)}catch(t){if(t instanceof e)throw t;throw new s(`Failed to set record: ${t.message}`,"record",r)}}get(t,e={}){const{includeVersions:s=!1}=e,i=this.storageManager.get(t);if(!i)return null;const r=E.create(t,i);if(s&&this.versionManager){const e=this.versionManager.getHistory(t);if(e)return E.create(t,i,{versions:e.versions})}return r}delete(t){if(!this.storageManager.has(t))throw new i(t,this.config.id);const e=this.storageManager.get(t);return this.indexManager.removeRecord(t,e),this.storageManager.delete(t),this.versionManager&&this.versionManager.disableVersioning(t),!0}has(t){return this.storageManager.has(t)}De(t,e){if(Array.isArray(t)&&Array.isArray(e))return[...t,...e];if("object"==typeof t&&"object"==typeof e){const s={...t};for(const[i,r]of Object.entries(e))s[i]="object"!=typeof r||null===r||Array.isArray(r)||"object"!=typeof t[i]||null===t[i]||Array.isArray(t[i])?r:this.De(t[i],r);return s}return e}}class et{constructor({storageManager:t,indexManager:e,queryOptimizer:s=null}){this.storageManager=t,this.indexManager=e,this.queryOptimizer=s}find(t={},e={}){const{limit:s,offset:i=0}=e;try{let e=null;this.queryOptimizer&&(e=this.queryOptimizer.createPlan({find:t,limit:s,offset:i},{indexManager:this.indexManager}),e.startExecution());const r=Object.keys(t);let n;n=this.indexManager.getOptimalIndex(r)?this.indexManager.findByCriteria(t):new Set(this.storageManager.keys());const o=[];for(const e of n){const s=this.storageManager.get(e);this.Me(s,t)&&o.push(E.create(e,s))}const a=o.slice(i,s?i+s:o.length);return e&&(e.completeExecution(a.length),this.queryOptimizer.recordExecution(e)),new C(a)}catch(e){throw new o(`Find operation failed: ${e.message}`,t,"find")}}where(t,e={}){try{if("function"==typeof t)return this.$e(t,e);if("object"==typeof t&&null!==t)return this.Ne(t,e);throw new o("Predicate must be a function or object",t,"where")}catch(e){throw new o(`Where operation failed: ${e.message}`,t,"where")}}Me(t,e){for(const[s,i]of Object.entries(e)){const e=t[s];if(i instanceof RegExp){if(!i.test(e))return!1}else if(Array.isArray(i)){if(Array.isArray(e)){if(!i.some(t=>e.includes(t)))return!1}else if(!i.includes(e))return!1}else if(e!==i)return!1}return!0}$e(t,e){const{limit:s,offset:i=0}=e,r=[];let n=0;for(const[e,o]of this.storageManager.entries()){const a=E.create(e,o);if(t(a)){if(n>=i&&(r.push(a),s&&r.length>=s))break;n++}}return new C(r)}Ne(t,e){return this.find(t,e)}}class st{constructor({crudManager:t,transactionManager:e=null,lifecycleManager:s}){this.crudManager=t,this.transactionManager=e,this.lifecycleManager=s}batch(t,e="set",s={}){const{transaction:i=null,atomic:r=!1}=s;try{if(r||i)return this.je(t,e,i);const s=[];for(const i of t)try{let t;"set"===e?t=this.crudManager.set(null,i,{batch:!0}):"del"===e&&(this.crudManager.delete(i,{batch:!0}),t=!0),s.push(t)}catch(t){s.push(t)}return this.lifecycleManager.onbatch(s,e),s}catch(e){throw new o(`Batch operation failed: ${e.message}`,t,"batch")}}async je(t,e,s){if(!this.transactionManager)throw new a("Transaction manager not available for atomic batch operations");const i=!s;i&&(s=this.transactionManager.begin());try{const r=[];for(const i of t)if("set"===e){const t=this.Le(null,i,s);r.push(t)}else"del"===e&&(this.Ue(i,s),r.push(!0));return i&&await this.transactionManager.commit(s.id),r}catch(t){throw i&&this.transactionManager.abort(s.id,t.message),t}}Le(t,e,s){const i=t?this.crudManager.storageManager.get(t):null;return s.addOperation("set",t,i,e),this.crudManager.set(t,e,{batch:!0})}Ue(t,e){const s=this.crudManager.storageManager.get(t);e.addOperation("delete",t,s),this.crudManager.delete(t,{batch:!0})}}class it{constructor({storageManager:t}){this.storageManager=t}stream(t={}){const e=this.storageManager.entries();let s=0;return new Z({next:()=>e.length>s?{value:e[s++],done:!1}:{done:!0}},t)}streamWhere(t,e={}){const s=this.Pe(t);return new Z(s,e)}streamMap(t,e={}){const s=this.ze(t);return new Z(s,e)}streamTake(t,e={}){const s=this.Fe(t);return new Z(s,e)}Pe(t){const e=this.storageManager.entries();let s=0;return{next:()=>{for(;e.length>s;){const[i,r]=e[s++];if("function"==typeof t){if(t({key:i,...r}))return{value:[i,r],done:!1}}else if("object"==typeof t&&this.Me(r,t))return{value:[i,r],done:!1}}return{done:!0}}}}ze(t){const e=this.storageManager.entries();let s=0;return{next:()=>{if(e.length>s){const[i,r]=e[s++];return{value:[i,t({key:i,...r})],done:!1}}return{done:!0}}}}Fe(t){const e=this.storageManager.entries();let s=0;return{next:()=>t>s&&e.length>s?{value:e[s++],done:!1}:{done:!0}}}Me(t,e){for(const[s,i]of Object.entries(e)){const e=t[s];if(i instanceof RegExp){if(!i.test(e))return!1}else if(Array.isArray(i)){if(Array.isArray(e)){if(!i.some(t=>e.includes(t)))return!1}else if(!i.includes(e))return!1}else if(e!==i)return!1}return!0}}class rt{constructor({storageManager:t,indexManager:e,versionManager:s=null,transactionManager:i=null,queryOptimizer:r=null,config:n}){this.storageManager=t,this.indexManager=e,this.versionManager=s,this.transactionManager=i,this.queryOptimizer=r,this.config=n}getStats(){const t={records:this.storageManager.size,configuration:this.config,indexes:this.indexManager.getStats(),memory:this.R()};return this.versionManager&&(t.versions=this.versionManager.getStats()),this.transactionManager&&(t.transactions=this.transactionManager.getStats()),this.queryOptimizer&&(t.queries=this.queryOptimizer.getStats()),t}getStorageStats(){return{size:this.storageManager.size,memoryUsage:this.storageManager.estimateMemoryUsage(),type:this.config.immutable?"immutable":"mutable"}}getIndexStats(){return this.indexManager.getStats()}getVersionStats(){return this.versionManager?this.versionManager.getStats():null}getTransactionStats(){return this.transactionManager?this.transactionManager.getStats():null}getQueryStats(){return this.queryOptimizer?this.queryOptimizer.getStats():null}getPerformanceMetrics(){const t=this.getStats();return{recordsPerIndex:t.records/Math.max(1,Object.keys(t.indexes).length),memoryPerRecord:t.memory.total/Math.max(1,t.records),indexEfficiency:this.Ve(t),overheadRatio:t.memory.overhead/Math.max(1,t.memory.data)}}R(){const t=this.storageManager.estimateMemoryUsage(),e=this.indexManager.getStats().totalMemoryUsage||0,s=this.versionManager?this.versionManager.getStats().totalSize:0;return{total:t+e+s,data:t,indexes:e,versions:s,overhead:e+s}}Ve(t){return t.indexes&&t.queries?(t.queries.indexedExecutions||0)/(t.queries.totalExecutions||1)*100:0}generateReport(){const t=this.getStats(),e=this.getPerformanceMetrics();return{summary:{totalRecords:t.records,totalMemory:t.memory.total,activeIndexes:Object.keys(t.indexes).length,versioning:!!this.versionManager,transactions:!!this.transactionManager,optimization:!!this.queryOptimizer},performance:e,breakdown:{storage:this.getStorageStats(),indexes:this.getIndexStats(),versions:this.getVersionStats(),transactions:this.getTransactionStats(),queries:this.getQueryStats()},recommendations:this.qe(t,e)}}qe(t,e){const s=[];return 50>e.indexEfficiency&&s.push("Consider adding more indexes for frequently queried fields"),e.overheadRatio>2&&s.push("High memory overhead detected - consider optimizing indexes or version retention"),t.records>1e4&&!this.queryOptimizer&&s.push("Enable query optimization for better performance with large datasets"),t.memory.versions>t.memory.data&&s.push("Version storage is larger than data - consider adjusting retention policy"),s}}class nt{constructor(t={}){this.hooks={beforeSet:()=>{},onset:()=>{},beforeDelete:()=>{},ondelete:()=>{},beforeClear:()=>{},onclear:()=>{},onbatch:()=>{},...t}}registerHook(t,e){if("function"!=typeof e)throw new s(`Hook handler for '${t}' must be a function`,"handler",e);this.hooks[t]=e}unregisterHook(t){this.hooks[t]=()=>{}}executeHook(t,...e){if(this.hooks[t])return this.hooks[t](...e)}beforeSet(t,e,s){return this.executeHook("beforeSet",t,e,s)}onset(t,e){return this.executeHook("onset",t,e)}beforeDelete(t,e){return this.executeHook("beforeDelete",t,e)}ondelete(t){return this.executeHook("ondelete",t)}beforeClear(){return this.executeHook("beforeClear")}onclear(){return this.executeHook("onclear")}onbatch(t,e){return this.executeHook("onbatch",t,e)}getHooks(){return{...this.hooks}}hasHook(t){return t in this.hooks&&"function"==typeof this.hooks[t]}clearHooks(){for(const t in this.hooks)this.hooks[t]=()=>{}}}class ot{constructor(e=null,s={}){const i={delimiter:"|",id:t(),immutable:!1,index:[],key:"id",versioning:!1,schema:null,retentionPolicy:{type:M.NONE},enableTransactions:!1,enableOptimization:!0};let r;Array.isArray(e)||null===e?(r=y.validate(s),this.initialData=e):(r=y.validate(e),this.initialData=null),this.config={...i,...r},this.storageManager=new Q({immutable:this.config.immutable}),this.indexManager=new D(this.config.delimiter),this.versionManager=this.config.versioning?new j(this.config.retentionPolicy):null,this.transactionManager=this.config.enableTransactions?new K:null,this.queryOptimizer=this.config.enableOptimization?new W:null,this.lifecycleManager=new nt,this.crudManager=new tt({storageManager:this.storageManager,indexManager:this.indexManager,versionManager:this.versionManager,config:this.config}),this.queryManager=new et({storageManager:this.storageManager,indexManager:this.indexManager,queryOptimizer:this.queryOptimizer}),this.batchManager=new st({crudManager:this.crudManager,transactionManager:this.transactionManager,lifecycleManager:this.lifecycleManager}),this.streamManager=new it({storageManager:this.storageManager}),this.statisticsManager=new rt({storageManager:this.storageManager,indexManager:this.indexManager,versionManager:this.versionManager,transactionManager:this.transactionManager,queryOptimizer:this.queryOptimizer,config:this.config});for(const t of this.config.index)this.indexManager.createIndex(t,t);Object.defineProperty(this,"data",{get:()=>this.storageManager.getStore(),enumerable:!0}),Object.defineProperty(this,"size",{get:()=>this.storageManager.size,enumerable:!0}),Object.defineProperty(this,"registry",{get:()=>this.storageManager.keys(),enumerable:!0}),this.initialData&&Array.isArray(this.initialData)&&this.batch(this.initialData)}set(t,e={},s={}){const{batch:i=!1,transaction:r=null}=s;if(r)return this.Ke(r,"set",t,e,s);this.lifecycleManager.beforeSet(t,e,s);const n=this.crudManager.set(t,e,s);return i||this.lifecycleManager.onset(n,s),n}get(t,e={}){const{transaction:s=null}=e;return s?this.Ke(s,"get",t,e):this.crudManager.get(t,e)}delete(t,e={}){const{batch:s=!1,transaction:i=null}=e;if(i)return this.Ke(i,"delete",t,e);this.lifecycleManager.beforeDelete(t,s);const r=this.crudManager.delete(t,e);return s||this.lifecycleManager.ondelete(t),r}has(t){return this.crudManager.has(t)}keys(){return this.storageManager.keys()}values(){return this.storageManager.values()}entries(){return this.storageManager.entries()}toArray(){return this.values()}filter(t){return this.values().filter(t)}search(t,e,s=!1){if("function"==typeof t)return this.filter(t);if(!e){const s=this.indexManager.listIndexes();if(0===s.length)return this.He(t);e=s}const i=Array.isArray(e)?e:[e],r=new Set;for(const e of i)this.indexManager.hasIndex(e)?this.Be(e,t).forEach(t=>r.add(t)):this.values().forEach(s=>{const i=this.Ge(s,e);this.Ye(i,t)&&r.add(s[this.config.key])});const n=[];for(const t of r){const e=this.storageManager.get(t);e&&n.push(e)}return n}Be(t,e){const s=new Set;try{const i=this.indexManager.O.get(t);if(!i)return s;for(const[t,r]of i.i.entries())this.Ye(t,e)&&r.forEach(t=>s.add(t))}catch{}return s}He(t){return this.values().filter(e=>this.Je(e,t))}Je(t,e){for(const s of Object.values(t)){if(this.Ye(s,e))return!0;if("object"==typeof s&&null!==s)if(Array.isArray(s)){if(s.some(t=>this.Ye(t,e)))return!0}else if(this.Je(s,e))return!0}return!1}Ge(t,e){const s=e.split(".");let i=t;for(const t of s){if(!i||"object"!=typeof i)return;i=i[t]}return i}Ye(t,e){return e instanceof RegExp?e.test(String(t)):"string"==typeof e?String(t).toLowerCase().includes(e.toLowerCase()):t===e}map(t){return this.values().map(t)}reduce(t,e){const s=this.values();return arguments.length>1?s.reduce(t,e):s.reduce(t)}forEach(t){this.values().forEach(t)}sort(t){return this.values().sort(t)}sortBy(t,e=!0){return this.sort((s,i)=>{const r=s[t],n=i[t];return n>r?e?-1:1:r>n?e?1:-1:0})}find(t={},e={}){const{transaction:s=null}=e;return s?this.Ke(s,"find",t,e):this.queryManager.find(t,e)}where(t,e={}){return this.queryManager.where(t,e)}batch(t,e="set",s={}){return this.batchManager.batch(t,e,s)}beginTransaction(t={}){if(!this.transactionManager)throw new n("Transactions not enabled","enableTransactions",!1);return this.transactionManager.begin(t)}async commitTransaction(t){if(!this.transactionManager)throw new n("Transactions not enabled","enableTransactions",!1);const e="string"==typeof t?t:t.id;return await this.transactionManager.commit(e)}abortTransaction(t,e){if(!this.transactionManager)throw new n("Transactions not enabled","enableTransactions",!1);return this.transactionManager.abort("string"==typeof t?t:t.id,e)}stream(t={}){return this.streamManager.stream(t)}getStats(){return this.statisticsManager.getStats()}clear(t={}){const{preserveIndexes:e=!1,preserveVersions:s=!1}=t;this.lifecycleManager.beforeClear(),this.storageManager.clear(),e||this.indexManager.clear(),!s&&this.versionManager&&this.versionManager.clear(),this.queryOptimizer&&this.queryOptimizer.clear(),this.lifecycleManager.onclear()}beforeSet(t,e,s){return this.lifecycleManager.beforeSet(t,e,s)}onset(t,e){return this.lifecycleManager.onset(t,e)}beforeDelete(t,e){return this.lifecycleManager.beforeDelete(t,e)}ondelete(t){return this.lifecycleManager.ondelete(t)}beforeClear(){return this.lifecycleManager.beforeClear()}onclear(){return this.lifecycleManager.onclear()}onbatch(t,e){return this.lifecycleManager.onbatch(t,e)}Ke(t,e,...s){switch(e){case"set":{const[i,r,n={}]=s,o=this.storageManager.get(i);return t.addOperation(e,i,o,r),this.set(i,r,{...n,transaction:null})}case"get":{const[e,i={}]=s;return t.addOperation("read",e),this.get(e,{...i,transaction:null})}case"delete":{const[i,r={}]=s,n=this.storageManager.get(i);return t.addOperation(e,i,n),this.delete(i,{...r,transaction:null})}case"find":{const[e,i={}]=s;return t.addOperation("read","find_operation",null,e),this.find(e,{...i,transaction:null})}default:throw new a(`Unknown operation: ${e}`,t.id,e)}}limit(t=0,e=0){const s=this.keys(),i=Math.max(0,t),r=s.slice(i,e>0?i+e:s.length),n=[];for(const t of r)n.push(this.storageManager.get(t));return n}reindex(t){return this.indexManager.rebuild(this.entries()),this}dump(t="records"){if("indexes"===t){const t={},e=this.indexManager.listIndexes();for(const s of e){const e=this.indexManager.getIndexDefinition(s);t[s]={fields:e.fields,type:e.type,delimiter:e.delimiter,unique:e.unique}}return t}return this.entries()}override(t,e="records"){try{if("indexes"===e){this.indexManager.clear();for(const[e,s]of Object.entries(t))this.indexManager.createIndex(e,s.fields,{type:s.type,delimiter:s.delimiter,unique:s.unique});this.reindex()}else{this.clear();for(const[e,s]of t)this.set(e,s,!0)}return!0}catch{return!1}}uuid(){return t()}clone(t){if(null===t||"object"!=typeof t)return t;if(t instanceof Date)return new Date(t.getTime());if(t instanceof RegExp)return new RegExp(t);if(Array.isArray(t))return t.map(t=>this.clone(t));const e={};for(const[s,i]of Object.entries(t))e[s]=this.clone(i);return e}merge(t,...e){if(!t||"object"!=typeof t)return t;const s=this.clone(t);for(const t of e)if(t&&"object"==typeof t)for(const[e,i]of Object.entries(t))s[e]="object"!=typeof i||null===i||Array.isArray(i)||"object"!=typeof s[e]||null===s[e]||Array.isArray(s[e])?this.clone(i):this.merge(s[e],i);return s}freeze(...t){const e=t=>null===t||"object"!=typeof t?t:(Array.isArray(t)?t.forEach(t=>e(t)):Object.values(t).forEach(t=>e(t)),Object.freeze(t));return 1===t.length?e(t[0]):t.map(t=>e(t))}}function at(t=null,e={}){return new ot(t,e)}export{w as Constraints,Z as DataStream,l as DataTypes,u as ErrorRecovery,d as FieldConstraint,ot as Haro,X as ImmutableStore,T as IndexTypes,O as IsolationLevels,H as QueryTypes,v as Record,C as RecordCollection,E as RecordFactory,M as RetentionPolicies,p as Schema,ot as default,at as haro};//# sourceMappingURL=haro.min.js.map
