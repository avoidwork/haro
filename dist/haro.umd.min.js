/*!
 2025 Jason Mulligan <jason.mulligan@avoidwork.com>
 @version 17.0.0
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("crypto")):"function"==typeof define&&define.amd?define(["exports","crypto"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).haro={},t.crypto)}(this,function(t,e){"use strict";class s extends Error{constructor(t,e,s){super(t),this.name=this.constructor.name,this.code=e,this.context=s,this.timestamp=(new Date).toISOString(),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}toJSON(){return{name:this.name,message:this.message,code:this.code,context:this.context,timestamp:this.timestamp,stack:this.stack}}}class i extends s{constructor(t,e,s){super(t,"VALIDATION_ERROR",{field:e,value:s})}}class r extends s{constructor(t,e){super(`Record with key '${t}' not found${e?` in store '${e}'`:""}`,"RECORD_NOT_FOUND",{key:t,storeName:e})}}class a extends s{constructor(t,e,s){super(t,"INDEX_ERROR",{indexName:e,operation:s})}}class n extends s{constructor(t,e,s){super(t,"CONFIGURATION_ERROR",{configKey:e,configValue:s})}}class o extends s{constructor(t,e,s){super(t,"QUERY_ERROR",{query:e,operation:s})}}class c extends s{constructor(t,e,s){super(t,"TRANSACTION_ERROR",{transactionId:e,operation:s})}}class h extends s{constructor(t,e,s,i){super(t,"TYPE_CONSTRAINT_ERROR",{expected:e,actual:s,field:i})}}class l extends s{constructor(t,e,s){super(t,"CONCURRENCY_ERROR",{resource:e,operation:s})}}const d={STRING:"string",NUMBER:"number",BOOLEAN:"boolean",OBJECT:"object",ARRAY:"array",DATE:"date",UUID:"uuid",EMAIL:"email",URL:"url",ANY:"any"};class u{static getValueType(t){if(null===t)return"null";if(Array.isArray(t))return d.ARRAY;if(t instanceof Date)return d.DATE;const e=typeof t;if("string"===e){if(u.isUUID(t))return d.UUID;if(u.isEmail(t))return d.EMAIL;if(u.isURL(t))return d.URL}return e}static isTypeMatch(t,e){return t===e||e===d.STRING&&["string",d.UUID,d.EMAIL,d.URL].includes(t)}static isUUID(t){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(t)}static isEmail(t){return/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/.test(t)}static isURL(t){try{const e=new URL(t);return Boolean(e)}catch{return!1}}}class f{constructor({type:t=d.ANY,required:e=!1,default:s,validator:i,min:r,max:a,enum:n,pattern:o}={}){this.type=t,this.required=e,this.default=s,this.validator=i,this.min=r,this.max=a,this.enum=n,this.pattern=o}validate(t,e="field"){if(null==t){if(this.required)throw new i(`Field '${e}' is required`,e,t);return void 0!==this.default?this.default:t}const s=u.getValueType(t);if(this.type!==d.ANY&&!u.isTypeMatch(s,this.type))throw new h(`Field '${e}' expected type '${this.type}' but got '${s}'`,this.type,s,e);if(void 0!==this.min&&t<this.min)throw new i(`Field '${e}' value ${t} is below minimum ${this.min}`,e,t);if(void 0!==this.max&&t>this.max)throw new i(`Field '${e}' value ${t} exceeds maximum ${this.max}`,e,t);if(("string"==typeof t||Array.isArray(t))&&void 0!==t.length){if(void 0!==this.min&&t.length<this.min)throw new i(`Field '${e}' length ${t.length} is below minimum ${this.min}`,e,t);if(void 0!==this.max&&t.length>this.max)throw new i(`Field '${e}' length ${t.length} exceeds maximum ${this.max}`,e,t)}if(this.enum&&!this.enum.includes(t))throw new i(`Field '${e}' value '${t}' is not in allowed values: ${this.enum.join(", ")}`,e,t);if(this.pattern&&"string"==typeof t&&!this.pattern.test(t))throw new i(`Field '${e}' value '${t}' does not match required pattern`,e,t);if(this.validator&&"function"==typeof this.validator){const s=this.validator(t,e);if(!0!==s&&void 0!==s){throw new i("string"==typeof s?s:`Custom validation failed for field '${e}'`,e,t)}}return t}}class g{constructor(t={},{strict:e=!1,stripUnknown:s=!1}={}){this.fields=t,this.strict=e,this.stripUnknown=s}validate(t){if(!t||"object"!=typeof t||Array.isArray(t))throw new i("Record must be an object","record",t);const e={},s=Object.keys(this.fields),r=Object.keys(t);for(const i of s){const s=this.fields[i],r=t[i];e[i]=s.validate(r,i)}const a=r.filter(t=>!s.includes(t));if(a.length>0){if(this.strict)throw new i(`Unknown fields not allowed: ${a.join(", ")}`,"record",t);if(!this.stripUnknown)for(const s of a)e[s]=t[s]}return e}addField(t,e){return this.fields[t]=e,this}removeField(t){return delete this.fields[t],this}}class m{static validate(t={}){const e={...t};if(void 0!==e.delimiter&&("string"!=typeof e.delimiter||0===e.delimiter.length))throw new n("Delimiter must be a non-empty string","delimiter",e.delimiter);if(void 0!==e.id&&"string"!=typeof e.id)throw new n("ID must be a string","id",e.id);if(void 0!==e.immutable&&"boolean"!=typeof e.immutable)throw new n("Immutable must be a boolean","immutable",e.immutable);if(void 0!==e.index){if(!Array.isArray(e.index))throw new n("Index must be an array","index",e.index);for(const t of e.index)if("string"!=typeof t)throw new n("Index field names must be strings","index",t)}if(void 0!==e.key&&"string"!=typeof e.key)throw new n("Key field must be a string","key",e.key);if(void 0!==e.versioning&&"boolean"!=typeof e.versioning)throw new n("Versioning must be a boolean","versioning",e.versioning);if(void 0!==e.schema&&!(e.schema instanceof g))throw new n("Schema must be an instance of Schema class","schema",e.schema);return e}}const p={requiredString:(t={})=>new f({type:d.STRING,required:!0,...t}),optionalString:(t={})=>new f({type:d.STRING,required:!1,...t}),requiredNumber:(t={})=>new f({type:d.NUMBER,required:!0,...t}),optionalNumber:(t={})=>new f({type:d.NUMBER,required:!1,...t}),uuid:(t=!0)=>new f({type:d.UUID,required:t}),email:(t=!0)=>new f({type:d.EMAIL,required:t}),enum:(t,e=!0)=>new f({enum:t,required:e}),date:(t=!0)=>new f({type:d.DATE,required:t})},y="pending",_="active",w="committed",S="aborted",R="set",x="delete",C={READ_UNCOMMITTED:0,READ_COMMITTED:1,REPEATABLE_READ:2,SERIALIZABLE:3},v="shared",A="exclusive";class M{constructor(t,e,s={}){this._key=t,this._data=e,this._metadata={createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),version:1,...s},Object.freeze(this)}get key(){return this._key}get data(){return Object.freeze({...this._data})}get metadata(){return Object.freeze({...this._metadata})}get(t){return this._data[t]}has(t){return t in this._data}getFields(){return Object.keys(this._data)}update(t,e={}){const s={...this._data,...t},i={...this._metadata,...e,updatedAt:(new Date).toISOString(),version:this._metadata.version+1};return new M(this._key,s,i)}toObject(t=!1){const e={...this._data};return t&&(e._metadata=this._metadata),e}toJSON(t=!1){return JSON.stringify(this.toObject(t))}equals(t){return t instanceof M&&(this._key===t._key&&JSON.stringify(this._data)===JSON.stringify(t._data))}clone(){return new M(this._key,structuredClone(this._data),structuredClone(this._metadata))}getSize(){return 2*JSON.stringify(this._data).length}matches(t){return"function"==typeof t?t(this._data,this._key,this):"object"==typeof t&&null!==t&&Object.entries(t).every(([t,e])=>{const s=this._data[t];return e instanceof RegExp?e.test(s):Array.isArray(e)?Array.isArray(s)?e.some(t=>s.includes(t)):e.includes(s):s===e})}toString(){return`Record(${this._key}: ${JSON.stringify(this._data)})`}*[Symbol.iterator](){for(const[t,e]of Object.entries(this._data))yield[t,e]}}class k{constructor(t=[]){this._records=[...t],Object.freeze(this)}get length(){return this._records.length}at(t){return this._records[t]}first(){return this._records[0]}last(){return this._records[this._records.length-1]}filter(t){return new k(this._records.filter(t))}map(t){return this._records.map(t)}find(t){return this._records.find(t)}some(t){return this._records.some(t)}every(t){return this._records.every(t)}sort(t){return new k([...this._records].sort(t))}slice(t=0,e){return new k(this._records.slice(t,e))}reduce(t,e){return this._records.reduce(t,e)}toArray(){return[...this._records]}toObjects(t=!1){return this._records.map(e=>e.toObject(t))}toPairs(){return this._records.map(t=>[t.key,t.data])}groupBy(t){const e=new Map,s="function"==typeof t?t:e=>e.get(t);for(const t of this._records){const i=s(t);e.has(i)||e.set(i,[]),e.get(i).push(t)}for(const[t,s]of e)e.set(t,new k(s));return e}unique(){const t=new Set,e=[];for(const s of this._records)t.has(s.key)||(t.add(s.key),e.push(s));return new k(e)}forEach(t){this._records.forEach(t)}*[Symbol.iterator](){for(const t of this._records)yield t}toString(){return`RecordCollection(${this._records.length} records)`}}const T={create:(t,e,s={})=>new M(t,e,s),fromObject(t,e="id",s={}){const i=t[e];if(!i)throw new Error(`Key field '${e}' not found in data`);return new M(i,t,s)},createCollection(t,e="id"){const s=t.map(t=>t instanceof M?t:this.fromObject(t,e));return new k(s)},emptyCollection:()=>new k},b={SINGLE:"single",COMPOSITE:"composite",ARRAY:"array",PARTIAL:"partial"};class O{constructor(t,e,{type:s=b.SINGLE,unique:i=!1,filter:r,transform:a,delimiter:n="|"}={}){this.name=t,this.fields=Array.isArray(e)?e:[e],this.type=this._determineType(this.fields,s),this.unique=i,this.filter=r,this.transform=a,this.delimiter=n,this.createdAt=new Date,this.stats={totalKeys:0,totalEntries:0,memoryUsage:0,lastUpdated:new Date}}_determineType(t,e){return e===b.PARTIAL?b.PARTIAL:t.length>1?b.COMPOSITE:b.SINGLE}generateKeys(t){if(this.filter&&!this.filter(t))return[];const e=this._extractKeys(t);return this.transform?e.map(e=>this.transform(e,t)):e}_extractKeys(t){if(this.type===b.COMPOSITE)return this._generateCompositeKeys(t);const e=t[this.fields[0]];return null==e?[]:Array.isArray(e)?e.map(t=>String(t)):[String(e)]}_generateCompositeKeys(t){let e=[""];for(const s of this.fields.sort()){const i=t[s];if(null==i)return[];const r=Array.isArray(i)?i:[i],a=[];for(const t of e)for(const e of r){const s=""===t?String(e):`${t}${this.delimiter}${String(e)}`;a.push(s)}e=a}return e}updateStats(t,e,s){this.stats.totalKeys=t,this.stats.totalEntries=e,this.stats.memoryUsage+=s,this.stats.lastUpdated=new Date}}class E{constructor(){this._storage=new Map,this._refCounts=new Map}add(t,e){this._storage.has(t)||(this._storage.set(t,new Set),this._refCounts.set(t,0));const s=this._storage.get(t);s.has(e)||(s.add(e),this._refCounts.set(t,this._refCounts.get(t)+1))}remove(t,e){const s=this._storage.get(t);if(!s)return!1;const i=s.delete(e);if(i){const e=this._refCounts.get(t)-1;0===e?(this._storage.delete(t),this._refCounts.delete(t)):this._refCounts.set(t,e)}return i}get(t){return this._storage.get(t)||new Set}has(t){return this._storage.has(t)}keys(){return Array.from(this._storage.keys())}getStats(){let t=0;for(const e of this._storage.values())t+=e.size;return{totalKeys:this._storage.size,totalEntries:t,memoryUsage:this._estimateMemoryUsage()}}clear(){this._storage.clear(),this._refCounts.clear()}_estimateMemoryUsage(){let t=0;for(const[e,s]of this._storage){t+=2*e.length,t+=64;for(const e of s)t+=2*e.length}return t}}class I{constructor(t="|"){this.delimiter=t,this._definitions=new Map,this._indexes=new Map,this._stats={totalOperations:0,totalTime:0,lastOptimized:new Date}}createIndex(t,e,s={}){if(this._definitions.has(t))throw new a(`Index '${t}' already exists`,t,"create");const i=new O(t,e,{delimiter:this.delimiter,...s});return this._definitions.set(t,i),this._indexes.set(t,new E),this}dropIndex(t){if(!this._definitions.has(t))throw new a(`Index '${t}' does not exist`,t,"drop");return this._definitions.delete(t),this._indexes.delete(t),this}hasIndex(t){return this._definitions.has(t)}getIndexDefinition(t){return this._definitions.get(t)}listIndexes(){return Array.from(this._definitions.keys())}addRecord(t,e){const s=Date.now();for(const[s,i]of this._definitions){const r=this._indexes.get(s),n=i.generateKeys(e);for(const e of n){if(i.unique&&r.has(e)){const i=r.get(e);if(i.size>0&&!i.has(t))throw new a(`Unique constraint violation on index '${s}' for value '${e}'`,s,"add")}r.add(e,t)}const o=r.getStats();i.updateStats(o.totalKeys,o.totalEntries,0)}this._updatePerformanceStats(Date.now()-s)}removeRecord(t,e){const s=Date.now();for(const[s,i]of this._definitions){const r=this._indexes.get(s),a=i.generateKeys(e);for(const e of a)r.remove(e,t);const n=r.getStats();i.updateStats(n.totalKeys,n.totalEntries,0)}this._updatePerformanceStats(Date.now()-s)}updateRecord(t,e,s){this.removeRecord(t,e),this.addRecord(t,s)}findByIndex(t,e){const s=this._indexes.get(t);if(!s)throw new a(`Index '${t}' does not exist`,t,"query");return new Set(s.get(e))}findByCriteria(t){const e=Object.keys(t);if(0===e.length)return new Set;let s=null;for(const i of e){const e=String(t[i]),r=this.findByIndex(i,e);if(s=null===s?r:new Set([...s].filter(t=>r.has(t))),0===s.size)break}return s}getOptimalIndex(t){const e=[...t].sort();for(const[t,s]of this._definitions){const i=[...s.fields].sort();if(JSON.stringify(i)===JSON.stringify(e))return t}for(const[e,s]of this._definitions)if(t.every(t=>s.fields.includes(t)))return e;const s=[];for(const[e,i]of this._definitions){const r=t.filter(t=>i.fields.includes(t)).length;r>0&&s.push({name:e,coverage:r,fields:i.fields.length})}return s.length>0?(s.sort((t,e)=>t.coverage!==e.coverage?e.coverage-t.coverage:t.fields-e.fields),s[0].name):null}rebuild(t){for(const t of this._indexes.values())t.clear();for(const[e,s]of t)this.addRecord(e,s);this._stats.lastOptimized=new Date}getStats(){const t={};let e=0;for(const[s,i]of this._definitions){const r=this._indexes.get(s).getStats();t[s]={...i.stats,...r,type:i.type,fields:i.fields},e+=r.memoryUsage}return{indexes:t,totalIndexes:this._definitions.size,totalMemoryUsage:e,performance:{...this._stats,averageOperationTime:this._stats.totalOperations>0?this._stats.totalTime/this._stats.totalOperations:0}}}clear(){for(const t of this._indexes.values())t.clear()}_updatePerformanceStats(t){this._stats.totalOperations++,this._stats.totalTime+=t}}const z={COUNT:"count",TIME:"time",SIZE:"size",NONE:"none"};class D{constructor(t,e={}){this.data=Object.freeze(structuredClone(t)),this.timestamp=new Date,this.size=this._calculateSize(t),this.metadata=Object.freeze({operation:"update",...e}),Object.freeze(this)}_calculateSize(t){try{return 2*JSON.stringify(t).length}catch{return 1024}}isOlderThan(t){return Date.now()-this.timestamp.getTime()>t}getAge(){return Date.now()-this.timestamp.getTime()}toObject(){return{data:this.data,timestamp:this.timestamp.toISOString(),size:this.size,metadata:this.metadata}}}class L{constructor(t,e={}){this.recordKey=t,this.policy=e,this.versions=[],this.totalSize=0,this.createdAt=new Date,this.lastAccessed=new Date}addVersion(t,e={}){const s=new D(t,e);return this.versions.push(s),this.totalSize+=s.size,this.lastAccessed=new Date,this._applyRetentionPolicy(),s}getVersion(t){return this.lastAccessed=new Date,t<0?this.versions[this.versions.length+t]:this.versions[t]}getLatest(){return this.getVersion(-1)}getOldest(){return this.getVersion(0)}getVersionsInRange(t,e){return this.lastAccessed=new Date,this.versions.filter(s=>{const i=s.timestamp;return(!t||i>=t)&&(!e||i<=e)})}getCount(){return this.versions.length}getTotalSize(){return this.totalSize}clear(){const t=this.versions.length;return this.versions=[],this.totalSize=0,t}removeOlderThan(t){const e=this.versions.length,s=Date.now()-t;return this.versions=this.versions.filter(t=>{const e=t.timestamp.getTime()>=s;return e||(this.totalSize-=t.size),e}),e-this.versions.length}_applyRetentionPolicy(){if(!this.policy||this.policy.type===z.NONE)return 0;let t=0;switch(this.policy.type){case z.COUNT:t=this._applyCountPolicy();break;case z.TIME:t=this._applyTimePolicy();break;case z.SIZE:t=this._applySizePolicy();break;default:t=0}return t}_applyCountPolicy(){const t=this.policy.maxCount||10;if(this.versions.length<=t)return 0;const e=this.versions.length-t,s=this.versions.splice(0,e);for(const t of s)this.totalSize-=t.size;return s.length}_applyTimePolicy(){const t=this.policy.maxAge||2592e6;return this.removeOlderThan(t)}_applySizePolicy(){const t=this.policy.maxSize||10485760;if(this.totalSize<=t)return 0;let e=0;for(;this.totalSize>t&&this.versions.length>1;){const t=this.versions.shift();this.totalSize-=t.size,e++}return e}getStats(){return{recordKey:this.recordKey,versionCount:this.versions.length,totalSize:this.totalSize,averageSize:this.versions.length>0?this.totalSize/this.versions.length:0,oldestVersion:this.versions.length>0?this.versions[0].timestamp:null,newestVersion:this.versions.length>0?this.versions[this.versions.length-1].timestamp:null,createdAt:this.createdAt,lastAccessed:this.lastAccessed,policy:this.policy}}}class N{constructor(t={}){this.globalPolicy=this._validatePolicy(t),this.histories=new Map,this.stats={totalHistories:0,totalVersions:0,totalSize:0,lastCleanup:new Date,cleanupCount:0}}enableVersioning(t,e){if(this.histories.has(t))return this.histories.get(t);const s=e||this.globalPolicy,i=new L(t,s);return this.histories.set(t,i),this.stats.totalHistories++,i}disableVersioning(t){const e=this.histories.get(t);return!!e&&(this.stats.totalVersions-=e.getCount(),this.stats.totalSize-=e.getTotalSize(),this.stats.totalHistories--,this.histories.delete(t))}addVersion(t,e,s={}){let i=this.histories.get(t);i||(i=this.enableVersioning(t));const r=i.getCount(),a=i.getTotalSize(),n=i.addVersion(e,s);return this.stats.totalVersions+=i.getCount()-r,this.stats.totalSize+=i.getTotalSize()-a,n}getHistory(t){return this.histories.get(t)}getVersion(t,e){const s=this.histories.get(t);return s?s.getVersion(e):void 0}getLatestVersion(t){const e=this.histories.get(t);return e?e.getLatest():void 0}isVersioningEnabled(t){return this.histories.has(t)}cleanup(t={}){const{recordKeys:e}=t,s={historiesProcessed:0,versionsRemoved:0,sizeFreed:0,startTime:new Date},i=e||Array.from(this.histories.keys());for(const t of i){const e=this.histories.get(t);if(e){const i=e.getCount(),r=e.getTotalSize();e._applyRetentionPolicy();const a=e.getCount(),n=e.getTotalSize();s.historiesProcessed++,s.versionsRemoved+=i-a,s.sizeFreed+=r-n,0===a&&(this.histories.delete(t),this.stats.totalHistories--)}}return this.stats.totalVersions-=s.versionsRemoved,this.stats.totalSize-=s.sizeFreed,this.stats.lastCleanup=new Date,this.stats.cleanupCount++,s.endTime=new Date,s.duration=s.endTime.getTime()-s.startTime.getTime(),s}setGlobalPolicy(t){return this.globalPolicy=this._validatePolicy(t),this}getStats(){let t=0,e=0;const s=[];for(const i of this.histories.values()){const r=i.getStats();s.push(r),t+=r.versionCount,e+=r.totalSize}return{...this.stats,totalHistories:this.histories.size,totalVersions:t,totalSize:e,averageVersionsPerRecord:this.histories.size>0?t/this.histories.size:0,averageSizePerRecord:this.histories.size>0?e/this.histories.size:0,globalPolicy:this.globalPolicy,histories:s}}export(t){const e=t||Array.from(this.histories.keys()),s={globalPolicy:this.globalPolicy,histories:{},exportedAt:(new Date).toISOString()};for(const t of e){const e=this.histories.get(t);e&&(s.histories[t]={policy:e.policy,versions:e.versions.map(t=>t.toObject()),createdAt:e.createdAt.toISOString(),lastAccessed:e.lastAccessed.toISOString()})}return s}import(t,e={}){const{merge:s=!1}=e,i={historiesImported:0,versionsImported:0,errors:[]};s||this.histories.clear(),t.globalPolicy&&(this.globalPolicy=this._validatePolicy(t.globalPolicy));for(const[e,s]of Object.entries(t.histories))try{const t=new L(e,s.policy);t.createdAt=new Date(s.createdAt),t.lastAccessed=new Date(s.lastAccessed);for(const e of s.versions){const s=new D(e.data,e.metadata);Object.defineProperty(s,"timestamp",{value:new Date(e.timestamp),writable:!1}),t.versions.push(s),t.totalSize+=s.size,i.versionsImported++}this.histories.set(e,t),i.historiesImported++}catch(t){i.errors.push({recordKey:e,error:t.message})}return this._updateStats(),i}clear(){const t={historiesCleared:this.histories.size,versionsCleared:this.stats.totalVersions,sizeFreed:this.stats.totalSize};return this.histories.clear(),this.stats={totalHistories:0,totalVersions:0,totalSize:0,lastCleanup:new Date,cleanupCount:this.stats.cleanupCount},t}_validatePolicy(t){if(!t||"object"!=typeof t)return{type:z.NONE};const e=Object.values(z);if(t.type&&!e.includes(t.type))throw new n(`Invalid retention policy type: ${t.type}`,"retentionPolicy.type",t.type);const s={...t};if(s.type===z.COUNT&&void 0!==s.maxCount&&("number"!=typeof s.maxCount||s.maxCount<1))throw new n("maxCount must be a positive number","retentionPolicy.maxCount",s.maxCount);if(s.type===z.TIME&&void 0!==s.maxAge&&("number"!=typeof s.maxAge||s.maxAge<1))throw new n("maxAge must be a positive number","retentionPolicy.maxAge",s.maxAge);if(s.type===z.SIZE&&void 0!==s.maxSize&&("number"!=typeof s.maxSize||s.maxSize<1))throw new n("maxSize must be a positive number","retentionPolicy.maxSize",s.maxSize);return s}_updateStats(){let t=0,e=0;for(const s of this.histories.values())t+=s.getCount(),e+=s.getTotalSize();this.stats.totalHistories=this.histories.size,this.stats.totalVersions=t,this.stats.totalSize=e}}class P{constructor(t,s,i,r,a={}){this.id=e.randomUUID(),this.type=t,this.key=s,this.oldValue=i,this.newValue=r,this.metadata=a,this.timestamp=new Date,Object.freeze(this)}createRollback(){switch(this.type){case R:return void 0===this.oldValue?new P(x,this.key,this.newValue,void 0):new P(R,this.key,this.newValue,this.oldValue);case x:return new P(R,this.key,void 0,this.oldValue);default:throw new c(`Cannot create rollback for operation type: ${this.type}`,null,"rollback")}}}class U{constructor(t=e.randomUUID(),s={}){this.id=t,this.state=y,this.isolationLevel=s.isolationLevel||C.READ_COMMITTED,this.timeout=s.timeout||6e4,this.readOnly=s.readOnly||!1,this.startTime=null,this.endTime=null,this.operations=[],this.readSet=new Set,this.writeSet=new Set,this.snapshot=new Map,this.validationCallback=null,this.abortReason=null,Object.seal(this)}begin(){if(this.state!==y)throw new c(`Cannot begin transaction in state: ${this.state}`,this.id,"begin");return this.state=_,this.startTime=new Date,this}addOperation(t,e,s,i,r={}){if(this._checkActive(),this.readOnly&&"read"!==t)throw new c("Cannot perform write operations in read-only transaction",this.id,"write");if(this._isTimedOut())throw new c("Transaction has timed out",this.id,"timeout");const a=new P(t,e,s,i,r);return this.operations.push(a),"read"===t?this.readSet.add(e):this.writeSet.add(e),a}setValidation(t){return this.validationCallback=t,this}validate(t={}){if(this.validationCallback){const e=this.validationCallback(this,t);if(!0!==e){throw new c("string"==typeof e?e:"Transaction validation failed",this.id,"validation")}}return!0}commit(t={}){this._checkActive();try{return this.validate(t),this.state=w,this.endTime=new Date,this}catch(t){throw this.abort(),t}}abort(t="User abort"){return this.state===S||this.state===w||(this.state=S,this.endTime=new Date,this.abortReason=t),this}getRollbackOperations(){return this.operations.slice().reverse().filter(t=>"read"!==t.type).map(t=>t.createRollback()).filter(t=>null!==t)}isActive(){return this.state===_}isCommitted(){return this.state===w}isAborted(){return this.state===S}getDuration(){if(!this.startTime)return null;return(this.endTime||new Date).getTime()-this.startTime.getTime()}getStats(){return{id:this.id,state:this.state,isolationLevel:this.isolationLevel,readOnly:this.readOnly,startTime:this.startTime,endTime:this.endTime,duration:this.getDuration(),operationCount:this.operations.length,readSetSize:this.readSet.size,writeSetSize:this.writeSet.size,snapshotSize:this.snapshot.size,abortReason:this.abortReason,timedOut:this._isTimedOut()}}export(){return{...this.getStats(),operations:this.operations.map(t=>({id:t.id,type:t.type,key:t.key,timestamp:t.timestamp,metadata:t.metadata})),readSet:Array.from(this.readSet),writeSet:Array.from(this.writeSet)}}_checkActive(){if(this.state!==_)throw new c(`Transaction is not active (current state: ${this.state})`,this.id,"state")}_isTimedOut(){return!!this.startTime&&Date.now()-this.startTime.getTime()>this.timeout}}class ${constructor(){this.locks=new Map,this.lockTimeout=3e4}async acquireLock(t,e,s,i=this.lockTimeout){const r=Date.now();for(;Date.now()-r<i;){if(this._tryAcquireLock(t,e,s))return!0;await new Promise(t=>setTimeout(t,10))}throw new l(`Failed to acquire ${s} lock on record '${e}' within timeout`,e,"lock")}_tryAcquireLock(t,e,s){const i=this.locks.get(e);return i?i.holders.has(t)?i.type!==v||s!==A||1===i.holders.size&&(i.type=A,!0):s===v&&i.type===v&&(i.holders.add(t),!0):(this.locks.set(e,{type:s,holders:new Set([t]),waiters:[]}),!0)}releaseLock(t,e){const s=this.locks.get(e);return!(!s||!s.holders.has(t))&&(s.holders.delete(t),0===s.holders.size&&this.locks.delete(e),!0)}releaseAllLocks(t){let e=0;for(const[s,i]of this.locks)i.holders.has(t)&&(i.holders.delete(t),e++,0===i.holders.size&&this.locks.delete(s));return e}holdsLocks(t){for(const e of this.locks.values())if(e.holders.has(t))return!0;return!1}getStats(){const t={totalLocks:this.locks.size,sharedLocks:0,exclusiveLocks:0,lockHolders:new Set,recordsLocked:[]};for(const[e,s]of this.locks){s.type===v?t.sharedLocks++:t.exclusiveLocks++;for(const e of s.holders)t.lockHolders.add(e);t.recordsLocked.push({recordKey:e,type:s.type,holders:Array.from(s.holders)})}return t.uniqueHolders=t.lockHolders.size,t}}class j{constructor(){this.stats={totalTransactions:0,committedTransactions:0,abortedTransactions:0,activeTransactions:0,averageDuration:0,totalDuration:0}}incrementTotal(){this.stats.totalTransactions++}incrementCommitted(){this.stats.committedTransactions++}incrementAborted(){this.stats.abortedTransactions++}incrementActive(){this.stats.activeTransactions++}decrementActive(){this.stats.activeTransactions--}updateDurationStats(t){const e=t.getDuration();if(null!==e){this.stats.totalDuration+=e;const t=this.stats.committedTransactions+this.stats.abortedTransactions;this.stats.averageDuration=this.stats.totalDuration/t}}getStats(t,e,s){return{...this.stats,activeTransactions:e,lockStats:t,transactionCounter:s}}reset(){this.stats={totalTransactions:0,committedTransactions:0,abortedTransactions:0,activeTransactions:0,averageDuration:0,totalDuration:0}}getRawStats(){return{...this.stats}}}class q{constructor(){this.patternCache=new Map,this.semanticCache=new Map}areKeysRelated(t,e){return t===e||(!!this._hasHierarchicalKeyRelationship(t,e)||(!!this._hasSemanticKeyRelationship(t,e)||(!!this._hasPatternBasedKeyRelationship(t,e)||(!!this._hasCompositeKeyRelationship(t,e)||(!!this._hasTemporalKeyRelationship(t,e)||(!!this._hasIndexKeyRelationship(t,e)||(!!this._hasCollectionKeyRelationship(t,e)||!!this._hasFunctionalDependency(t,e))))))))}isKeyInSnapshotRange(t,e,s,i){return e===s||(this._hasExplicitRangeMetadata(t,s)?this._checkExplicitRange(t,e,s):this._isPatternBasedSnapshot(s)?this._checkPatternBasedRange(e,s):this._hasHierarchicalRelationship(e,s)?this._checkHierarchicalRange(e,s,i):this._isIndexBasedSnapshot(t,s)?this._checkIndexBasedRange(t,e,s):this._hasSemanticRelationship(e,s)?this._checkSemanticRange(e,s):this._isTemporalSnapshot(s)?this._checkTemporalRange(e,s):!!this._isCompositeKeySnapshot(s)&&this._checkCompositeKeyRange(e,s))}keyMatchesRange(t,e){if(void 0!==e.min&&void 0!==e.max)return t>=e.min&&t<=e.max;if(void 0!==e.prefix)return t.startsWith(e.prefix);if(void 0!==e.pattern)try{return new RegExp(e.pattern).test(t)}catch{return!1}return!1}keyMatchesQuery(t,e){if("range"===e.type)return this.keyMatchesRange(t,e);if("prefix"===e.type)return t.startsWith(e.prefix||"");if("pattern"===e.type)try{return new RegExp(e.pattern||"").test(t)}catch{return!1}return"in"===e.type&&(Array.isArray(e.values)&&e.values.includes(t))}keyMatchesIndexRange(t,e){if(e.fields&&Array.isArray(e.fields))for(const s of e.fields)if(t.includes(s))return!0;return!!e.values&&this.keyMatchesRange(t,e.values)}_hasHierarchicalKeyRelationship(t,e){const s=[":","/",".","_","-"];for(const i of s)if(t.includes(i)&&e.includes(i)){const s=t.split(i),r=e.split(i);if(this._isParentChildRelationship(s,r)||this._isSiblingRelationship(s,r)||this._isAncestorDescendantRelationship(s,r))return!0}return t.startsWith(e)||e.startsWith(t)}_hasHierarchicalRelationship(t,e){const s=[":","/",".","_","-"];for(const i of s)if(t.includes(i)&&e.includes(i))return!0;return!1}_checkHierarchicalRange(t,e,s){const i=[":","/",".","_","-"];for(const r of i)if(t.includes(r)&&e.includes(r)){const i=t.split(r),a=e.split(r);if(this._isParentChildRelationship(i,a)||this._isSiblingRelationship(i,a)||this._isCollectionMembership(i,a,s))return!0}return!1}_isParentChildRelationship(t,e){if(t.length>e.length){for(let s=0;s<e.length;s++)if(t[s]!==e[s])return!1;return!0}if(e.length>t.length){for(let s=0;s<t.length;s++)if(t[s]!==e[s])return!1;return!0}return!1}_isSiblingRelationship(t,e){if(t.length===e.length&&t.length>1){for(let s=0;s<t.length-1;s++)if(t[s]!==e[s])return!1;return t[t.length-1]!==e[e.length-1]}return!1}_isAncestorDescendantRelationship(t,e){const s=t.length<e.length?t:e,i=t.length<e.length?e:t;if(s.length<i.length){for(let t=0;t<s.length;t++)if(s[t]!==i[t])return!1;return!0}return!1}_isCollectionMembership(t,e,s){return!!(Array.isArray(s)||s&&"object"==typeof s&&void 0!==s.length)&&(this._isParentChildRelationship(t,e)||this._isSiblingRelationship(t,e))}_hasSemanticKeyRelationship(t,e){const s=this._extractSemanticIdentifiers(t),i=this._extractSemanticIdentifiers(e);for(const t of s)for(const e of i)if(this._areSemanticallySimilar(t,e))return!0;return this._hasEntityRelationship(s,i)}_hasSemanticRelationship(t,e){const s=["user","account","profile","session","order","product","cart","payment","post","comment","thread","message","document","file","folder","workspace"];for(const i of s)if(t.toLowerCase().includes(i)&&e.toLowerCase().includes(i))return!0;return!1}_checkSemanticRange(t,e){const s=this._extractSemanticIdentifiers(t),i=this._extractSemanticIdentifiers(e);for(const t of s)for(const e of i)if(this._areSemanticallySimilar(t,e))return!0;return!1}_extractSemanticIdentifiers(t){const e=`semantic:${t}`;if(this.semanticCache.has(e))return this.semanticCache.get(e);const s=[],i=[/(\w+):(\w+)/g,/(\w+)_(\w+)/g,/([a-z]+)([A-Z]\w+)/g];for(const e of i){let i;for(;null!==(i=e.exec(t));)s.push(i[1].toLowerCase()),i[2]&&s.push(i[2].toLowerCase())}return this.semanticCache.set(e,s),s}_areSemanticallySimilar(t,e){if(t===e)return!0;const s=[["user","users"],["account","accounts"],["profile","profiles"],["order","orders"],["product","products"],["item","items"],["post","posts"],["comment","comments"],["message","messages"],["file","files"],["document","documents"],["folder","folders"]];for(const[i,r]of s)if(t===i&&e===r||t===r&&e===i)return!0;return!1}_hasEntityRelationship(t,e){const s=[["user","profile"],["user","account"],["user","session"],["profile","account"],["account","session"],["user","order"],["user","cart"],["user","payment"],["order","product"],["order","payment"],["cart","product"],["user","post"],["user","comment"],["user","message"],["post","comment"],["thread","message"],["document","file"],["user","workspace"],["workspace","document"],["workspace","folder"],["folder","file"],["document","file"]];for(const[i,r]of s){const s=t.includes(i)&&e.includes(r),a=t.includes(r)&&e.includes(i);if(s||a)return!0}return!1}_hasPatternBasedKeyRelationship(t,e){return this._isPatternBasedSnapshot(t)?this._checkPatternBasedRange(e,t):this._isPatternBasedSnapshot(e)?this._checkPatternBasedRange(t,e):this._haveSimilarPatterns(t,e)}_isPatternBasedSnapshot(t){return t.includes("*")||t.includes("?")||t.includes("[")||t.includes("{")||t.endsWith("_range")||t.endsWith("_pattern")}_checkPatternBasedRange(t,e){if(e.includes("*")){const s=e.replace(/\*/g,".*");try{return new RegExp(`^${s}$`).test(t)}catch{const s=e.split("*")[0];return t.startsWith(s)}}if(e.includes("?")){const s=e.replace(/\?/g,".");try{return new RegExp(`^${s}$`).test(t)}catch{return!1}}if(e.includes("["))try{return new RegExp(`^${e}$`).test(t)}catch{return!1}if(e.includes("{")&&e.includes("}")){const s=e.substring(0,e.indexOf("{")),i=e.substring(e.indexOf("}")+1),r=e.substring(e.indexOf("{")+1,e.indexOf("}")).split(",");for(const e of r){const r=s+e.trim()+i;if(t===r||t.startsWith(r))return!0}}if(e.endsWith("_range")||e.endsWith("_pattern")){const s=e.replace(/_range$|_pattern$/,"");return t.startsWith(s)}return!1}_haveSimilarPatterns(t,e){const s=this._extractKeyPattern(t),i=this._extractKeyPattern(e);return this._patternsAreSimilar(s,i)}_extractKeyPattern(t){const e=`pattern:${t}`;if(this.patternCache.has(e))return this.patternCache.get(e);const s=t.replace(/\d+/g,"#").replace(/[a-f0-9]{8,}/g,"&").replace(/\w{1,3}(?=:|_|-)/g,"@");return this.patternCache.set(e,s),s}_patternsAreSimilar(t,e){if(t===e)return!0;return this._calculatePatternSimilarity(t,e)>.7}_calculatePatternSimilarity(t,e){const s=t.length,i=e.length,r=Math.max(s,i);if(0===r)return 1;return 1-this._levenshteinDistance(t,e)/r}_levenshteinDistance(t,e){const s=[];for(let t=0;t<=e.length;t++)s[t]=[t];for(let e=0;e<=t.length;e++)s[0][e]=e;for(let i=1;i<=e.length;i++)for(let r=1;r<=t.length;r++)e.charAt(i-1)===t.charAt(r-1)?s[i][r]=s[i-1][r-1]:s[i][r]=Math.min(s[i-1][r-1]+1,s[i][r-1]+1,s[i-1][r]+1);return s[e.length][t.length]}_hasTemporalKeyRelationship(t,e){if(this._isTemporalSnapshot(t)&&this._isTemporalSnapshot(e)){const s=this._extractTemporalComponents(t),i=this._extractTemporalComponents(e);return this._haveTemporalOverlap(s,i)}return!1}_isTemporalSnapshot(t){return["timestamp","time","date","created","updated","modified","datetime","ts","epoch","iso","utc","log","event","history"].some(e=>t.toLowerCase().includes(e))}_checkTemporalRange(t,e){if(this._isTemporalSnapshot(t)){const s=this._extractTemporalComponents(t),i=this._extractTemporalComponents(e);return this._haveTemporalOverlap(s,i)}return!1}_extractTemporalComponents(t){const e={hasDate:!1,hasTime:!1,hasTimestamp:!1,hasEpoch:!1};return/\d{4}-\d{2}-\d{2}/.test(t)&&(e.hasDate=!0),/\d{2}:\d{2}:\d{2}/.test(t)&&(e.hasTime=!0),/\d{13}/.test(t)&&(e.hasTimestamp=!0),/\d{10}/.test(t)&&(e.hasEpoch=!0),e}_haveTemporalOverlap(t,e){return t.hasDate&&e.hasDate||t.hasTime&&e.hasTime||t.hasTimestamp&&e.hasTimestamp||t.hasEpoch&&e.hasEpoch}_hasCompositeKeyRelationship(t,e){return this._checkCompositeKeyRange(t,e)||this._checkCompositeKeyRange(e,t)}_isCompositeKeySnapshot(t){return t.includes(":")||t.includes("#")||t.includes("|")||t.includes("@")||t.split("_").length>2||t.split("-").length>2}_checkCompositeKeyRange(t,e){const s=[":","#","|","@","_","-"];for(const i of s)if(t.includes(i)&&e.includes(i)){const s=t.split(i),r=e.split(i);if(this._hasCompositeKeyOverlap(s,r))return!0}return!1}_hasCompositeKeyOverlap(t,e){const s=Math.min(t.length,e.length);for(let i=1;i<=s;i++){let s=!0;for(let r=0;r<i;r++)if(t[r]!==e[r]){s=!1;break}if(s)return!0}return!1}_hasIndexKeyRelationship(t,e){const s=this._isIndexKey(t),i=this._isIndexKey(e);if(s||i){const s=this._extractBaseKeyFromIndex(t),i=this._extractBaseKeyFromIndex(e);return s===i||t.startsWith(i)||e.startsWith(s)||s.startsWith(i)||i.startsWith(s)}return!1}_isIndexKey(t){return t.includes("_index")||t.includes("_idx")||t.startsWith("idx_")||t.includes("_key")||t.includes("_lookup")}_extractBaseKeyFromIndex(t){return t.replace(/_index.*$/,"").replace(/_idx.*$/,"").replace(/^idx_/,"").replace(/_key.*$/,"").replace(/_lookup.*$/,"")}_isIndexBasedSnapshot(t,e){return e.includes("_index")||e.includes("_idx")||e.startsWith("idx_")||t.snapshot.has(`${e}:index_range`)}_checkIndexBasedRange(t,e,s){const i=t.snapshot.get(`${s}:index_range`);if(i)return this.keyMatchesIndexRange(e,i);if(s.includes("_index")||s.includes("_idx")){const t=s.replace(/_index.*$|_idx.*$/,"");return e.startsWith(t)}return!1}_hasCollectionKeyRelationship(t,e){const s=this._isCollectionKey(t),i=this._isCollectionKey(e);if(s||i){const s=this._extractCollectionBase(t),i=this._extractCollectionBase(e);return s===i||t.startsWith(i)||e.startsWith(s)}return!1}_isCollectionKey(t){return["_list","_array","_set","_collection","_items","_elements","_members","_entries"].some(e=>t.includes(e))}_extractCollectionBase(t){const e=["_list","_array","_set","_collection","_items","_elements","_members","_entries"];for(const s of e)if(t.includes(s))return t.replace(s,"");return t}_hasFunctionalDependency(t,e){const s=[["user_id","user_email"],["user_id","user_profile"],["account_id","user_id"],["session_id","user_id"],["order_id","user_id"],["order_id","order_total"],["payment_id","order_id"],["shipping_id","order_id"],["post_id","user_id"],["comment_id","post_id"],["message_id","thread_id"],["file_id","folder_id"],["document_id","workspace_id"],["task_id","project_id"]],i=this._normalizeKeyForDependency(t),r=this._normalizeKeyForDependency(e);for(const[t,e]of s)if(i.includes(t)&&r.includes(e)||i.includes(e)&&r.includes(t))return!0;return!1}_normalizeKeyForDependency(t){return t.toLowerCase().replace(/[:\-/.]/g,"_").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}_hasExplicitRangeMetadata(t,e){return t.snapshot.has(`${e}:range`)||t.snapshot.has(`${e}:query`)||t.snapshot.has(`${e}:predicate`)}_checkExplicitRange(t,e,s){const i=t.snapshot.get(`${s}:range`);if(i&&"object"==typeof i)return this.keyMatchesRange(e,i);const r=t.snapshot.get(`${s}:query`);if(r)return this.keyMatchesQuery(e,r);const a=t.snapshot.get(`${s}:predicate`);if(a&&"function"==typeof a)try{return a(e)}catch{return!1}return!1}clearCaches(){this.patternCache.clear(),this.semanticCache.clear()}}class F{constructor(t){this.lockManager=t,this.keyAnalyzer=new q}detectDeadlocks(t,e={}){const s={useLockGraph:!0,useResourceGraph:!0,useTimeoutDetection:!0,timeoutThreshold:1e4,...e},i={deadlocks:[],suspectedDeadlocks:[],timeoutVictims:[],waitForGraph:null,resourceGraph:null};if(t.length<2)return i;if(s.useLockGraph){const e=this._detectLockBasedDeadlocks(t);i.deadlocks.push(...e.cycles),i.waitForGraph=e.graph}if(s.useResourceGraph){const e=this._detectResourceDeadlocks(t);i.deadlocks.push(...e.cycles),i.resourceGraph=e.graph}const r=this._detectIsolationDeadlocks(t);if(i.suspectedDeadlocks.push(...r),s.useTimeoutDetection){const e=this._detectTimeoutVictims(t,s.timeoutThreshold);i.timeoutVictims.push(...e)}return i.deadlocks=this._deduplicateDeadlocks(i.deadlocks),i}_detectLockBasedDeadlocks(t){const e=this._buildLockWaitForGraph(t);return{graph:e,cycles:this._detectCyclesInGraph(e).map(e=>({type:"lock",transactions:e,resources:this._getResourcesInvolvedInCycle(e,t)}))}}_buildLockWaitForGraph(t){const e=new Map,s=this.lockManager.getStats();for(const s of t)e.set(s.id,new Set);for(const i of s.recordsLocked){const{recordKey:s,holders:r}=i,a=this._findTransactionsWaitingForLock(s,t);for(const t of a)for(const s of r)t!==s&&e.has(t)&&e.has(s)&&e.get(t).add(s)}return e}_findTransactionsWaitingForLock(t,e){const s=[];for(const i of e){const e=i.writeSet.has(t)||i.readSet.has(t),r=this.lockManager.holdsLocks(i.id);e&&!r&&s.push(i.id)}return s}_detectResourceDeadlocks(t){const e=this._buildResourceAllocationGraph(t);return{graph:e,cycles:this._detectCyclesInResourceGraph(e).map(t=>({type:"resource",transactions:t.transactions,resources:t.resources}))}}_buildResourceAllocationGraph(t){const e={transactions:new Map,resources:new Map,waiting:new Map};for(const s of t)e.transactions.set(s.id,new Set),e.waiting.set(s.id,new Set);const s=this.lockManager.getStats();for(const i of s.recordsLocked){const{recordKey:s,holders:r}=i;e.resources.has(s)||e.resources.set(s,new Set);for(const t of r)e.transactions.has(t)&&(e.transactions.get(t).add(s),e.resources.get(s).add(t));const a=this._findTransactionsWaitingForLock(s,t);for(const t of a)e.waiting.has(t)&&e.waiting.get(t).add(s)}return e}_detectCyclesInGraph(t){const e=new Set,s=new Set,i=[],r=(a,n)=>{if(s.has(a)){const t=n.indexOf(a),e=n.slice(t);return void i.push([...e,a])}if(e.has(a))return;e.add(a),s.add(a),n.push(a);const o=t.get(a)||new Set;for(const t of o)r(t,[...n]);s.delete(a)};for(const s of t.keys())e.has(s)||r(s,[]);return i}_detectCyclesInResourceGraph(t){const e=[],s=new Map;for(const[e]of t.transactions)s.set(e,new Set);for(const[e,i]of t.waiting)for(const r of i){const i=t.resources.get(r)||new Set;for(const t of i)e!==t&&s.get(e).add(t)}const i=this._detectCyclesInGraph(s);for(const s of i){const i=this._getResourcesInvolvedInCycle(s,Array.from(t.transactions.keys()).map(t=>({id:t})));e.push({transactions:s,resources:Array.from(i)})}return e}_getResourcesInvolvedInCycle(t,e){const s=new Set;for(const i of t){const t=e.find(t=>t.id===i);if(t&&t.writeSet&&t.readSet){for(const e of t.writeSet)s.add(e);for(const e of t.readSet)s.add(e)}}return s}_detectIsolationDeadlocks(t){const e=[];for(let s=0;s<t.length;s++)for(let i=s+1;i<t.length;i++){const r=t[s],a=t[i];this._hasIsolationConflict(r,a)&&e.push({type:"isolation",transactions:[r.id,a.id],conflict:this._getIsolationConflictType(r,a)})}return e}_hasIsolationConflict(t,e){if(t.isolationLevel>=C.REPEATABLE_READ||e.isolationLevel>=C.REPEATABLE_READ){const s=this._readsOtherWrites(t,e),i=this._readsOtherWrites(e,t);return s||i}return!1}_getIsolationConflictType(t,e){return this._readsOtherWrites(t,e)&&this._readsOtherWrites(e,t)?"bidirectional-dependency":this._readsOtherWrites(t,e)?"tx1-depends-on-tx2":this._readsOtherWrites(e,t)?"tx2-depends-on-tx1":"unknown"}_readsOtherWrites(t,e){for(const s of t.readSet)if(e.writeSet.has(s))return!0;return!1}_detectTimeoutVictims(t,e){const s=[];for(const i of t){const t=i.getDuration();null!==t&&t>e&&s.push(i.id)}return s}_deduplicateDeadlocks(t){const e=new Set,s=[];for(const i of t){const t=this._createDeadlockSignature(i);e.has(t)||(e.add(t),s.push(i))}return s}_createDeadlockSignature(t){const e=[...t.transactions].sort(),s=t.resources?[...t.resources].sort():[];return`${t.type}:${e.join(",")}:${s.join(",")}`}}class K{constructor(){this.keyAnalyzer=new q}validateIsolation(t,e){switch(t.isolationLevel){case C.READ_UNCOMMITTED:break;case C.READ_COMMITTED:this._validateReadCommitted(t,e);break;case C.REPEATABLE_READ:this._validateRepeatableRead(t,e);break;case C.SERIALIZABLE:this._validateSerializable(t,e);break;default:throw new c(`Unknown isolation level: ${t.isolationLevel}`,t.id,"isolation")}}_validateReadCommitted(t,e){for(const s of t.writeSet){const i=this._findConflictingWrites(t.id,s,e);if(i.length>0)throw new c(`Write conflict detected on key '${s}' with transactions: ${i.join(", ")}`,t.id,"write-conflict")}}_validateRepeatableRead(t,e){this._validateReadCommitted(t,e);for(const s of t.readSet)if(this._hasReadSetConflict(t,s,e))throw new c(`Repeatable read violation: key '${s}' was modified by another transaction`,t.id,"repeatable-read-violation");if(t.snapshot.size>0)for(const[s,i]of t.snapshot)if(this._hasSnapshotConflict(t,s,i,e))throw new c(`Phantom read detected: snapshot inconsistency for key '${s}'`,t.id,"phantom-read")}_validateSerializable(t,e){this._validateRepeatableRead(t,e);for(const s of t.readSet){const i=this._findConflictingWritesToRead(t,s,e);if(i.length>0)throw new c(`Serialization conflict: key '${s}' was written by concurrent transactions: ${i.join(", ")}`,t.id,"serialization-conflict")}for(const s of t.writeSet){const i=this._findConflictingReadsToWrite(t,s,e);if(i.length>0)throw new c(`Serialization conflict: key '${s}' was read by concurrent transactions: ${i.join(", ")}`,t.id,"serialization-conflict")}}_findConflictingWrites(t,e,s){const i=[];for(const[r,a]of s)r!==t&&a.isActive()&&a.writeSet.has(e)&&i.push(r);return i}_findConflictingWritesToRead(t,e,s){const i=[];for(const[r,a]of s)r!==t.id&&a.isActive()&&a.writeSet.has(e)&&this._transactionsOverlap(t,a)&&i.push(r);return i}_findConflictingReadsToWrite(t,e,s){const i=[];for(const[r,a]of s)r!==t.id&&a.isActive()&&a.readSet.has(e)&&this._transactionsOverlap(t,a)&&i.push(r);return i}_hasReadSetConflict(t,e,s){for(const[i,r]of s)if(i!==t.id&&r.isCommitted()&&r.writeSet.has(e)&&r.startTime>t.startTime&&r.endTime<new Date)return!0;return!1}_hasSnapshotConflict(t,e,s,i){if(this._hasReadSetConflict(t,e,i))return!0;for(const[r,a]of i)if(r!==t.id&&this._transactionsOverlap(t,a)&&this._hasPhantomConflict(t,a,e,s))return!0;return!!this._hasSerializationAnomalyInSnapshot(t,e,i)}_hasPhantomConflict(t,e,s,i){for(const r of e.operations)if("read"!==r.type){if(r.key===s)return!0;if(this.keyAnalyzer.isKeyInSnapshotRange(t,r.key,s,i))return!0}return!1}_hasSerializationAnomalyInSnapshot(t,e,s){for(const[i,r]of s)if(i!==t.id&&r.isActive()&&this._transactionsOverlap(t,r)){if(this._hasWriteSkewAnomaly(t,r,e))return!0;if(this._hasDependencyCycle(t,r))return!0}return!1}_hasWriteSkewAnomaly(t,e,s){const i=this._hasRelatedReads(t,s),r=this._hasRelatedReads(e,s);if(!i||!r)return!1;const a=Array.from(t.writeSet),n=Array.from(e.writeSet);return!a.some(t=>n.includes(t))&&(a.length>0&&n.length>0)}_hasRelatedReads(t,e){for(const s of t.readSet)if(this.keyAnalyzer.areKeysRelated(s,e))return!0;return!1}_hasDependencyCycle(t,e){const s=this._readsOtherWrites(t,e),i=this._readsOtherWrites(e,t);return s&&i}_readsOtherWrites(t,e){for(const s of t.readSet)if(e.writeSet.has(s))return!0;return!1}_transactionsOverlap(t,e){if(!t.startTime||!e.startTime)return!1;const s=t.startTime.getTime(),i=t.endTime?t.endTime.getTime():Date.now(),r=e.startTime.getTime();return s<(e.endTime?e.endTime.getTime():Date.now())&&r<i}}class V{constructor(){this.transactions=new Map,this.lockManager=new $,this.transactionCounter=0,this.statistics=new j,this.deadlockDetector=new F(this.lockManager),this.isolationValidator=new K}begin(t={}){const e=new U(void 0,t);return e.begin(),this.transactions.set(e.id,e),this.transactionCounter++,this.statistics.incrementTotal(),this.statistics.incrementActive(),e}getTransaction(t){return this.transactions.get(t)}async commit(t,e={}){const s=this.transactions.get(t);if(!s)throw new c(`Transaction ${t} not found`,t,"commit");try{for(const e of s.writeSet)await this.lockManager.acquireLock(t,e,A);return this.isolationValidator.validateIsolation(s,this.transactions),s.commit(e),this.statistics.incrementCommitted(),this.statistics.decrementActive(),this.statistics.updateDurationStats(s),s}catch(e){throw this.abort(t,e.message),e}finally{this.lockManager.releaseAllLocks(t)}}abort(t,e="Manual abort"){const s=this.transactions.get(t);if(!s)throw new c(`Transaction ${t} not found`,t,"abort");return s.abort(e),this.lockManager.releaseAllLocks(t),this.statistics.incrementAborted(),this.statistics.decrementActive(),this.statistics.updateDurationStats(s),s}cleanup(t=36e5){const e=Date.now()-t;let s=0;for(const[i,r]of this.transactions)r.endTime&&(0===t||r.endTime.getTime()<e)&&(this.transactions.delete(i),s++);return s}getActiveTransactions(){return Array.from(this.transactions.values()).filter(t=>t.isActive())}detectDeadlocks(t={}){const e=this.getActiveTransactions();return this.deadlockDetector.detectDeadlocks(e,t)}getStats(){const t=this.getActiveTransactions().length,e=this.lockManager.getStats();return this.statistics.getStats(e,t,this.transactionCounter)}resetStats(){this.statistics.reset()}getComponents(){return{statistics:this.statistics,deadlockDetector:this.deadlockDetector,isolationValidator:this.isolationValidator,lockManager:this.lockManager}}validateTransactionIsolation(t){const e=this.transactions.get(t);if(!e)throw new c(`Transaction ${t} not found`,t,"validate");this.isolationValidator.validateIsolation(e,this.transactions)}checkForDeadlocks(t={}){return this.detectDeadlocks(t)}getTransactionDetails(t){const e=this.transactions.get(t);return e?{...e.getStats(),lockInfo:this.lockManager.getStats().recordsLocked.filter(e=>e.holders.includes(t))}:null}getSystemHealth(){const t=this.getStats(),e=this.detectDeadlocks();return{activeTransactions:t.activeTransactions,totalTransactions:t.totalTransactions,commitRate:t.totalTransactions>0?t.committedTransactions/t.totalTransactions:0,averageDuration:t.averageDuration,hasDeadlocks:e.deadlocks.length>0,suspectedDeadlocks:e.suspectedDeadlocks.length,timeoutVictims:e.timeoutVictims.length,totalLocks:t.lockStats.totalLocks,lockUtilization:t.lockStats.totalLocks>0?t.lockStats.uniqueHolders/t.lockStats.totalLocks:0}}}const H={INDEX_LOOKUP:1,FULL_SCAN:100,FILTER_EVALUATION:10,SORT_OPERATION:50,MEMORY_ACCESS:1,COMPARISON:2,REGEX_MATCH:20};class B{constructor(t,e={},s=0,i=0){this.operation=t,this.options=e,this.estimatedCost=s,this.estimatedRows=i,this.actualCost=null,this.actualRows=null,this.startTime=null,this.endTime=null}startExecution(){this.startTime=Date.now()}endExecution(t){this.endTime=Date.now(),this.actualCost=this.endTime-this.startTime,this.actualRows=t}getStats(){return{operation:this.operation,options:this.options,estimatedCost:this.estimatedCost,estimatedRows:this.estimatedRows,actualCost:this.actualCost,actualRows:this.actualRows,costAccuracy:this.actualCost&&this.estimatedCost?Math.abs(this.actualCost-this.estimatedCost)/this.estimatedCost:null,rowAccuracy:null!==this.actualRows&&this.estimatedRows?Math.abs(this.actualRows-this.estimatedRows)/this.estimatedRows:null}}}class W{constructor(t,e){this.queryId=t,this.originalQuery=e,this.steps=[],this.totalEstimatedCost=0,this.totalEstimatedRows=0,this.totalActualCost=null,this.totalActualRows=null,this.createdAt=new Date,this.executedAt=null,this.completedAt=null}addStep(t){return this.steps.push(t),this.totalEstimatedCost+=t.estimatedCost,this}startExecution(){this.executedAt=new Date}completeExecution(t){this.completedAt=new Date,this.totalActualRows=t,this.totalActualCost=this.completedAt.getTime()-(this.executedAt?.getTime()||this.createdAt.getTime())}getStats(){return{queryId:this.queryId,originalQuery:this.originalQuery,stepCount:this.steps.length,totalEstimatedCost:this.totalEstimatedCost,totalEstimatedRows:this.totalEstimatedRows,totalActualCost:this.totalActualCost,totalActualRows:this.totalActualRows,createdAt:this.createdAt,executedAt:this.executedAt,completedAt:this.completedAt,steps:this.steps.map(t=>t.getStats()),efficiency:this.totalActualCost&&this.totalEstimatedCost?this.totalEstimatedCost/this.totalActualCost:null}}export(){return{...this.getStats(),explanation:this._generateExplanation()}}_generateExplanation(){const t=[];return t.push(`Query Plan for: ${JSON.stringify(this.originalQuery)}`),t.push(`Estimated cost: ${this.totalEstimatedCost}, rows: ${this.totalEstimatedRows}`),null!==this.totalActualCost&&t.push(`Actual cost: ${this.totalActualCost}, rows: ${this.totalActualRows}`),t.push(""),t.push("Execution steps:"),this.steps.forEach((e,s)=>{const i=e.getStats();t.push(`${s+1}. ${i.operation} (cost: ${i.estimatedCost}, rows: ${i.estimatedRows})`),null!==i.actualCost&&t.push(`   Actual: cost: ${i.actualCost}, rows: ${i.actualRows}`)}),t}}class G{constructor(){this.totalRecords=0,this.indexStatistics=new Map,this.fieldStatistics=new Map,this.lastUpdated=new Date}update(t,e){this.totalRecords=t.size,this.lastUpdated=new Date,this._updateFieldStatistics(t),this._updateIndexStatistics(e)}getSelectivity(t){const e=this.fieldStatistics.get(t);return e?1/(e.uniqueValues||1):.1}getIndexCardinality(t){const e=this.indexStatistics.get(t);return e?e.cardinality:this.totalRecords}_updateFieldStatistics(t){const e=new Map;for(const s of t.values())for(const[t,i]of Object.entries(s)){e.has(t)||e.set(t,{values:new Set,nullCount:0,totalLength:0,count:0});const s=e.get(t);s.count++,null==i?s.nullCount++:(s.values.add(i),"string"==typeof i&&(s.totalLength+=i.length))}for(const[t,s]of e)this.fieldStatistics.set(t,{uniqueValues:s.values.size,nullCount:s.nullCount,dataType:this._inferDataType(s.values),avgLength:s.totalLength/s.count||0,cardinality:s.values.size/this.totalRecords})}_updateIndexStatistics(t){for(const[e,s]of t){const t=s.getStats();this.indexStatistics.set(e,{cardinality:t.totalKeys,selectivity:t.totalKeys/this.totalRecords||1,avgEntriesPerKey:t.totalEntries/t.totalKeys||1,memoryUsage:t.memoryUsage})}}_inferDataType(t){const e=Array.from(t).slice(0,10),s=new Set(e.map(t=>typeof t));return 1===s.size?s.values().next().value:"mixed"}}class Y{constructor(t={}){this.options={collectStatistics:!0,statisticsUpdateInterval:1e3,...t},this.statistics=new G,this.queryCounter=0,this.planCache=new Map,this.executionHistory=[],this.maxHistorySize=1e3,this.cacheHits=0,this.totalCacheRequests=0,this.costAdjustments=new Map([["INDEX_LOOKUP",1],["FULL_SCAN",1],["FILTER_EVALUATION",1],["SORT_OPERATION",1],["MEMORY_ACCESS",1],["COMPARISON",1],["REGEX_MATCH",1]]),this.lastCostModelUpdate=new Date}createPlan(t,e){const s="query_"+ ++this.queryCounter,i=new W(s,t);this.totalCacheRequests++;const r=this._generateCacheKey(t),a=this.planCache.get(r);return a&&this._isCacheValid(a)?(this.cacheHits++,this._copyPlan(a,s)):(this._buildOptimizedPlan(i,t,e),this.planCache.set(r,i),i)}updateStatistics(t,e){this.statistics.update(t,e)}recordExecution(t){this.options.collectStatistics&&(this.executionHistory.push(t.getStats()),this.executionHistory.length>this.maxHistorySize&&this.executionHistory.shift(),this.queryCounter%this.options.statisticsUpdateInterval===0&&this._updateCostModel())}getOptimalStrategy(t,e){const s=this._generateStrategies(t,e).map(t=>({...t,estimatedCost:this._estimateStrategyCost(t)}));return s.sort((t,e)=>t.estimatedCost-e.estimatedCost),s[0]||{type:"full_scan",estimatedCost:this._getAdjustedCostFactor("FULL_SCAN")*this.statistics.totalRecords}}getStats(){return{queryCounter:this.queryCounter,planCacheSize:this.planCache.size,executionHistorySize:this.executionHistory.length,dataStatistics:{totalRecords:this.statistics.totalRecords,lastUpdated:this.statistics.lastUpdated,indexCount:this.statistics.indexStatistics.size,fieldCount:this.statistics.fieldStatistics.size},averageQueryCost:this._calculateAverageQueryCost(),cacheHitRate:this._calculateCacheHitRate(),cacheStatistics:{totalRequests:this.totalCacheRequests,hits:this.cacheHits,misses:this.totalCacheRequests-this.cacheHits,hitRate:this._calculateCacheHitRate()},costModel:{adjustments:Object.fromEntries(this.costAdjustments),lastUpdated:this.lastCostModelUpdate}}}clear(){this.planCache.clear(),this.executionHistory=[],this.queryCounter=0,this.cacheHits=0,this.totalCacheRequests=0,this.costAdjustments.clear(),this.costAdjustments.set("INDEX_LOOKUP",1),this.costAdjustments.set("FULL_SCAN",1),this.costAdjustments.set("FILTER_EVALUATION",1),this.costAdjustments.set("SORT_OPERATION",1),this.costAdjustments.set("MEMORY_ACCESS",1),this.costAdjustments.set("COMPARISON",1),this.costAdjustments.set("REGEX_MATCH",1),this.lastCostModelUpdate=new Date}_buildOptimizedPlan(t,e,s){const i=this.getOptimalStrategy(e,s);switch(i.type){case"index_lookup":this._addIndexLookupSteps(t,i);break;case"filtered_scan":this._addFilteredScanSteps(t,e,i);break;default:this._addFullScanSteps(t)}this._addPostProcessingSteps(t,e)}_addIndexLookupSteps(t,e){const s=new B("index_lookup",{indexName:e.indexName,lookupKey:e.lookupKey},this._getAdjustedCostFactor("INDEX_LOOKUP"),this._estimateIndexLookupRows(e.indexName));t.addStep(s)}_addFilteredScanSteps(t,e,s){s.indexName&&this._addIndexLookupSteps(t,s);const i=new B("filter",{predicate:e.filter||e.where},this._getAdjustedCostFactor("FILTER_EVALUATION")*this.statistics.totalRecords,.1*this.statistics.totalRecords);t.addStep(i)}_addFullScanSteps(t){const e=new B("full_scan",{scanType:"sequential"},this._getAdjustedCostFactor("FULL_SCAN")*this.statistics.totalRecords,this.statistics.totalRecords);t.addStep(e)}_addPostProcessingSteps(t,e){if(e.sort||e.sortBy){const s=new B("sort",{sortField:e.sortBy,sortFunction:e.sort},this._getAdjustedCostFactor("SORT_OPERATION")*t.totalEstimatedRows,t.totalEstimatedRows);t.addStep(s)}if(e.limit){const s=new B("limit",{offset:e.offset||0,max:e.limit},this._getAdjustedCostFactor("MEMORY_ACCESS"),Math.min(e.limit,t.totalEstimatedRows));t.addStep(s)}}_generateStrategies(t,e){const s=[];if(s.push({type:"full_scan"}),t.find&&e.indexManager){const i=Object.keys(t.find),r=e.indexManager.getOptimalIndex(i);r&&s.push({type:"index_lookup",indexName:r,lookupKey:this._generateLookupKey(t.find,i)})}if((t.filter||t.where)&&e.indexManager){const t=e.indexManager.listIndexes();for(const e of t)s.push({type:"filtered_scan",indexName:e,partialFilter:!0})}return s}_estimateStrategyCost(t){switch(t.type){case"index_lookup":return this._getAdjustedCostFactor("INDEX_LOOKUP")+this._estimateIndexLookupRows(t.indexName,t.lookupKey)*this._getAdjustedCostFactor("MEMORY_ACCESS");case"filtered_scan":return(t.indexName?this._getAdjustedCostFactor("INDEX_LOOKUP"):0)+this._getAdjustedCostFactor("FILTER_EVALUATION")*this.statistics.totalRecords;case"full_scan":return this._getAdjustedCostFactor("FULL_SCAN")*this.statistics.totalRecords;default:return Number.MAX_SAFE_INTEGER}}_getAdjustedCostFactor(t){return(H[t]||1)*(this.costAdjustments.get(t)||1)}_estimateIndexLookupRows(t){const e=this.statistics.indexStatistics.get(t);return e?Math.max(1,this.statistics.totalRecords/e.cardinality):.1*this.statistics.totalRecords}_generateCacheKey(t){return JSON.stringify(t)}_isCacheValid(t){return Date.now()-t.createdAt.getTime()<3e5}_copyPlan(t,e){const s=new W(e,t.originalQuery);for(const e of t.steps){const t=new B(e.operation,e.options,e.estimatedCost,e.estimatedRows);s.addStep(t)}return s}_generateLookupKey(t,e){return e.sort().map(e=>String(t[e])).join("|")}_updateCostModel(){if(this.executionHistory.length<10)return;this.lastCostModelUpdate=new Date;const t=this._analyzeOperationPerformance();for(const[e,s]of t)if(s.sampleSize>=3){const t=this.costAdjustments.get(e)||1;let i=t;const r=s.avgActualCost/s.avgEstimatedCost;if(s.consistency>.7){i=t*(1+.1*(r-1)),i=Math.max(.1,Math.min(10,i)),this.costAdjustments.set(e,i)}}this.executionHistory.length>.8*this.maxHistorySize&&(this.executionHistory=this.executionHistory.slice(-Math.floor(.6*this.maxHistorySize)))}_analyzeOperationPerformance(){const t=new Map;for(const e of this.executionHistory)if(e.steps&&Array.isArray(e.steps))for(const s of e.steps)if(s.operation&&null!==s.actualCost&&0!==s.estimatedCost){const e=this._mapOperationToCostFactor(s.operation);if(e){t.has(e)||t.set(e,{sampleSize:0,totalActualCost:0,totalEstimatedCost:0,costs:[],estimatedCosts:[]});const i=t.get(e);i.sampleSize++,i.totalActualCost+=s.actualCost,i.totalEstimatedCost+=s.estimatedCost,i.costs.push(s.actualCost),i.estimatedCosts.push(s.estimatedCost)}}for(const[,e]of t){e.avgActualCost=e.totalActualCost/e.sampleSize,e.avgEstimatedCost=e.totalEstimatedCost/e.sampleSize;const t=this._calculateVariance(e.costs,e.avgActualCost),s=Math.sqrt(t)/e.avgActualCost;e.consistency=Math.max(0,1-s);const i=e.costs.map((t,s)=>{const i=e.estimatedCosts[s];return 1-Math.abs(t-i)/Math.max(t,i)});e.accuracy=i.reduce((t,e)=>t+e,0)/i.length}return t}_mapOperationToCostFactor(t){return{index_lookup:"INDEX_LOOKUP",full_scan:"FULL_SCAN",filter:"FILTER_EVALUATION",sort:"SORT_OPERATION",limit:"MEMORY_ACCESS",regex:"REGEX_MATCH"}[t]||null}_calculateVariance(t,e){if(t.length<=1)return 0;return t.map(t=>Math.pow(t-e,2)).reduce((t,e)=>t+e,0)/(t.length-1)}_calculateAverageQueryCost(){if(0===this.executionHistory.length)return 0;return this.executionHistory.reduce((t,e)=>t+(e.totalActualCost||0),0)/this.executionHistory.length}_calculateCacheHitRate(){return 0===this.totalCacheRequests?0:this.cacheHits/this.totalCacheRequests}}class Q{constructor(t=new Map){this._data=new Map(t),this._frozenViews=new WeakMap,Object.freeze(this)}get(t){const e=this._data.get(t);if(!e)return null;if(this._frozenViews.has(e))return this._frozenViews.get(e);const s=this._deepFreeze(structuredClone(e));return this._frozenViews.set(e,s),s}set(t,e){const s=new Map(this._data);return s.set(t,e),new Q(s)}delete(t){const e=new Map(this._data);return e.delete(t),new Q(e)}has(t){return this._data.has(t)}keys(){return Array.from(this._data.keys())}get size(){return this._data.size}entries(){return Array.from(this._data.entries())}_deepFreeze(t){return null===t||"object"!=typeof t?t:(Array.isArray(t)?t.forEach(t=>this._deepFreeze(t)):Object.values(t).forEach(t=>this._deepFreeze(t)),Object.freeze(t))}}class J{constructor(t,e={}){this.iterator=t,this.options={batchSize:1e3,bufferSize:1e4,...e},this.buffer=[],this.ended=!1,this.position=0}async read(t=this.options.batchSize){const e=[];for(;e.length<t&&!this.ended;){const{value:t,done:s}=this.iterator.next();if(s){this.ended=!0;break}e.push(t),this.position++}return e}async readAll(){const t=[];for(;!this.ended;){const e=await this.read();t.push(...e)}return t}map(t){return new J({next:()=>{const{value:e,done:s}=this.iterator.next();return s?{done:!0}:{value:t(e),done:!1}}},this.options)}filter(t){return new J({next:()=>{for(;;){const{value:e,done:s}=this.iterator.next();if(s)return{done:!0};if(t(e))return{value:e,done:!1}}}},this.options)}take(t){let e=0;return new J({next:()=>{if(e>=t)return{done:!0};const{value:s,done:i}=this.iterator.next();return i?{done:!0}:(e++,{value:s,done:!1})}},this.options)}getStats(){return{position:this.position,ended:this.ended,bufferSize:this.buffer.length,options:this.options}}}class X{constructor(t={}){this.config={immutable:!1,...t},this.config.immutable?this._store=new Q:this._store=new Map}get(t){return this._store.get(t)||null}set(t,e){return this.config.immutable?this._store=this._store.set(t,e):this._store.set(t,e),!0}delete(t){return this.config.immutable?this._store=this._store.delete(t):this._store.delete(t),!0}has(t){return this._store.has(t)}keys(){return this.config.immutable?this._store.keys():Array.from(this._store.keys())}entries(){return this.config.immutable?this._store.entries():Array.from(this._store.entries())}get size(){return this._store.size}clear(){this.config.immutable?this._store=new Q:this._store.clear()}getStore(){return this._store}estimateMemoryUsage(){let t=0;for(const[e,s]of this.entries())t+=2*JSON.stringify({key:e,value:s}).length;return t}}class Z{constructor({storageManager:t,indexManager:e,versionManager:s=null,config:i}){this.storageManager=t,this.indexManager=e,this.versionManager=s,this.config=i}set(t,r={},a={}){try{const{override:s=!1,validate:i=!0}=a;null===t&&(t=r[this.config.key]??e.randomUUID());const n={...r,[this.config.key]:t};i&&this.config.schema&&this.config.schema.validate(n);const o=this.storageManager.has(t)?this.storageManager.get(t):null;let c=n;o&&!s&&(c=this._mergeRecords(o,n)),this.versionManager&&o&&this.versionManager.addVersion(t,o),o&&this.indexManager.removeRecord(t,o),this.indexManager.addRecord(t,c),this.storageManager.set(t,c);return T.create(t,c)}catch(t){if(t instanceof s)throw t;throw new i(`Failed to set record: ${t.message}`,"record",r)}}get(t,e={}){const{includeVersions:s=!1}=e,i=this.storageManager.get(t);if(!i)return null;const r=T.create(t,i);if(s&&this.versionManager){const e=this.versionManager.getHistory(t);if(e){const s={versions:e.versions};return T.create(t,i,s)}}return r}delete(t){if(!this.storageManager.has(t))throw new r(t,this.config.id);const e=this.storageManager.get(t);return this.indexManager.removeRecord(t,e),this.storageManager.delete(t),this.versionManager&&this.versionManager.disableVersioning(t),!0}has(t){return this.storageManager.has(t)}_mergeRecords(t,e){if(Array.isArray(t)&&Array.isArray(e))return[...t,...e];if("object"==typeof t&&"object"==typeof e){const s={...t};for(const[i,r]of Object.entries(e))"object"!=typeof r||null===r||Array.isArray(r)||"object"!=typeof t[i]||null===t[i]||Array.isArray(t[i])?s[i]=r:s[i]=this._mergeRecords(t[i],r);return s}return e}}class tt{constructor({storageManager:t,indexManager:e,queryOptimizer:s=null}){this.storageManager=t,this.indexManager=e,this.queryOptimizer=s}find(t={},e={}){const{limit:s,offset:i=0}=e;try{let e=null;if(this.queryOptimizer){const r={find:t,limit:s,offset:i},a={indexManager:this.indexManager};e=this.queryOptimizer.createPlan(r,a),e.startExecution()}const r=Object.keys(t);let a;a=this.indexManager.getOptimalIndex(r)?this.indexManager.findByCriteria(t):new Set(this.storageManager.keys());const n=[];for(const e of a){const s=this.storageManager.get(e);this._matchesCriteria(s,t)&&n.push(T.create(e,s))}const o=i,c=s?o+s:n.length,h=n.slice(o,c);return e&&(e.completeExecution(h.length),this.queryOptimizer.recordExecution(e)),new k(h)}catch(e){throw new o(`Find operation failed: ${e.message}`,t,"find")}}where(t,e={}){try{if("function"==typeof t)return this._filterByFunction(t,e);if("object"==typeof t&&null!==t)return this._filterByObject(t,e);throw new o("Predicate must be a function or object",t,"where")}catch(e){throw new o(`Where operation failed: ${e.message}`,t,"where")}}_matchesCriteria(t,e){for(const[s,i]of Object.entries(e)){const e=t[s];if(i instanceof RegExp){if(!i.test(e))return!1}else if(Array.isArray(i)){if(Array.isArray(e)){if(!i.some(t=>e.includes(t)))return!1}else if(!i.includes(e))return!1}else if(e!==i)return!1}return!0}_filterByFunction(t,e){const{limit:s,offset:i=0}=e,r=[];let a=0;for(const[e,n]of this.storageManager.entries()){const o=T.create(e,n);if(t(o)){if(a>=i&&(r.push(o),s&&r.length>=s))break;a++}}return new k(r)}_filterByObject(t,e){return this.find(t,e)}}class et{constructor({crudManager:t,transactionManager:e=null,lifecycleManager:s}){this.crudManager=t,this.transactionManager=e,this.lifecycleManager=s}batch(t,e="set",s={}){const{transaction:i=null,atomic:r=!1}=s;try{if(r||i)return this._executeBatchInTransaction(t,e,i);const s=[];for(const i of t)try{let t;"set"===e?t=this.crudManager.set(null,i,{batch:!0}):"del"===e&&(this.crudManager.delete(i,{batch:!0}),t=!0),s.push(t)}catch(t){s.push(t)}return this.lifecycleManager.onbatch(s,e),s}catch(e){throw new o(`Batch operation failed: ${e.message}`,t,"batch")}}async _executeBatchInTransaction(t,e,s){if(!this.transactionManager)throw new c("Transaction manager not available for atomic batch operations");const i=!s;i&&(s=this.transactionManager.begin());try{const r=[];for(const i of t)if("set"===e){const t=this._executeSetInTransaction(null,i,s);r.push(t)}else"del"===e&&(this._executeDeleteInTransaction(i,s),r.push(!0));return i&&await this.transactionManager.commit(s.id),r}catch(t){throw i&&this.transactionManager.abort(s.id,t.message),t}}_executeSetInTransaction(t,e,s){const i=t?this.crudManager.storageManager.get(t):null;return s.addOperation("set",t,i,e),this.crudManager.set(t,e,{batch:!0})}_executeDeleteInTransaction(t,e){const s=this.crudManager.storageManager.get(t);e.addOperation("delete",t,s),this.crudManager.delete(t,{batch:!0})}}class st{constructor({storageManager:t}){this.storageManager=t}stream(t={}){const e=this.storageManager.entries();let s=0;return new J({next:()=>s<e.length?{value:e[s++],done:!1}:{done:!0}},t)}streamWhere(t,e={}){const s=this._createFilteredIterator(t);return new J(s,e)}streamMap(t,e={}){const s=this._createTransformIterator(t);return new J(s,e)}streamTake(t,e={}){const s=this._createLimitedIterator(t);return new J(s,e)}_createFilteredIterator(t){const e=this.storageManager.entries();let s=0;return{next:()=>{for(;s<e.length;){const[i,r]=e[s++];if("function"==typeof t){if(t({key:i,...r}))return{value:[i,r],done:!1}}else if("object"==typeof t&&this._matchesCriteria(r,t))return{value:[i,r],done:!1}}return{done:!0}}}}_createTransformIterator(t){const e=this.storageManager.entries();let s=0;return{next:()=>{if(s<e.length){const[i,r]=e[s++];return{value:[i,t({key:i,...r})],done:!1}}return{done:!0}}}}_createLimitedIterator(t){const e=this.storageManager.entries();let s=0;return{next:()=>{if(s<t&&s<e.length){return{value:e[s++],done:!1}}return{done:!0}}}}_matchesCriteria(t,e){for(const[s,i]of Object.entries(e)){const e=t[s];if(i instanceof RegExp){if(!i.test(e))return!1}else if(Array.isArray(i)){if(Array.isArray(e)){if(!i.some(t=>e.includes(t)))return!1}else if(!i.includes(e))return!1}else if(e!==i)return!1}return!0}}class it{constructor({storageManager:t,indexManager:e,versionManager:s=null,transactionManager:i=null,queryOptimizer:r=null,config:a}){this.storageManager=t,this.indexManager=e,this.versionManager=s,this.transactionManager=i,this.queryOptimizer=r,this.config=a}getStats(){const t={records:this.storageManager.size,configuration:this.config,indexes:this.indexManager.getStats(),memory:this._estimateMemoryUsage()};return this.versionManager&&(t.versions=this.versionManager.getStats()),this.transactionManager&&(t.transactions=this.transactionManager.getStats()),this.queryOptimizer&&(t.queries=this.queryOptimizer.getStats()),t}getStorageStats(){return{size:this.storageManager.size,memoryUsage:this.storageManager.estimateMemoryUsage(),type:this.config.immutable?"immutable":"mutable"}}getIndexStats(){return this.indexManager.getStats()}getVersionStats(){return this.versionManager?this.versionManager.getStats():null}getTransactionStats(){return this.transactionManager?this.transactionManager.getStats():null}getQueryStats(){return this.queryOptimizer?this.queryOptimizer.getStats():null}getPerformanceMetrics(){const t=this.getStats();return{recordsPerIndex:t.records/Math.max(1,Object.keys(t.indexes).length),memoryPerRecord:t.memory.total/Math.max(1,t.records),indexEfficiency:this._calculateIndexEfficiency(t),overheadRatio:t.memory.overhead/Math.max(1,t.memory.data)}}_estimateMemoryUsage(){const t=this.storageManager.estimateMemoryUsage(),e=this.indexManager.getStats().totalMemoryUsage||0,s=this.versionManager?this.versionManager.getStats().totalSize:0;return{total:t+e+s,data:t,indexes:e,versions:s,overhead:e+s}}_calculateIndexEfficiency(t){if(!t.indexes||!t.queries)return 0;const e=t.queries.totalExecutions||1;return(t.queries.indexedExecutions||0)/e*100}generateReport(){const t=this.getStats(),e=this.getPerformanceMetrics();return{summary:{totalRecords:t.records,totalMemory:t.memory.total,activeIndexes:Object.keys(t.indexes).length,versioning:!!this.versionManager,transactions:!!this.transactionManager,optimization:!!this.queryOptimizer},performance:e,breakdown:{storage:this.getStorageStats(),indexes:this.getIndexStats(),versions:this.getVersionStats(),transactions:this.getTransactionStats(),queries:this.getQueryStats()},recommendations:this._generateRecommendations(t,e)}}_generateRecommendations(t,e){const s=[];return e.indexEfficiency<50&&s.push("Consider adding more indexes for frequently queried fields"),e.overheadRatio>2&&s.push("High memory overhead detected - consider optimizing indexes or version retention"),t.records>1e4&&!this.queryOptimizer&&s.push("Enable query optimization for better performance with large datasets"),t.memory.versions>t.memory.data&&s.push("Version storage is larger than data - consider adjusting retention policy"),s}}class rt{constructor(t={}){this.hooks={beforeSet:()=>{},onset:()=>{},beforeDelete:()=>{},ondelete:()=>{},beforeClear:()=>{},onclear:()=>{},onbatch:()=>{},...t}}registerHook(t,e){if("function"!=typeof e)throw new i(`Hook handler for '${t}' must be a function`,"handler",e);this.hooks[t]=e}unregisterHook(t){this.hooks[t]=()=>{}}executeHook(t,...e){if(this.hooks[t])return this.hooks[t](...e)}beforeSet(t,e,s){return this.executeHook("beforeSet",t,e,s)}onset(t,e){return this.executeHook("onset",t,e)}beforeDelete(t,e){return this.executeHook("beforeDelete",t,e)}ondelete(t){return this.executeHook("ondelete",t)}beforeClear(){return this.executeHook("beforeClear")}onclear(){return this.executeHook("onclear")}onbatch(t,e){return this.executeHook("onbatch",t,e)}getHooks(){return{...this.hooks}}hasHook(t){return t in this.hooks&&"function"==typeof this.hooks[t]}clearHooks(){for(const t in this.hooks)this.hooks[t]=()=>{}}}class at{constructor(t=null,s={}){const i={delimiter:"|",id:e.randomUUID(),immutable:!1,index:[],key:"id",versioning:!1,schema:null,retentionPolicy:{type:z.NONE},enableTransactions:!1,enableOptimization:!0};let r;Array.isArray(t)||null===t?(r=m.validate(s),this.initialData=t):(r=m.validate(t),this.initialData=null),this.config={...i,...r},this.storageManager=new X({immutable:this.config.immutable}),this.indexManager=new I(this.config.delimiter),this.versionManager=this.config.versioning?new N(this.config.retentionPolicy):null,this.transactionManager=this.config.enableTransactions?new V:null,this.queryOptimizer=this.config.enableOptimization?new Y:null,this.lifecycleManager=new rt,this.crudManager=new Z({storageManager:this.storageManager,indexManager:this.indexManager,versionManager:this.versionManager,config:this.config}),this.queryManager=new tt({storageManager:this.storageManager,indexManager:this.indexManager,queryOptimizer:this.queryOptimizer}),this.batchManager=new et({crudManager:this.crudManager,transactionManager:this.transactionManager,lifecycleManager:this.lifecycleManager}),this.streamManager=new st({storageManager:this.storageManager}),this.statisticsManager=new it({storageManager:this.storageManager,indexManager:this.indexManager,versionManager:this.versionManager,transactionManager:this.transactionManager,queryOptimizer:this.queryOptimizer,config:this.config});for(const t of this.config.index)this.indexManager.createIndex(t,t);Object.defineProperty(this,"data",{get:()=>this.storageManager.getStore(),enumerable:!0}),Object.defineProperty(this,"size",{get:()=>this.storageManager.size,enumerable:!0}),Object.defineProperty(this,"registry",{get:()=>this.storageManager.keys(),enumerable:!0}),this.initialData&&Array.isArray(this.initialData)&&this.batch(this.initialData)}set(t,e={},s={}){const{batch:i=!1,transaction:r=null}=s;if(r)return this._executeInTransaction(r,"set",t,e,s);this.lifecycleManager.beforeSet(t,e,s);const a=this.crudManager.set(t,e,s);return i||this.lifecycleManager.onset(a,s),a}get(t,e={}){const{transaction:s=null}=e;return s?this._executeInTransaction(s,"get",t,e):this.crudManager.get(t,e)}delete(t,e={}){const{batch:s=!1,transaction:i=null}=e;if(i)return this._executeInTransaction(i,"delete",t,e);this.lifecycleManager.beforeDelete(t,s);const r=this.crudManager.delete(t,e);return s||this.lifecycleManager.ondelete(t),r}has(t){return this.crudManager.has(t)}find(t={},e={}){const{transaction:s=null}=e;return s?this._executeInTransaction(s,"find",t,e):this.queryManager.find(t,e)}where(t,e={}){return this.queryManager.where(t,e)}batch(t,e="set",s={}){return this.batchManager.batch(t,e,s)}beginTransaction(t={}){if(!this.transactionManager)throw new n("Transactions not enabled","enableTransactions",!1);return this.transactionManager.begin(t)}async commitTransaction(t){if(!this.transactionManager)throw new n("Transactions not enabled","enableTransactions",!1);const e="string"==typeof t?t:t.id;return await this.transactionManager.commit(e)}abortTransaction(t,e){if(!this.transactionManager)throw new n("Transactions not enabled","enableTransactions",!1);const s="string"==typeof t?t:t.id;return this.transactionManager.abort(s,e)}stream(t={}){return this.streamManager.stream(t)}getStats(){return this.statisticsManager.getStats()}clear(t={}){const{preserveIndexes:e=!1,preserveVersions:s=!1}=t;this.lifecycleManager.beforeClear(),this.storageManager.clear(),e||this.indexManager.clear(),!s&&this.versionManager&&this.versionManager.clear(),this.queryOptimizer&&this.queryOptimizer.clear(),this.lifecycleManager.onclear()}beforeSet(t,e,s){return this.lifecycleManager.beforeSet(t,e,s)}onset(t,e){return this.lifecycleManager.onset(t,e)}beforeDelete(t,e){return this.lifecycleManager.beforeDelete(t,e)}ondelete(t){return this.lifecycleManager.ondelete(t)}beforeClear(){return this.lifecycleManager.beforeClear()}onclear(){return this.lifecycleManager.onclear()}onbatch(t,e){return this.lifecycleManager.onbatch(t,e)}_executeInTransaction(t,e,...s){switch(e){case"set":{const[i,r,a={}]=s,n=this.storageManager.get(i);return t.addOperation(e,i,n,r),this.set(i,r,{...a,transaction:null})}case"get":{const[e,i={}]=s;return t.addOperation("read",e),this.get(e,{...i,transaction:null})}case"delete":{const[i,r={}]=s,a=this.storageManager.get(i);return t.addOperation(e,i,a),this.delete(i,{...r,transaction:null})}case"find":{const[e,i={}]=s;return t.addOperation("read","find_operation",null,e),this.find(e,{...i,transaction:null})}default:throw new c(`Unknown operation: ${e}`,t.id,e)}}}t.Constraints=p,t.DataStream=J,t.DataTypes=d,t.ErrorRecovery=class{static isRecoverable(t){if(!(t instanceof s))return!1;return["RECORD_NOT_FOUND","VALIDATION_ERROR","QUERY_ERROR","TYPE_CONSTRAINT_ERROR"].includes(t.code)}static getRecoveryActions(t){if(!(t instanceof s))return["Check error details and retry"];switch(t.code){case"RECORD_NOT_FOUND":return["Verify the record key is correct","Check if record was deleted","Use has() method to check existence before get()"];case"VALIDATION_ERROR":return["Check data types match expected schema","Verify required fields are present","Validate field constraints"];case"INDEX_ERROR":return["Verify index exists before querying","Check index configuration","Try reindexing the affected field"];case"CONFIGURATION_ERROR":return["Review configuration parameters","Check for typos in configuration keys","Refer to documentation for valid options"];case"QUERY_ERROR":return["Verify query syntax is correct","Check if indexed fields are being used","Simplify complex queries"];case"TRANSACTION_ERROR":return["Retry the transaction","Check for concurrent modifications","Reduce transaction scope"];case"TYPE_CONSTRAINT_ERROR":return["Check data types match schema","Convert data to expected type","Update type constraints if needed"];default:return["Check error details and retry"]}}static createRecoveryStrategy(t){return{error:t,isRecoverable:this.isRecoverable(t),actions:this.getRecoveryActions(t),retryable:["CONCURRENCY_ERROR","TRANSACTION_ERROR"].includes(t.code),backoffMs:"CONCURRENCY_ERROR"===t.code?100:0}}},t.FieldConstraint=f,t.Haro=at,t.ImmutableStore=Q,t.IndexTypes=b,t.IsolationLevels=C,t.QueryTypes={FIND:"find",FILTER:"filter",SEARCH:"search",WHERE:"where",SORT:"sort",LIMIT:"limit",AGGREGATE:"aggregate"},t.Record=M,t.RecordCollection=k,t.RecordFactory=T,t.RetentionPolicies=z,t.Schema=g,t.default=at,t.haro=function(t=null,e={}){return new at(t,e)},Object.defineProperty(t,"__esModule",{value:!0})});//# sourceMappingURL=haro.umd.min.js.map
